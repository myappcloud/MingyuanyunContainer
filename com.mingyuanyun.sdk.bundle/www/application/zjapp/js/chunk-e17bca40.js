(window.webpackJsonp_module_entry_zjapp_=window.webpackJsonp_module_entry_zjapp_||[]).push([["chunk-e17bca40"],{"56bf":function(t,e,i){"use strict";i("ea6b")},"8cb7":function(t,e,i){(t.exports=i("690e")(!1)).push([t.i,'.zjapp .item-img-list{display:flex;flex-direction:row;flex-wrap:wrap;align-content:flex-start;align-items:flex-start;margin-top:-15px;margin-left:-15px}.zjapp .item-img-list li{position:relative;width:70px;height:70px;margin-left:15px;margin-top:15px;background:no-repeat 50%;background-size:cover;background-color:#eee;transform:translateZ(0)}.zjapp .item-img-list-popup{padding:0}.zjapp .item-img-list-popup .item-img-list{margin-top:0;text-align:center;font-size:0;white-space:nowrap}.zjapp .item-img-list-popup .item-img-list li{float:none;display:inline-block;vertical-align:top;background-color:transparent;border-color:#fff;color:#fff}.zjapp .item-img-list .icon-minus{position:absolute;top:-10px;right:-10px;width:20px;height:20px;line-height:20px;border-radius:10px;background-color:#ff4546;color:#fff;font-size:14px;text-align:center}.zjapp .item-img-list .icon-minus:before{content:"";position:absolute;left:5px;top:9px;width:10px;height:2px;background-color:#fff}.zjapp .item-img-list .no-img{color:#4275e8;background:#fff;line-height:70px;text-align:center;font-size:45px;border:1px dotted #4275e8}.zjapp .item-img-list .add-img{color:#b6b6b6;background:#fff;line-height:70px;text-align:center;font-size:40px;border:1px dotted #c6c6c6}.zjapp .item-img-list .list-icon{height:40px;line-height:30px;padding-top:10px;overflow:hidden;font-size:40px}.zjapp .item-img-list .list-icon i{font-size:28px;display:block}.zjapp .item-img-list .list-icon i:before{vertical-align:top}.zjapp .item-img-list .list-icon .icon-shoot-video{font-size:24px;margin-top:1px}.zjapp .item-img-list .list-text{line-height:20px;font-size:14px}.zjapp .item-img-list .van-icon-play{position:absolute;top:15px;left:20px;padding-left:2px;width:30px;height:30px;line-height:28px;text-align:center;font-size:22px;color:hsla(0,0%,100%,.8);border:1px solid hsla(0,0%,100%,.8);border-radius:15px}.zjapp .item-img-list .size{position:absolute;bottom:0;right:5px;line-height:18px;color:#fff;font-size:10px;font-style:normal}',""])},d209:function(t,e,i){"use strict";(function(t){i("5ab2"),i("e10e"),i("6a61");var a=i("2e91"),n=(i("6d57"),i("06a2"),i("28f8")),o=(i("e204"),i("163d"),i("a32d")),l=i.n(o),r=i("48f4"),s=i("4ad6"),u=i("a500"),c=i("3122"),d=i("162a"),p=i("e2a7"),m=i("3bd5"),h=i("ed08"),g=i("4360"),f=i("7cb8"),b=i("6cb4"),v=i("cc90"),w=(i("8d95"),i("d873"));function x(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,a)}return i}function I(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?x(Object(i),!0).forEach((function(e){Object(n.a)(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):x(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}e.a={name:"ItemImgList",store:g.a,props:{value:{type:Array,default:function(){return[]}},maxlength:{type:Number,default:3},editabled:{type:Boolean,default:!0},allowSelectAlbum:{type:Boolean,default:void 0},allowBuildinAlbum:{type:Boolean,default:void 0},allowMultiSelect:{type:Boolean,default:!0},editedBy:{type:String,default:""},prepareCallback:{type:Function,default:function(){}},cancelCallback:{type:Function,default:function(){}},onlineMode:{type:Boolean},trackText:{type:String,default:""},userLink:{type:Boolean,default:!1},allowVideo:{type:Boolean,default:!0},beforeEdit:{type:Function,default:function(){}},folder:{type:String,default:"images"},group:{type:String},modelId:{type:String},modelTable:{type:String},modelField:{type:String},pointImageMode:{type:Boolean,default:!1},pointImageEdit:{type:Function,default:function(){}}},data:function(){return{moduleCode:r.default.getCurrentModuleCode(),currentUserId:m.a.getUser().user_id,thumbnailSet:{},statusSet:{},throttleAddImage:t.throttle(this.addImage,2e3,{trailing:!1}),throttleAddVideo:t.throttle(this.addVideo,2e3,{trailing:!1}),throttleSelectImage:t.throttle(this.selectImage,2e3,{trailing:!1}),throttleAppImage:t.throttle(this.selectAppImage,2e3,{trailing:!1}),viewImages:[],pluginAllowVideo:s.a.allowShootVideo()}},computed:{allowAlbum:function(){return t.isBoolean(this.allowSelectAlbum)?this.allowSelectAlbum:this.$store.state.global.allowSelectPictureFromAlbums[this.moduleCode]},allowBuildin:function(){return t.isBoolean(this.allowBuildinAlbum)?this.allowBuildinAlbum:this.$store.state.global.allowSelectPictureFromBuildinAlbums[this.moduleCode]},hasVideoItem:function(){return this.allowVideo&&this.pluginAllowVideo}},watch:{value:function(e){var i=this;this.$nextTick((function(){t.isEmpty(e)||i.init()}))}},created:function(){var e=this;this.init(),this.$on("changeViewValue",(function(i){var a=t.clone(e.value),n=t.findIndex(a,{id:i.id}),o=e.modelId,l=e.modelTable,s=e.modelField;a[n]=i,e.$emit("input",a),o&&l&&s||console.error("更换图片失败，数据库参数不全",{modelId:o,modelTable:l,modelField:s});var u={};u[s]=Object(f.o)(a),localDB.update(l,u,{id:o}).then((function(){r.default.addSyncGroup([[l,o,"id"]])}))}))},methods:{init:function(){var e=this;t.each(this.value,(function(t){if(!t.id){var i=t.url||t.temp||"";i=l.a.replaceAll(i,"\\?x-oss-process=image\\/resize,","@");var a=l.a.strRightBack(i,"/"),n=l.a.strLeftBack(a,".")||+new Date;e.$set(t,"id",n)}t.temp&&e.$set(t,"temp",s.a.fixImagePath(t.temp)),t.videoTemp&&e.$set(t,"videoTemp",s.a.fixImagePath(t.videoTemp)),t.local&&e.$set(t,"local",s.a.fixImagePath(t.local))}))},getThumbnail:function(t){return this.onlineMode?"dev"===APP_ENV?this.thumbnailSet[t.id]?this.thumbnailSet[t.id]:t.url:t.temp?c.a.fixUrl(t.temp):t.url:"loading"===this.statusSet[t.id]?c.a.IMAGE_LOADING:"failed"===this.statusSet[t.id]?c.a.IMAGE_RELOAD:"dev"===APP_ENV?c.a.getImageThumbnail(t):t.temp?c.a.fixUrl(t.temp):t.url?this.thumbnailSet[t.id]?this.thumbnailSet[t.id]:(this.loadThumbnail(t),""):c.a.IMAGE_PLACEHOLD},loadThumbnail:function(t){var e=this,i=c.a.getImageThumbnail(t);this.$set(this.statusSet,t.id,"loading"),c.a.isNeedDownload(i,"thumbnail").then((function(a){a?c.a.download(i,"","thumbnail").then((function(i){e.$set(e.thumbnailSet,t.id,i),e.statusSet[t.id]="successed"})).catch((function(i){console.error(i),e.statusSet[t.id]="failed"})):(e.$set(e.thumbnailSet,t.id,c.a.getPathFromUrl(i,"thumbnail")),e.statusSet[t.id]="successed")}))},getSizeText:function(t){return t&&t.size?h.a.formatFilesize(t.size):""},getAllItems:function(){var e=this;if(this.group){var i=[],a=document.querySelectorAll(".item-img-list-"+this.group),n=t.map(a,(function(t){return t.__vue__}));return t.each(n,(function(e){t.each(e.value,(function(t){var a=I(I({},t),{},{component:e});i.push(a)}))})),i}return t.map(this.value,(function(t){return I(I({},t),{},{component:e})}))},imgView:function(e){var i=this,a=this.getAllItems(),n=t.findIndex(a,{id:e.id}),o=t.some(a,(function(t){return"loading"===i.statusSet[t.id]}));if(o)p.a.alert("正在下载图片，请稍等");else{var l={};if(this.editabled||this.editedBy!==this.currentUserId||"process-accept"===this.moduleCode||(l.toolBar={isShow:!0,isShowChange:!0},this.allowAlbum||(l.toolBar.changeOption=[1])),this.onlineMode)return this.viewImages=c.a.convertMediaList(a,!0),void s.a.openImageBrowser(this.viewImages,n,l).then(null,null,this.changeViewImage);if("dev"===APP_ENV)return this.viewImages=c.a.convertMediaList(a,!0),void s.a.openImageBrowser(this.viewImages,n,l).then(null,null,this.changeViewImage);var r=[];t.each(a,(function(t){var e;if("dev"===APP_ENV)e=Promise.resolve(t.url);else if(t.temp)e=Promise.resolve(t.temp);else{var a=c.a.getImageUrl(t);e=c.a.isNeedDownload(a,i.folder).then((function(e){return e?(i.$set(i.statusSet,t.id,"loading"),c.a.download(a,!1,i.folder).then((function(e){return i.$set(i.statusSet,t.id,"successed"),e}))):c.a.getPathFromUrl(a,i.folder)}))}r.push(e)})),Promise.all(r).then((function(e){var o=t.map(a,(function(t,i){return t&&(t.videoUrl||t.videoTemp)?{image:c.a.fixUrl(e[i]),video:c.a.fixUrl(t.videoUrl||t.videoTemp)}:c.a.fixUrl(e[i])}));i.viewImages=o,s.a.openImageBrowser(o,n,l).then(null,null,i.changeViewImage)}))}},changeViewImage:function(e){var i=this.getAllItems(),a=e.change,n=a.imagePath,o=a.exchangePath,r=a.changeMode,u=l.a.strRightBack(n,"/"),d=i[t.findIndex(this.viewImages,(function(e){var i;if(t.isObject(e)){var a=e.image;i=l.a.strRightBack(a,"/")}else i=t.isString(e)?l.a.strRightBack(e,"/"):"";return i===u}))];if(d){var p={id:d.id,temp:o},m=d.component;return s.a.getWaterMark(1===r?[w.e,w.d,w.c]:[w.e],1===r).then((function(t){return s.a.addWaterMark(p.temp,t).then((function(t){if(p.temp=t,1===r&&v.a.handelPicture(t),"dev"===APP_ENV)return c.a.uploadImage(t).then((function(t){p.url=t}))}))})).then((function(){m.$emit("changeViewValue",p)})).catch((function(t){console.error(t)}))}console.error("更换图片错误",e,i)},addImage:function(){var t=this;return Promise.resolve().then((function(){return t.beforeEdit()})).then((function(){return t.prepareCallback()})).then((function(){return c.a.takePicture()})).then((function(e){if(!e)return!1;console.log("获取图片数据",e),!g.a.state.global.hasTopProgress&&window&&window.StatusBar&&window.StatusBar.show();var i=t.value.concat(e);return e.user_id=t.currentUserId,v.a.handelPicture(e.temp).then((function(){"dev"===APP_ENV&&(t.$set(t.statusSet,e.id,"loading"),c.a.uploadImage(e.temp).then((function(t){e.url=t})).then((function(){t.$set(t.thumbnailSet,e.id,c.a.getImageThumbnail(e)),t.$set(t.statusSet,e.id,"successed"),t.$emit("input",i),t.$emit("callback",i)})))})).then((function(){t.$emit("input",i),t.$emit("callback",i)})),!0})).catch((function(e){return $log.error(e),p.a.alert(e||"发生了错误"),t.cancelCallback(),!g.a.state.global.hasTopProgress&&window&&window.StatusBar&&window.StatusBar.show(),!1}))},addVideo:function(){var e=this;return Promise.resolve().then((function(){return e.beforeEdit()})).then((function(){return e.prepareCallback()})).then((function(){return c.a.shootVideo()})).then((function(i){if(!g.a.state.global.hasTopProgress&&window&&window.StatusBar&&window.StatusBar.show(),t.isEmpty(i))return!1;i.user_id=e.currentUserId;var a=e.value.concat(i);return e.$emit("input",a),e.$emit("callback",a),"dev"===APP_ENV&&(e.$set(e.statusSet,i.id,"loading"),c.a.uploadImage(i.temp).then((function(t){i.url=t})).then((function(){return d.a.uploadFile(i.videoTemp).then((function(t){i.videoUrl=t}))})).then((function(){e.$set(e.thumbnailSet,i.id,c.a.getImageThumbnail(i)),e.$set(e.statusSet,i.id,"successed"),e.$emit("input",a),e.$emit("callback",a)}))),!0})).catch((function(t){return $log.error(t),p.a.alert(t||"发生了错误"),e.cancelCallback(),!g.a.state.global.hasTopProgress&&window&&window.StatusBar&&window.StatusBar.show(),!1}))},selectImage:function(){var e,i=this;if(this.allowMultiSelect){var a=Math.max(this.maxlength-this.value.length,0);e={maxSelectCount:a}}return Promise.resolve().then((function(){return i.beforeEdit()})).then((function(){return i.prepareCallback()})).then((function(){return c.a.selectPicture(e)})).then((function(e){if(!g.a.state.global.hasTopProgress&&window&&window.StatusBar&&window.StatusBar.show(),t.isEmpty(e))return!1;t.each(e,(function(t){t.user_id=i.currentUserId}));var a=i.value.concat(e);if(i.$emit("input",a),i.$emit("callback",a),"dev"===APP_ENV){var n=Promise.resolve();t.each(e,(function(t){i.$set(i.statusSet,t.id,"loading"),n=n.then((function(){return c.a.uploadImage(t.temp).then((function(e){delete t.temp,t.url=e,i.$set(i.thumbnailSet,t.id,c.a.getImageThumbnail(t)),i.$set(i.statusSet,t.id,"successed")}))}))})),n.then((function(){i.$emit("input",a),i.$emit("callback",a)}))}return!0})).catch((function(t){return $log.error(t),p.a.alert(t||"发生了错误"),i.cancelCallback(),!g.a.state.global.hasTopProgress&&window&&window.StatusBar&&window.StatusBar.show(),!1}))},addAppImage:function(e){var i=this;if(t.isEmpty(e))return Promise.reject("没有选择图片");var a=this.value.concat(e);return this.trackText&&u.a.addTrack(this.trackText+"-从APP相册选择照片","",""),Promise.all(t.map(e,(function(t){var e=h.a.uuid(),a=s.a.appImagePath()+"images/"+e+".jpg";return s.a.copyFile(t.temp,a).then((function(){t.id=e,t.temp=a,t.user_id=i.currentUserId})).then((function(){"dev"===APP_ENV&&(i.$set(i.statusSet,t.id,"loading"),c.a.uploadImage(t.temp).then((function(e){t.url=e,i.$set(i.thumbnailSet,t.id,c.a.getImageThumbnail(t)),i.$set(i.statusSet,t.id,"successed")})))}))}))).then((function(){i.$emit("input",a),i.$emit("callback",a)}))},selectAppImage:function(){var t=this;return new Promise(function(){var e=Object(a.a)(regeneratorRuntime.mark((function e(i,n){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.beforeEdit();case 3:v.a.maxImageLength=Math.max(t.maxlength-t.value.length,0),b.a.openPopup({bool:!0,callback:function(){var e=Object(a.a)(regeneratorRuntime.mark((function e(a){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.addAppImage(a).catch((function(t){p.a.alert(t),i(!1)}));case 2:i(!0);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()}),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(0),p.a.alert(e.t0),i(!1);case 11:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,i){return e.apply(this,arguments)}}())},removeImage:function(e){var i=this,a=e.videoTemp?"确定要删除视频吗？":"确定要删除图片吗？";Promise.resolve().then((function(){return i.beforeEdit()})).then((function(){p.a.confirm(a).then((function(a){if(a){var n=i.value,o=t.indexOf(n,e);o>-1&&n.splice(o,1),i.$emit("remove",{index:o}),i.$emit("input",n),i.$emit("callback",n)}}))})).catch((function(t){p.a.alert(t)}))}}}}).call(this,i("391c"))},e68e:function(t,e,i){"use strict";var a=i("d209").a,n=(i("56bf"),i("17cc")),o=Object(n.a)(a,(function(){var t,e=this,i=e.$createElement,a=e._self._c||i;return e.editabled||e.value.length?a("ul",{staticClass:"item-img-list",class:(t={},t["item-img-list-"+e.group]=e.group,t)},[e.value.length?e._l(e.value,(function(t,i){return a("li",{key:i,style:{"background-image":"url("+e.getThumbnail(t)+")"},on:{click:function(a){e.imgView(t,i)}}},[!1===e.editabled||e.userLink&&(!e.userLink||t.user_id!==e.currentUserId)||e.pointImageMode?e._e():a("i",{staticClass:"icon-minus",on:{click:function(i){i.stopPropagation(),e.removeImage(t)}}}),t.videoUrl?a("van-icon",{attrs:{name:"play"}}):e._e(),t.size?a("i",{staticClass:"size"},[e._v(e._s(e.getSizeText(t)))]):e._e()],1)})):e._e(),e.pointImageMode?[e.value.length<e.maxlength&&!1!==e.editabled?a("li",{staticClass:"no-img",on:{click:e.pointImageEdit}},[a("p",{staticClass:"list-icon"},[a("icon",{attrs:{name:"dianweizhao"}})],1),a("p",{staticClass:"list-text"},[e._v("点位照")])]):e._e()]:[e.value.length<e.maxlength&&!1!==e.editabled?a("li",{staticClass:"no-img",on:{click:e.throttleAddImage}},[a("p",{staticClass:"list-icon"},[a("icon",{attrs:{name:"paizhao"}})],1),a("p",{staticClass:"list-text"},[e._v("拍照")])]):e._e(),e.value.length<e.maxlength&&!1!==e.editabled&&e.hasVideoItem?a("li",{staticClass:"no-img",on:{click:e.throttleAddVideo}},[a("p",{staticClass:"list-icon"},[a("icon",{attrs:{name:"shoot-video"}})],1),a("p",{staticClass:"list-text"},[e._v("拍视频")])]):e._e(),e.value.length<e.maxlength&&!1!==e.editabled&&e.allowAlbum?a("li",{staticClass:"no-img",on:{click:e.throttleSelectImage}},[a("p",{staticClass:"list-icon"},[a("icon",{attrs:{name:"xiangce"}})],1),a("p",{staticClass:"list-text"},[e._v("手机相册")])]):e._e(),e.value.length<e.maxlength&&!1!==e.editabled&&e.allowBuildin?a("li",{staticClass:"no-img",on:{click:e.throttleAppImage}},[a("p",{staticClass:"list-icon"},[a("icon",{attrs:{name:"xiangce"}})],1),a("p",{staticClass:"list-text"},[e._v("APP相册")])]):e._e()]],2):e._e()}),[],!1,null,null,null);e.a=o.exports},ea6b:function(t,e,i){var a=i("8cb7");"string"==typeof a&&(a=[[t.i,a,""]]),a.locals&&(t.exports=a.locals);(0,i("85cb").default)("2c75d179",a,!0,{sourceMap:!1,shadowMode:!1})}}]);