(window.webpackJsonp_module_entry_zjapp_=window.webpackJsonp_module_entry_zjapp_||[]).push([["chunk-e17bca40"],{"56bf":function(e,t,i){"use strict";i("ea6b")},"8cb7":function(e,t,i){(e.exports=i("690e")(!1)).push([e.i,'.zjapp .item-img-list{display:flex;flex-direction:row;flex-wrap:wrap;align-content:flex-start;align-items:flex-start;margin-top:-15px;margin-left:-15px}.zjapp .item-img-list li{position:relative;width:70px;height:70px;margin-left:15px;margin-top:15px;background:no-repeat 50%;background-size:cover;background-color:#eee;transform:translateZ(0)}.zjapp .item-img-list-popup{padding:0}.zjapp .item-img-list-popup .item-img-list{margin-top:0;text-align:center;font-size:0;white-space:nowrap}.zjapp .item-img-list-popup .item-img-list li{float:none;display:inline-block;vertical-align:top;background-color:transparent;border-color:#fff;color:#fff}.zjapp .item-img-list .icon-minus{position:absolute;top:-10px;right:-10px;width:20px;height:20px;line-height:20px;border-radius:10px;background-color:#ff4546;color:#fff;font-size:14px;text-align:center}.zjapp .item-img-list .icon-minus:before{content:"";position:absolute;left:5px;top:9px;width:10px;height:2px;background-color:#fff}.zjapp .item-img-list .no-img{color:#4275e8;background:#fff;line-height:70px;text-align:center;font-size:45px;border:1px dotted #4275e8}.zjapp .item-img-list .add-img{color:#b6b6b6;background:#fff;line-height:70px;text-align:center;font-size:40px;border:1px dotted #c6c6c6}.zjapp .item-img-list .list-icon{height:40px;line-height:30px;padding-top:10px;overflow:hidden;font-size:40px}.zjapp .item-img-list .list-icon i{font-size:28px;display:block}.zjapp .item-img-list .list-icon i:before{vertical-align:top}.zjapp .item-img-list .list-icon .icon-shoot-video{font-size:24px;margin-top:1px}.zjapp .item-img-list .list-text{line-height:20px;font-size:14px}.zjapp .item-img-list .van-icon-play{position:absolute;top:15px;left:20px;padding-left:2px;width:30px;height:30px;line-height:28px;text-align:center;font-size:22px;color:hsla(0,0%,100%,.8);border:1px solid hsla(0,0%,100%,.8);border-radius:15px}.zjapp .item-img-list .size{position:absolute;bottom:0;right:5px;line-height:18px;color:#fff;font-size:10px;font-style:normal}',""])},d209:function(e,t,i){"use strict";(function(e){i("5ab2"),i("e10e"),i("6a61");var a=i("2e91"),n=(i("6d57"),i("06a2"),i("28f8")),o=(i("e204"),i("163d"),i("a32d")),l=i.n(o),r=i("48f4"),s=i("4ad6"),c=i("a500"),u=i("3122"),d=i("162a"),p=i("e2a7"),m=i("3bd5"),h=i("ed08"),g=i("4360"),f=i("7cb8"),b=i("6cb4"),v=i("cc90"),w=(i("8d95"),i("0390"));function x(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,a)}return i}function I(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?x(Object(i),!0).forEach((function(t){Object(n.a)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):x(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}t.a={name:"ItemImgList",store:g.a,props:{value:{type:Array,default:function(){return[]}},maxlength:{type:Number,default:3},editabled:{type:Boolean,default:!0},allowSelectAlbum:{type:Boolean,default:void 0},allowBuildinAlbum:{type:Boolean,default:void 0},allowMultiSelect:{type:Boolean,default:!0},editedBy:{type:String,default:""},prepareCallback:{type:Function,default:function(){}},cancelCallback:{type:Function,default:function(){}},onlineMode:{type:Boolean},trackText:{type:String,default:""},userLink:{type:Boolean,default:!1},allowVideo:{type:Boolean,default:!0},beforeEdit:{type:Function,default:function(){}},folder:{type:String,default:"images"},group:{type:String},modelId:{type:String},modelTable:{type:String},modelField:{type:String},pointImageMode:{type:Boolean,default:!1},pointImageEdit:{type:Function,default:function(){}}},data:function(){return{moduleCode:r.default.getCurrentModuleCode(),currentUserId:m.a.getUser().user_id,thumbnailSet:{},statusSet:{},throttleAddImage:e.throttle(this.addImage,2e3,{trailing:!1}),throttleAddVideo:e.throttle(this.addVideo,2e3,{trailing:!1}),throttleSelectImage:e.throttle(this.selectImage,2e3,{trailing:!1}),throttleAppImage:e.throttle(this.selectAppImage,2e3,{trailing:!1}),viewImages:[],pluginAllowVideo:s.a.allowShootVideo()}},computed:{allowAlbum:function(){return e.isBoolean(this.allowSelectAlbum)?this.allowSelectAlbum:this.$store.state.global.allowSelectPictureFromAlbums[this.moduleCode]},allowBuildin:function(){return e.isBoolean(this.allowBuildinAlbum)?this.allowBuildinAlbum:this.$store.state.global.allowSelectPictureFromBuildinAlbums[this.moduleCode]},hasVideoItem:function(){return this.allowVideo&&this.pluginAllowVideo}},watch:{value:function(t){var i=this;this.$nextTick((function(){e.isEmpty(t)||i.init()}))}},created:function(){var t=this;this.init(),this.$on("changeViewValue",(function(i){var a=e.clone(t.value),n=e.findIndex(a,{id:i.id}),o=t.modelId,l=t.modelTable,s=t.modelField;a[n]=i,t.$emit("input",a),o&&l&&s||console.error("更换图片失败，数据库参数不全",{modelId:o,modelTable:l,modelField:s});var c={};c[s]=Object(f.o)(a),localDB.update(l,c,{id:o}).then((function(){r.default.addSyncGroup([[l,o,"id"]])}))}))},methods:{init:function(){var t=this;e.each(this.value,(function(e){if(!e.id){var i=e.url||e.temp||"";i=l.a.replaceAll(i,"\\?x-oss-process=image\\/resize,","@");var a=l.a.strRightBack(i,"/"),n=l.a.strLeftBack(a,".")||+new Date;t.$set(e,"id",n)}e.temp&&t.$set(e,"temp",s.a.fixImagePath(e.temp)),e.videoTemp&&t.$set(e,"videoTemp",s.a.fixImagePath(e.videoTemp)),e.local&&t.$set(e,"local",s.a.fixImagePath(e.local))}))},getThumbnail:function(e){return this.onlineMode?"dev"===APP_ENV?this.thumbnailSet[e.id]?this.thumbnailSet[e.id]:e.url:e.temp?u.a.fixUrl(e.temp):e.url:"loading"===this.statusSet[e.id]?u.a.IMAGE_LOADING:"failed"===this.statusSet[e.id]?u.a.IMAGE_RELOAD:"dev"===APP_ENV?u.a.getImageThumbnail(e):e.temp?u.a.fixUrl(e.temp):e.url?this.thumbnailSet[e.id]?this.thumbnailSet[e.id]:(this.loadThumbnail(e),""):u.a.IMAGE_PLACEHOLD},loadThumbnail:function(e){var t=this,i=u.a.getImageThumbnail(e);this.$set(this.statusSet,e.id,"loading"),u.a.isNeedDownload(i,"thumbnail").then((function(a){a?u.a.download(i,"","thumbnail").then((function(i){t.$set(t.thumbnailSet,e.id,i),t.statusSet[e.id]="successed"})).catch((function(i){console.error(i),t.statusSet[e.id]="failed"})):(t.$set(t.thumbnailSet,e.id,u.a.getPathFromUrl(i,"thumbnail")),t.statusSet[e.id]="successed")}))},getSizeText:function(e){return e&&e.size?h.a.formatFilesize(e.size):""},getAllItems:function(){var t=this;if(this.group){var i=[],a=document.querySelectorAll(".item-img-list-"+this.group),n=e.map(a,(function(e){return e.__vue__}));return e.each(n,(function(t){e.each(t.value,(function(e){var a=I(I({},e),{},{component:t});i.push(a)}))})),i}return e.map(this.value,(function(e){return I(I({},e),{},{component:t})}))},imgView:function(t){var i=this,a=this.getAllItems(),n=e.findIndex(a,{id:t.id}),o=e.some(a,(function(e){return"loading"===i.statusSet[e.id]}));if(o)p.a.alert("正在下载图片，请稍等");else{var l={};if(this.editabled||this.editedBy!==this.currentUserId||"process-accept"===this.moduleCode||(l.toolBar={isShow:!0,isShowChange:!0},this.allowAlbum||(l.toolBar.changeOption=[1])),this.onlineMode)return this.viewImages=u.a.convertMediaList(a,!0),void s.a.openImageBrowser(this.viewImages,n,l).then(null,null,this.changeViewImage);if("dev"===APP_ENV)return this.viewImages=u.a.convertMediaList(a,!0),void s.a.openImageBrowser(this.viewImages,n,l).then(null,null,this.changeViewImage);var r=[];e.each(a,(function(e){var t;if("dev"===APP_ENV)t=Promise.resolve(e.url);else if(e.temp)t=Promise.resolve(e.temp);else if(e.local)t=Promise.resolve(e.local);else{var a=u.a.getImageUrl(e);t=u.a.isNeedDownload(a,i.folder).then((function(t){return t?(i.$set(i.statusSet,e.id,"loading"),u.a.download(a,!1,i.folder).then((function(t){return i.$set(i.statusSet,e.id,"successed"),t}))):u.a.getPathFromUrl(a,i.folder)}))}r.push(t)})),Promise.all(r).then((function(t){var o=e.map(a,(function(e,i){return e&&(e.videoUrl||e.videoTemp)?{image:u.a.fixUrl(t[i]),video:u.a.fixUrl(e.videoUrl||e.videoTemp)}:u.a.fixUrl(t[i])}));i.viewImages=o,s.a.openImageBrowser(o,n,l).then(null,null,i.changeViewImage)}))}},changeViewImage:function(t){var i=this.getAllItems(),a=t.change,n=a.imagePath,o=a.exchangePath,r=a.changeMode,c=l.a.strRightBack(n,"/"),d=i[e.findIndex(this.viewImages,(function(t){var i;if(e.isObject(t)){var a=t.image;i=l.a.strRightBack(a,"/")}else i=e.isString(t)?l.a.strRightBack(t,"/"):"";return i===c}))];if(d){var p={id:d.id,temp:o},m=d.component;return s.a.getWaterMark(1===r?[w.c,w.b,w.a]:[w.c],1===r).then((function(e){return s.a.addWaterMark(p.temp,e).then((function(e){if(p.temp=e,1===r&&v.a.handelPicture(e),"dev"===APP_ENV)return u.a.uploadImage(e).then((function(e){p.url=e}))}))})).then((function(){m.$emit("changeViewValue",p)})).catch((function(e){console.error(e)}))}console.error("更换图片错误",t,i)},addImage:function(){var e=this;return Promise.resolve().then((function(){return e.beforeEdit()})).then((function(){return e.prepareCallback()})).then((function(){return u.a.takePicture()})).then((function(t){if(!t)return!1;console.log("获取图片数据",t),!g.a.state.global.hasTopProgress&&window&&window.StatusBar&&window.StatusBar.show();var i=e.value.concat(t);return t.user_id=e.currentUserId,v.a.handelPicture(t.temp).then((function(){"dev"===APP_ENV&&(e.$set(e.statusSet,t.id,"loading"),u.a.uploadImage(t.temp).then((function(e){t.url=e})).then((function(){e.$set(e.thumbnailSet,t.id,u.a.getImageThumbnail(t)),e.$set(e.statusSet,t.id,"successed"),e.$emit("input",i),e.$emit("callback",i)})))})).then((function(){e.$emit("input",i),e.$emit("callback",i)})),!0})).catch((function(t){return $log.error(t),p.a.alert(t||"发生了错误"),e.cancelCallback(),!g.a.state.global.hasTopProgress&&window&&window.StatusBar&&window.StatusBar.show(),!1}))},addVideo:function(){var t=this;return Promise.resolve().then((function(){return t.beforeEdit()})).then((function(){return t.prepareCallback()})).then((function(){return u.a.shootVideo()})).then((function(i){if(!g.a.state.global.hasTopProgress&&window&&window.StatusBar&&window.StatusBar.show(),e.isEmpty(i))return!1;i.user_id=t.currentUserId;var a=t.value.concat(i);return t.$emit("input",a),t.$emit("callback",a),"dev"===APP_ENV&&(t.$set(t.statusSet,i.id,"loading"),u.a.uploadImage(i.temp).then((function(e){i.url=e})).then((function(){return d.a.uploadFile(i.videoTemp).then((function(e){i.videoUrl=e}))})).then((function(){t.$set(t.thumbnailSet,i.id,u.a.getImageThumbnail(i)),t.$set(t.statusSet,i.id,"successed"),t.$emit("input",a),t.$emit("callback",a)}))),!0})).catch((function(e){return $log.error(e),p.a.alert(e||"发生了错误"),t.cancelCallback(),!g.a.state.global.hasTopProgress&&window&&window.StatusBar&&window.StatusBar.show(),!1}))},selectImage:function(){var t,i=this;if(this.allowMultiSelect){var a=Math.max(this.maxlength-this.value.length,0);t={maxSelectCount:a}}return Promise.resolve().then((function(){return i.beforeEdit()})).then((function(){return i.prepareCallback()})).then((function(){return u.a.selectPicture(t)})).then((function(t){if(!g.a.state.global.hasTopProgress&&window&&window.StatusBar&&window.StatusBar.show(),e.isEmpty(t))return!1;e.each(t,(function(e){e.user_id=i.currentUserId}));var a=i.value.concat(t);if(i.$emit("input",a),i.$emit("callback",a),"dev"===APP_ENV){var n=Promise.resolve();e.each(t,(function(e){i.$set(i.statusSet,e.id,"loading"),n=n.then((function(){return u.a.uploadImage(e.temp).then((function(t){delete e.temp,e.url=t,i.$set(i.thumbnailSet,e.id,u.a.getImageThumbnail(e)),i.$set(i.statusSet,e.id,"successed")}))}))})),n.then((function(){i.$emit("input",a),i.$emit("callback",a)}))}return!0})).catch((function(e){return $log.error(e),p.a.alert(e||"发生了错误"),i.cancelCallback(),!g.a.state.global.hasTopProgress&&window&&window.StatusBar&&window.StatusBar.show(),!1}))},addAppImage:function(t){var i=this;if(e.isEmpty(t))return Promise.reject("没有选择图片");var a=this.value.concat(t);return this.trackText&&c.a.addTrack(this.trackText+"-从APP相册选择照片","",""),Promise.all(e.map(t,(function(e){var t=h.a.uuid(),a=s.a.appImagePath()+"images/"+t+".jpg";return s.a.copyFile(e.temp,a).then((function(){e.id=t,e.temp=a,e.user_id=i.currentUserId})).then((function(){"dev"===APP_ENV&&(i.$set(i.statusSet,e.id,"loading"),u.a.uploadImage(e.temp).then((function(t){e.url=t,i.$set(i.thumbnailSet,e.id,u.a.getImageThumbnail(e)),i.$set(i.statusSet,e.id,"successed")})))}))}))).then((function(){i.$emit("input",a),i.$emit("callback",a)}))},selectAppImage:function(){var e=this;return new Promise(function(){var t=Object(a.a)(regeneratorRuntime.mark((function t(i,n){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.beforeEdit();case 3:v.a.maxImageLength=Math.max(e.maxlength-e.value.length,0),b.a.openPopup({bool:!0,callback:function(){var t=Object(a.a)(regeneratorRuntime.mark((function t(a){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.addAppImage(a).catch((function(e){p.a.alert(e),i(!1)}));case 2:i(!0);case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()}),t.next=11;break;case 7:t.prev=7,t.t0=t.catch(0),p.a.alert(t.t0),i(!1);case 11:case"end":return t.stop()}}),t,null,[[0,7]])})));return function(e,i){return t.apply(this,arguments)}}())},removeImage:function(t){var i=this,a=t.videoTemp?"确定要删除视频吗？":"确定要删除图片吗？";Promise.resolve().then((function(){return i.beforeEdit()})).then((function(){p.a.confirm(a).then((function(a){if(a){var n=i.value,o=e.indexOf(n,t);o>-1&&n.splice(o,1),i.$emit("remove",{index:o}),i.$emit("input",n),i.$emit("callback",n)}}))})).catch((function(e){p.a.alert(e)}))}}}}).call(this,i("391c"))},e68e:function(e,t,i){"use strict";var a=i("d209").a,n=(i("56bf"),i("17cc")),o=Object(n.a)(a,(function(){var e,t=this,i=t.$createElement,a=t._self._c||i;return t.editabled||t.value.length?a("ul",{staticClass:"item-img-list",class:(e={},e["item-img-list-"+t.group]=t.group,e)},[t.value.length?t._l(t.value,(function(e,i){return a("li",{key:i,style:{"background-image":"url("+t.getThumbnail(e)+")"},on:{click:function(a){t.imgView(e,i)}}},[!1===t.editabled||t.userLink&&(!t.userLink||e.user_id!==t.currentUserId)||t.pointImageMode?t._e():a("i",{staticClass:"icon-minus",on:{click:function(i){i.stopPropagation(),t.removeImage(e)}}}),e.videoUrl?a("van-icon",{attrs:{name:"play"}}):t._e(),e.size?a("i",{staticClass:"size"},[t._v(t._s(t.getSizeText(e)))]):t._e()],1)})):t._e(),t.pointImageMode?[t.value.length<t.maxlength&&!1!==t.editabled?a("li",{staticClass:"no-img",on:{click:t.pointImageEdit}},[a("p",{staticClass:"list-icon"},[a("icon",{attrs:{name:"dianweizhao"}})],1),a("p",{staticClass:"list-text"},[t._v("点位照")])]):t._e()]:[t.value.length<t.maxlength&&!1!==t.editabled?a("li",{staticClass:"no-img",on:{click:t.throttleAddImage}},[a("p",{staticClass:"list-icon"},[a("icon",{attrs:{name:"paizhao"}})],1),a("p",{staticClass:"list-text"},[t._v("拍照")])]):t._e(),t.value.length<t.maxlength&&!1!==t.editabled&&t.hasVideoItem?a("li",{staticClass:"no-img",on:{click:t.throttleAddVideo}},[a("p",{staticClass:"list-icon"},[a("icon",{attrs:{name:"shoot-video"}})],1),a("p",{staticClass:"list-text"},[t._v("拍视频")])]):t._e(),t.value.length<t.maxlength&&!1!==t.editabled&&t.allowAlbum?a("li",{staticClass:"no-img",on:{click:t.throttleSelectImage}},[a("p",{staticClass:"list-icon"},[a("icon",{attrs:{name:"xiangce"}})],1),a("p",{staticClass:"list-text"},[t._v("手机相册")])]):t._e(),t.value.length<t.maxlength&&!1!==t.editabled&&t.allowBuildin?a("li",{staticClass:"no-img",on:{click:t.throttleAppImage}},[a("p",{staticClass:"list-icon"},[a("icon",{attrs:{name:"xiangce"}})],1),a("p",{staticClass:"list-text"},[t._v("APP相册")])]):t._e()]],2):t._e()}),[],!1,null,null,null);t.a=o.exports},ea6b:function(e,t,i){var a=i("8cb7");"string"==typeof a&&(a=[[e.i,a,""]]),a.locals&&(e.exports=a.locals);(0,i("85cb").default)("2c75d179",a,!0,{sourceMap:!1,shadowMode:!1})}}]);