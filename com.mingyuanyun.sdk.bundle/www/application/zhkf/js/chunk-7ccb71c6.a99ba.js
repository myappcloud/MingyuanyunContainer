(window["webpackJsonp_module_entry_zhkf_"]=window["webpackJsonp_module_entry_zhkf_"]||[]).push([["chunk-7ccb71c6"],{"01e5":function(e,t,i){"use strict";var o=i("1834");t["a"]={getCustomersByRoomId:function(e){var t='select distinct customer_id,  ifnull(customer_name, "") as customer_name, ifnull(customer_phone, "") as customer_phone  from customer_room where room_id = ?';return o["a"].query(t,[e])}}},"0cd9":function(e,t,i){"use strict";var o=i("fd50"),n=(i("f548"),i("1834")),r={getPositionListWithProjectItem:function(e,t){var i="select p.id position_id,p.name position_name, p.sort  from position p  inner join room_type_position rtp on p.id = rtp.position_id  inner join batch_room br on br.room_type_id = rtp.room_type_id  where br.id = ? and exists( select ppc.position_id from project_position_checkitem ppc  inner join check_item_desc desc on ppc.item_id = desc.check_item_id  where ppc.position_id=p.id and ppc.proj_id = ?)  order by p.sort,p.name";return n["a"].query(i,[t,e])},getPositionList:function(e){var t="select distinct p.id position_id,p.name position_name, p.sort from position p  inner join room_type_position rtp on p.id = rtp.position_id  inner join batch_room br on br.room_type_id = rtp.room_type_id  where br.id = ? and exists(select pc.position_id from position_checkitem pc  inner join check_item_desc desc on pc.item_id = desc.check_item_id where pc.position_id=p.id) order by p.sort,p.name";return n["a"].query(t,[e])},getFirstProjectPositionItemNotDone:function(e,t,i,o){o=o?" and ci.apply_scope in "+o:"";var r="select ppc.position_id, ci.id as item_id,ci.name as item_name,ci.full_name  from project_position_checkitem ppc  inner join position p on ppc.position_id = p.id  inner join check_item ci on ppc.item_id = ci.id "+o+" inner join room_type_position rtp on ppc.position_id = rtp.position_id  inner join batch_room br on br.room_type_id = rtp.room_type_id  where ppc.proj_id = ? and 1=1 and ci.ifEnd = 1  and not exists(select done.item_id from batch_room_check_list_done done where done.batch_room_id = ? and ppc.position_id = done.position_id and ci.id = done.item_id)  and exists(select desc.id from check_item_desc desc where desc.check_item_id=ci.id)  order by p.sort, p.name, ci.sort";return r="毛坯"==i?r.replace("1=1","ci.is_for_rough = 1"):r.replace("1=1","ci.is_for_decorated = 1"),n["a"].queryOne(r,[e,t])},getFirstTenantPositionItemNotDone:function(e,t,i){i=i?" and ci.apply_scope in "+i:"";var o="select pc.position_id, ci.id as item_id,ci.name as item_name,ci.full_name from position_checkitem pc  inner join position p on pc.position_id = p.id  inner join check_item ci on pc.item_id = ci.id "+i+" inner join room_type_position rtp on pc.position_id = rtp.position_id  inner join batch_room br on br.room_type_id = rtp.room_type_id  where br.id = ? and 1=1 and ci.ifEnd = 1 and not exists(select done.item_id from batch_room_check_list_done done where br.id = done.batch_room_id and pc.position_id = done.position_id and ci.id = done.item_id)  and exists(select desc.id from check_item_desc desc where desc.check_item_id=ci.id)  order by p.sort, p.name, ci.sort";o="毛坯"==t?o.replace("1=1","ci.is_for_rough = 1"):o.replace("1=1","ci.is_for_decorated = 1");var r=[e];return n["a"].queryOne(o,r)},getProjectRoomPositionItem:function(e,t,i,o,r){r=r?" and ci.apply_scope in "+r:"";var a='select ci.id as item_id,ci.name as item_name,ci.full_name, guide.remark, done.item_id as done,  (select count(1) from batch_room_material bm where bm.item_id = ci.id and bm.position_id = ? and bm.batch_room_id = ?) as material_count,  case when exists(select * from batch_room_material bm where bm.item_id = ci.id and bm.status = "不通过" and bm.position_id = ? and bm.batch_room_id = ?) then 1 else 0 end has_dot  from project_position_checkitem ppc  inner join check_item ci on ppc.item_id = ci.id '+r+" left join batch_room_check_list_done done on ppc.position_id = done.position_id and ci.id = done.item_id and done.batch_room_id = ?  left join check_item_guide guide on ci.id = guide.item_id  left join check_item_room_average_problem_num num on ci.id = num.item_id where ppc.position_id = ? and ppc.proj_id = ? and ci.ifEnd = 1 and 1=1  and exists(select desc.id from check_item_desc desc where desc.check_item_id=ci.id)  order by num.num desc, ci.sort,ci.name";return a="毛坯"==o?a.replace("1=1","ci.is_for_rough = 1"):a.replace("1=1","ci.is_for_decorated = 1"),n["a"].query(a,[i,t,i,t,t,i,e])},getTenantRoomPositionItem:function(e,t,i,o){o=o?" and ci.apply_scope in "+o:"";var r='select distinct ci.id as item_id,ci.name as item_name,ci.full_name, guide.remark, done.item_id as done, (select count(1) from batch_room_material bm where bm.item_id = ci.id and bm.position_id = ? and bm.batch_room_id = ?) as material_count,  case when exists(select * from batch_room_material bm where bm.item_id = ci.id and bm.status = "不通过" and bm.position_id = ? and bm.batch_room_id = ?) then 1 else 0 end has_dot  from position_checkitem pc  inner join check_item ci on pc.item_id = ci.id '+o+" left join batch_room_check_list_done done on pc.position_id = done.position_id and ci.id = done.item_id and done.batch_room_id = ?  left join check_item_guide guide on ci.id = guide.item_id  left join check_item_room_average_problem_num num on ci.id = num.item_id where pc.position_id = ? and ci.ifEnd = 1  and 1=1  and exists(select desc.id from check_item_desc desc where desc.check_item_id=ci.id)  order by num.num desc, ci.sort,ci.name";r="毛坯"==i?r.replace("1=1","ci.is_for_rough = 1"):r.replace("1=1","ci.is_for_decorated = 1");var a=[t,e,t,e,e,t];return n["a"].query(r,a)},getTenantSearchPositionItem:function(e,t,i){i=i?" and ci.apply_scope in "+i:"";var o="select distinct ci.id as item_id,ci.name as item_name,ci.full_name as item_full_name,ci.level,ci.sort from position_checkitem pc  inner join check_item ci on pc.item_id = ci.id"+i+" where pc.position_id = ? and ci.ifEnd = 1  and 1=1  and exists(select desc.id from check_item_desc desc where desc.check_item_id=ci.id)  order by ci.full_name";o="毛坯"==t?o.replace("1=1","ci.is_for_rough = 1"):o.replace("1=1","ci.is_for_decorated = 1");var r=[e];return n["a"].query(o,r)},getProjectSearchPositionItem:function(e,t,i,o){o=o?" and ci.apply_scope in "+o:"";var r="select ci.id as item_id,ci.name as item_name,ci.full_name as item_full_name,ci.level,ci.sort from project_position_checkitem ppc  inner join check_item ci on ppc.item_id = ci.id "+o+" where ppc.position_id = ? and ppc.proj_id = ? and ci.ifEnd = 1 and 1=1  and exists(select desc.id from check_item_desc desc where desc.check_item_id=ci.id)  order by ci.full_name";return r="毛坯"==i?r.replace("1=1","ci.is_for_rough = 1"):r.replace("1=1","ci.is_for_decorated = 1"),n["a"].query(r,[t,e])},getRoomPositionItemDoneRecord:function(e,t,i){var o="select item_id from batch_room_check_list_done where batch_room_id = ? and position_id = ? and item_id = ?";return n["a"].queryOne(o,[e,t,i])},insertDoneItem:function(e,t,i){return n["a"].insert("batch_room_check_list_done",["batch_room_id","position_id","item_id"],[e,t,i])}},a=i("c6e3"),s=i("07a4");t["a"]={getPositionList:function(e,t){var i=o["a"].when();return i=s["a"].state.app.global.isUseProjectItem?r.getPositionListWithProjectItem(e,t):r.getPositionList(t),i.then((function(e){return e}))},getFirstPositionItemNotDone:function(e,t,i,n){var a=o["a"].when();return a=s["a"].state.app.global.isUseProjectItem?r.getFirstProjectPositionItemNotDone(e,t,i,n):r.getFirstTenantPositionItemNotDone(t,i,n),a.then((function(e){return e}))},getPositionEndItem:function(e,t,i,n,a){var c=o["a"].when();return c=s["a"].state.app.global.isUseProjectItem?r.getProjectRoomPositionItem(e,t,i,n,a):r.getTenantRoomPositionItem(t,i,n,a),c.then((function(e){if(!_.isEmpty(e))for(var t=0;t<e.length&&t<3;t++)e[t].isImportant=!0;return e}))},getPositionEndItemForSearch:function(e,t,i,n){var a=["全部"];a.push(1==n?"公区":"房间"),a="('"+a.join("','")+"')";var c=o["a"].when();return c=s["a"].state.app.global.isUseProjectItem?r.getProjectSearchPositionItem(e,t,i,a):r.getTenantSearchPositionItem(t,i,a),c.then((function(e){return e}))},addDoneItemRecord:function(e,t,i){return r.getRoomPositionItemDoneRecord(e,t,i).then((function(o){if(!o)return r.insertDoneItem(e,t,i)}))},getRoomFitmentStandard:function(e){return a["a"].getRoomFitmentStand(e).then((function(e){return e||{fitment_standard:"毛坯"}}))}}},"28c8":function(e,t,i){"use strict";i("6d57");var o=i("1834"),n=i("0938");t["a"]={getRoomSatisfactionValueList:function(e,t){var i="                 select sd.id , sd.dimension as name , rsv.value                 from satisfaction_dimension sd                     left join room_satisfaction_value rsv                         on rsv.batch_room_id = ? and sd.id = rsv.dimension_id                 where sd.type = ?                 order by sd.sort , sd.dimension";return o["a"].query(i,[t,e])},saveRoomSatisfactionValue:function(e,t,i){var r,a=["batch_id","batch_room_id","batch_unit_id","dimension_id","id","source","value"];if(!t)throw new TypeError("saveRoomSatisfactionValue: batchRoomId为空");e.delete("room_satisfaction_value",{batch_room_id:t},(function(){i&&i.length&&i.forEach((function(i){i.id=Object(n["j"])(),i.batch_room_id=t,console.log("字段=====",i),r=o["a"].getColumnsValues(i,a),e.insert("room_satisfaction_value",a,r)}))}))}}},"3fa2":function(e,t,i){"use strict";i("ed63"),i("8cf2");var o=i("0523"),n=i("9af1"),r=i("0cd9"),a=i("9443"),s=(i("6d57"),i("01e5")),c=i("a38a"),d=i("c6e3"),u=i("a2ee"),m={getAllTag:function(){return u["a"].getAllTag().then((function(e){return _.isEmpty(e)?[]:e}))},getCustomerTag:function(e){return u["a"].getCustomerTag(e,"tag_id").then((function(e){if(_.isEmpty(e))return[];var t=[];return e.forEach((function(e){t.push(e.tag_id)})),t}))},getCustomerAssess:function(e){return c["a"].getCustomerAssess(e).then((function(e){return _.isEmpty(e)?"":e["remark"]}))},upsertCustomerTags:function(e,t,i){return t=t||[],i=i||[],e?_.isEmpty(t)&&_.isEmpty(i)?$q.resolve():u["a"].upsertCustomerTags(e,t,i):$q.reject("缺少客户id")},addCustomerTagDataIncrement:function(e){return u["a"].addCustomerTagDataIncrement(e)},upsertCustomerAssess:function(e,t){return e&&t?c["a"].upsertCustomerAssess(e,t):$q.reject("缺少客户id或评价说明")},addCustomerAssessDataIncrement:function(e){return c["a"].addCustomerAssessDataIncrement(e)},getRoomCustomerInfo:function(e){return s["a"].getCustomersByRoomId(e).then((function(e){var t=[],i=[];return e.forEach((function(e){t.push(function(e){var t=e.customer_id;return $q.all([u["a"].getCustomerTagInfo(t),c["a"].getCustomerAssess(t)]).then((function(t){i.push({customerName:e.customer_name,customerPhone:e.customer_phone,tags:t[0]||[],remark:t[1]&&t[1]["remark"]?t[1]["remark"]:""})}))}(e))})),$q.all(t).then((function(){return i}))}))},updateRoomAssessStatus:function(e,t){return d["a"].updateRoomAssessStatus(e,t)},hasTags:function(){return u["a"].hasTags().then((function(e){return e&&!!e["id"]}))}},l=i("d485"),p=i("a6f0"),f=i("a593"),h=i("07a4"),g=i("265f"),v=i("0e1c"),y=i("cb6b"),b=i("1834");function I(){var e={},t={};function i(e){return t.isReviewed=!1,t.from=e.from,t.fromType=e.type,t.roomTypeId=e.room_type_id,t.batchId=e.batch_id,t.id=e.roomId,t.batchRoomId=e.batchRoomId,t.batchUnitId=e.batch_unit_id,t.buildingId=e.building_id,t.positionId=e.position_id,t.fitmentStandard=e.fitment_standard,t.isSpecial=1===e.isSpecial,t.mode="1"===e.mode,t.canBatchAddProblem=!1,t.canTag=!1,h["a"].commit("app/APP",{currentMenuType:e.menuType||""}),s("初始化房间 - initRoom","params",e),o["a"].getRoomBaseInfo(e.batchRoomId).then((function(i){return s("获取房间基础信息 - getRoomBaseInfo",i),t.title=(-1===i.building_name.indexOf("栋")&&-1===i.building_name.indexOf("幢")?i.building_name+"栋":i.building_name)+(i.unit?"-"+i.unit+(i.unit.indexOf("单元")>-1?"":"单元"):"")+(-1===i.floor.indexOf("层")&&-1===i.floor.indexOf("楼")&&-1===i.floor.indexOf("公共区域")?"-"+i.floor+"楼":"-"+i.floor)+(-1!==i.room_no.indexOf("公共区域")?"-"+i.floor+"层 公共区域":"-"+i.room_no),t.hasDeliveryInfo=!!i.has_delivery_info,t.hasProblem=!!i.has_problem,t.isVirtual=i.is_virtual,t.canCheckPassRoom=!("simulate"!==t.fromType||"待检查"!==i.check_status||!f["default"].prototype.$checkRight("check_room",t.fromType)),t.projectId=i.project_id,t.isVirtual=i.is_virtual,t.assess_customer_status=i.assess_customer_status,t.delivery_status=i.delivery_status,t.hasCustomer=!1,t.hasTags=!1,o["a"].getRoomCustomer(e.roomId).then((function(e){e&&e.length>0&&(t.hasCustomer=!0,t.canTag="已评价"!=i.assess_customer_status,["delivery","deliveryprocess","online_delivery","online_delivery_center"].includes(t.fromType)&&(t.canTag=t.canTag&&"待交付"!=t.delivery_status))}))})).then((function(){if("delivery"===t.fromType||"online_delivery"===t.fromType)return o["a"].getRoomIsReviewed(t.batchRoomId).then((function(e){t.isReviewed=!!e}))})).then((function(){if("opening"===t.fromType)return l["a"].getRoomIsReceived(t.batchRoomId).then((function(e){t.isReceived=!!e}))})).then((function(){return o["a"].getRoomTypeImageFileIsExists(t.batchRoomId).then((function(e){t.hasDiagramImage=e}))})).then((function(){return m.hasTags().then((function(e){t.hasTags=e,t.canTag=t.canTag&&e}))}))}function s(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];console.log("[model]/room-model.js： ",e,i)}return{model:e,room:t,init:function(s){var c=h["a"].state.app.global.enableDeliveryProcess?"验房信息":"交付信息";h["a"].commit("app/APP",{deliveryConfigViewTitle:c}),e.tabs=[],e.showFilter=!1,e.currTab="";var d=i(s);return t.isSpecial?d.then((function(){return t})):d.then((function(){if(e.roomTitle=t.title,!t.isSpecial&&t.hasDiagramImage)return e.tabs.unshift("户型图"),e.showFilter=!0,e.hasRoomHuxing=!0,n["a"].hasRoomTypeDiagram(t.batchRoomId).then((function(i){var o=y["a"].getObject(v["a"].TAKE_PHOTO_WHEN_REGIST,y["a"].level.user);return t.canBatchAddProblem=i&&"simulate"===t.fromType&&!o&&e.hasRoomHuxing,t}))})).then((function(){return r["a"].getPositionList(t.projectId,t.batchRoomId).then((function(i){_.isEmpty(i)||((!["opening","delivery","online_delivery"].includes(t.fromType)||g["a"].getIsHideCheckList()&&"off"!==g["a"].getIsHideCheckList())&&["opening","delivery","online_delivery"].includes(t.fromType)||e.tabs.push("检查清单"),e.hasCheckList=!0)}))})).then((function(){return o["a"].existsRoomDesignChange(s.batchRoomId).then((function(t){t&&e.tabs.push("设计变更"),e.hasRoomDesignChange=t}))})).then((function(){return a["a"].hasFitmentStyle(t.id).then((function(t){t&&e.tabs.push("装修风格"),e.hasFitmentStyle=t}))})).then((function(){return e.tabs.push("列表"),t}))},getButtonsByFromType:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=[],o=h["a"].state.app.global.currentBatchType;if("simulate"===o)e&&f["default"].prototype.$checkRight("add_problem",o)&&t.canBatchAddProblem&&i.push({type:"goBatchAddProblem",label:"批量登记问题",track:"批量登记问题|户型图",className:"btn-white"}),t.canCheckPassRoom&&i.push({type:"goCheckPassRoom",label:t.hasProblem?"检查完毕":"没有问题检查完毕",className:"btn-theme"});else if(!t.isVirtual)if("opening"===o)t.isReceived?(i.push({type:"goReceiveView",label:"接待信息",className:"btn-white"}),t.canTag&&f["default"].prototype.$checkRight("assess_customer",h["a"].state.app.global.currentBatchType)&&i.push({type:"goCustomerEvaluationView",label:"客户评价",className:"btn-theme"})):f["default"].prototype.$checkRight("receive_room","opening")&&i.push({type:"goAddReceiveInfo",label:"接待",className:"btn-theme"});else if("delivery"===o||"deliveryprocess"===o||"online_delivery"===o||"online_delivery_center"===o){if(t.hasDeliveryInfo)i.push({type:"goDeliveryView",label:h["a"].state.app.global.enableDeliveryProcess?"验房信息":"交付信息",className:"btn-white"}),t.canTag&&f["default"].prototype.$checkRight("assess_customer",h["a"].state.app.global.currentBatchType)&&i.push({type:"goCustomerEvaluationView",label:"客户评价",className:"btn-theme"});else if(f["default"].prototype.$checkRight("deliver_room",h["a"].state.app.global.currentBatchType)){var n={width:"60%"};h["a"].state.app.deliveryConfig.reject_delivery.enabled&&"on"!==g["a"].getIsHideRejectDeliveryButton()&&!h["a"].state.app.global.enableDeliveryProcess&&(i.push({type:"goRefuseDelivery",label:h["a"].state.app.deliveryConfig.reject_delivery.text,className:"btn-gray"}),t.canTag&&f["default"].prototype.$checkRight("assess_customer",h["a"].state.app.global.currentBatchType)&&(i.push({type:"goCustomerEvaluationView",label:"客户评价",className:"btn-theme"}),n={}));var r=h["a"].state.app.global.enableDeliveryProcess?"验房完毕":h["a"].state.app.deliveryConfig.receive_delivery.text;i.push({type:"goAddDeliveryInfo",label:r,className:"btn-theme",style:n})}if(f["default"].prototype.$checkRight("repair_confirm",h["a"].state.app.global.currentBatchType)&&t.hasCustomer&&!t.isReviewed){var a="btn-theme",c=!1;l["a"].getProblemList(t.batchRoomId,0,!0).then((function(e){var o=e.filter((function(e){return"已作废"!=e.status&&"非正常关闭"!=e.status}));o.length&&(c=!0),c&&p["a"].getDeliveryInfo(t.batchRoomId).then((function(e){if("交付中"===e.delivery_status&&"暂不收楼"!==e.delivery_situation){if(e.problemList&&e.problemList.length)for(var t=0;t<e.problemList.length;t++)"待派单"!=e.problemList[t].status&&"待整改"!=e.problemList[t].status&&"已整改"!=e.problemList[t].status||(a="btn-white");i.push({type:"goDeliveryReview",label:"复查确认",className:a}),i.forEach((function(e){"客户评价"===e.label&&(e.className="btn-white")}))}}))}))}}return 1===i.length&&(i[0].className="btn-theme"),i.length>1&&(i[0].className="btn-white"),i.length>2&&(i[1].className="btn-white"),s("根据来源获取对应的底部按钮 - getButtonsByFromType","fromType=".concat(o),i,t),i},updateRoomInfo:function(e){s("更新当前房间参数-updateRoomInfo",t,"canTag=".concat(t.canTag)),_.each(e,(function(e,i){t[i]=e})),t.hasCustomer&&(t.canTag=t.hasTags&&"已评价"!=t.assess_customer_status,"delivery"!==t.fromType&&"online_delivery"!==t.fromType||(t.canTag=t.canTag&&"待交付"!=t.delivery_status))},changeSatisfactionUploadFlag:function(e){return b["a"].update("room_satisfaction_value",{source:""},{batch_room_id:e,source:"app"})},checkReviewed:function(){if("delivery"===t.fromType||"online_delivery"===t.fromType)return o["a"].getRoomIsReviewed(t.batchRoomId).then((function(e){t.isReviewed=!!e}))}}}t["a"]=I()},8326:function(e,t,i){"use strict";var o=i("cb6b"),n=i("0e1c"),r=i("a14a"),a=i.n(r),s=function(){var e=n["a"].DELIVERY_CONFIG_STORAGE;return o["a"].set(e,{customer_phone:"",saved_customer_phone:"",electric_meter_degree:"",saved_electric_meter_degree:"",water_meter_degree:"",saved_water_meter_degree:"",gas_meter_degree:"",saved_gas_meter_degree:"",heating_pressure_degree:"",saved_heating_pressure_degree:"",keynum:0,saved_keynum:0,signature_image_localpath:"",saved_signature_image_localpath:"",review_signature_image_localpath:"",saved_review_signature_image_localpath:"",star:0,saved_star:0,reject_remak:"",delivery_degree_items:null,delivery_record_items:null}),{getDelivery:function(){return o["a"].getObject(e)},updateDelivery:function(t){var i=a.a.extend(o["a"].getObject(e),t);o["a"].set(e,i)}}};t["a"]=s()},9443:function(e,t,i){"use strict";i("e697"),i("6d57"),i("cc57");var o=i("1834"),n={getRoomFitmentStyleName:function(e){var t="select name from fitment_style fs  inner join room r on r.fitment_style_id = fs.id where r.room_id = ?";return o["a"].queryOne(t,[e])},hasFitmentStyle:function(e){var t="select id from room where room_id = ?";return o["a"].queryOne(t,[e])}},r=n,a={getRoomFitmentStyles:function(e){var t='select fsc.id, fsc.checkitem_option_id, ifnull(fco.img_local, "") as image, ci.id as checkItemId, ci.config_type as configType, p.id as positionId, ci.full_name as checkItemName, p.name as positionName from fitment_style_checkitem as fsc inner join room r on r.fitment_style_id = fsc.fitment_style_id inner join fitment_checkitem_option fco on fco.id = fsc.checkitem_option_id inner join check_item ci on ci.id = fsc.item_id  inner join position p on p.id = fsc.position_id where r.room_id = ? order by p.name, ci.full_name';return o["a"].query(t,[e])},getRoomIndividualFitmentStyles:function(e){var t='select fsc.id, r.checkitem_option_id, ifnull(fco.img_local, "") as image, ci.id as checkItemId, ci.config_type, p.id as positionId, ci.full_name as checkItemName, p.name as positionName from room_fitment_checkitem r  inner join fitment_style_checkitem fsc on r.style_checkitem_id = fsc.id inner join fitment_checkitem_option fco on fco.id = r.checkitem_option_id inner join check_item ci on ci.id = fsc.item_id  inner join position p on p.id = fsc.position_id where r.room_id = ? order by p.name, ci.full_name';return o["a"].query(t,[e])},getCheckitemOptionInfo:function(e){var t="select img_local, brand, model, color, specifications, remark from fitment_checkitem_option where id = ?";return o["a"].queryOne(t,[e])}},s=a,c={hasFitmentStyle:function(e){return r.hasFitmentStyle(e).then((function(e){return!_.isEmpty(e)}))},getRoomFitmentStyleName:function(e){return r.getRoomFitmentStyleName(e).then((function(e){return e?e["name"]:""}))},getRoomFitmentStyles:function(e,t){t=t||"";var i={defaultList:[],individualList:[]};return s.getRoomFitmentStyles(e,t).then((function(o){return o?(i.defaultList=o,s.getRoomIndividualFitmentStyles(e,t).then((function(e){return e&&(i.individualList=e,e.forEach((function(e){var t=_.find(i.defaultList,{id:e.id});t>-1&&i.defaultList.splice(t,1)}))),i}))):i}))},getCheckitemOptionInfo:function(e){return s.getCheckitemOptionInfo(e)}};t["a"]=c},"97ba":function(e,t,i){"use strict";i("6d57"),i("cc57");var o=i("1834"),n=i("a14a"),r=i.n(n),a=function(e){var t="select p.id position_id,p.name position_name from position p  inner join room_type_position rtp on p.id = rtp.position_id  inner join batch_room br on br.room_type_id = rtp.room_type_id  where br.id = ? order by p.sort";return o["a"].query(t,[e])};t["a"]={getPositionList:a,getPositionNameById:function(e){var t="select name from position where id = ?";if(!e)throw new Error("参数错误");return o["a"].queryOne(t,[e]).then((function(e){return e&&e.name}))},getRoomTypePositionIdsByCheckItemId:function(e,t){var i=[];return o["a"].query("select rtp.position_id           from room_type_position rtp             inner join position_checkitem pc on rtp.position_id=pc.position_id           where rtp.room_type_id = ? and pc.item_id = ?",[t,e]).then((function(e){return e&&e.length&&e.forEach((function(e){i.push(e.position_id)})),i}))},getPositionByIds:function(e){r.a.isArray(e)&&(e='"'.concat(e.join('","'),'"'));var t="select id, name from position where id in ("+e+")";return o["a"].query(t)},getRoomPositionFilter:function(e){var t="select a.value, a.name, count(problem_id) as count from (select p.id value,p.name name, cp.id as problem_id from position p  inner join room_type_position rtp on p.id = rtp.position_id  inner join batch_room br on br.room_type_id = rtp.room_type_id  left join checkroom_problem cp on cp.batch_room_id = br.id and cp.position_id = p.id where br.id = ? order by p.sort) as a group by a.value";return o["a"].query(t,[e])},getRoomPositionFilterHasProblem:function(e){var t="select p.id value, ifnull(p.name, '其他') name, count(cp.id) as count  from checkroom_problem cp  left join position p on cp.position_id = p.id where cp.batch_room_id = ? group by p.id order by p.sort";return o["a"].query(t,[e])}}},"9af1":function(e,t,i){"use strict";i("cc57"),i("e697"),i("6d57");var o=i("af93"),n=i("97ba"),r=i("bbed"),a=i("a14a"),s=i.n(a),c={},d={},u={"常用状态":0,"所有状态":0,"待派单":0,"待整改":0,"已整改":0,"已通过":0,"已作废":0,"非正常关闭":0},m={"待派单":"dpd","待整改":"dzg","已整改":"yzg","已通过":"ytg","已作废":"yzf","非正常关闭":"fzcgb"},_=["待派单","待整改","已整改","已通过"];d.getStatusFilter=function(e,t,i,o){var n=[],r=0;o=o||"isShow";var a=!s.a.isEmpty(t);if(t=t||s.a.cloneDeep(u),i=i||[],e.forEach((function(e){(e[o]||a)&&(_.indexOf(e.status)>-1&&t["常用状态"]++,isNaN(t[e.status])||(t[e.status]++,r++))})),t["所有状态"]=r,!i.length)return s.a.each(t,(function(e,t){n.push({value:"所有状态"===t?"":t,name:t,count:e,className:m[t]?m[t]:""})})),n;i.forEach((function(e){var i=e.value?e.value:"所有状态";e.count=t[i]}))},d.updateFilter=function(e,t){var i=s.a.find(t,{key:"status"}),o=s.a.cloneDeep(u),n=s.a.find(t,{key:"position"}),r={},a=s.a.find(t,{key:"checkItem"}),c={},d={status:0,pos:0,item:0};e.forEach((function(e){e.isStatusShow&&(_.indexOf(e.status)>-1&&o["常用状态"]++,isNaN(o[e.status])||(o[e.status]++,d.status++)),e.isPositionShow&&(r[e.position_id]||(r[e.position_id]={name:e.position_name||"其他",count:0}),r[e.position_id].count++,d.pos++),e.isCheckitemShow&&(c[e.item_id]||(c[e.item_id]={name:e.short_item_name||"其他",count:0}),c[e.item_id].count++,d.item++)})),o["所有状态"]=d.status,i.list.forEach((function(e){var t=e.value?e.value:"所有状态";e.count=o[t]})),n.list=[],n.list.push({value:"",name:"全部",count:d.pos}),s.a.each(r,(function(e,t){n.list.push({value:t,name:e.name,count:e.count})})),a.list=[],a.list.push({value:"",name:"全部",count:d.item}),s.a.each(c,(function(e,t){a.list.push({value:t,name:e.name,count:e.count})}))},c.getDefaultFilterList=function(e,t,i){var o={},a=e.length;return n["a"].getRoomPositionFilterHasProblem(t).then((function(e){e.unshift({value:"",name:"全部",count:a}),o.position=e})).then((function(){var t=s.a.cloneDeep(u);"simulate"!==i&&"special_checkitem"!==i||delete t["非正常关闭"],o.status=d.getStatusFilter(e,t)})).then((function(){return r["a"].getRoomCheckItemFilter(t).then((function(e){return e.unshift({value:"",name:"全部",count:a}),o.checkItem=e,o}))})).catch((function(e){console.log(e)}))},c.hideProblemByFilter=function(e,t,i,o){var n=[i.status];return"常用状态"===i.status&&(n=_),e.forEach((function(e,t){var o=!i.status||n.indexOf(e.status)>-1,r=!i.position||e.position_id===i.position,a=!i.checkItem||e.item_id===i.checkItem;e.isShow=o&&r&&a,e.isStatusShow=r&&a,e.isPositionShow=o&&a,e.isCheckitemShow=r&&o})),d.updateFilter(e,t)},c.getCheckItemFilter=function(e,t,i,o){var n="毛坯"===o;return r["a"].getCheckItemFilter(t,i,n).then((function(t){t.push({value:"eec99576-92a9-11e7-b3fa-005056a65fd7",name:"设计变更",count:0});var i={},o=0;e.forEach((function(e){e.isShow&&(i[e.item_id]||(i[e.item_id]=0),i[e.item_id]++,o++)}));var n=[];return t.forEach((function(e){i[e.value]?(e.count=i[e.value],n.push(e)):e.count=0})),n.unshift({value:"",name:"全部",count:o}),n}))},c.hasRoomTypeDiagram=function(e){return o["a"].hasRoomTypeDiagram(e)},t["a"]=c},a2ee:function(e,t,i){"use strict";i("6d57");var o=i("1834"),n=i("0938");t["a"]={hasTags:function(){return o["a"].queryOne("select id from tag")},getAllTag:function(){var e="select * from tag order by sort";return o["a"].query(e)},getCustomerTag:function(e,t){t=t||"*";var i="select "+t+' from customer_tag  where customer_id = ? and operation <> "delete"';return o["a"].query(i,[e])},getCustomerTagInfo:function(e){var t='select t.name from customer_tag ct inner join tag t on t.id = ct.tag_id  where ifnull(ct.operation, "") <> "delete" and ct.customer_id = ?  order by t.sort';return o["a"].queryColumn(t,[e],"name")},upsertCustomerTags:function(e,t,i){return o["a"].transaction((function(o){i.forEach((function(t){o.update("customer_tag",{source:"app",operation:"delete"},{customer_id:e,tag_id:t})}));var n=["tag_id","customer_id","source","operation"];t.forEach((function(t){var i=[t,e,"app","add"];o.insert("customer_tag",n,i)}))}))},addCustomerTagDataIncrement:function(e){return o["a"].transaction((function(t){t.delete("data_increment",{relation_id:e.id,batch_unit_id:e.batchUnitId,type:"customer_tag"}),t.insert("data_increment",["id","batch_id","relation_id","type","batch_unit_id","batch_room_id"],[n["a"].uuid(),e.batchId,e.id,"customer_tag",e.batchUnitId,e.batchRoomId])})).then((function(){window.uploadStatus("waitUpload")}))}}},a38a:function(e,t,i){"use strict";var o=i("1834"),n=i("0938");t["a"]={getCustomerAssess:function(e){var t="select remark from customer_assess where customer_id = ?";return o["a"].queryOne(t,[e])},upsertCustomerAssess:function(e,t){return o["a"].transaction((function(i){i.delete("customer_assess",{customer_id:e}),i.insert("customer_assess",["customer_id","remark","source"],[e,t,"app"])}))},addCustomerAssessDataIncrement:function(e){return o["a"].transaction((function(t){t.delete("data_increment",{relation_id:e.id,batch_unit_id:e.batchUnitId,type:"customer_assess"}),t.insert("data_increment",["id","batch_id","relation_id","type","batch_unit_id","batch_room_id"],[n["a"].uuid(),e.batchId,e.id,"customer_assess",e.batchUnitId,e.batchRoomId])})).then((function(){window.uploadStatus("waitUpload")}))}}},a6f0:function(e,t,i){"use strict";i("6d57");var o=i("c6e3"),n=i("d485"),r=i("8326"),a=i("a405"),s=i("28c8"),c=i("3fa2"),d=i("d42a"),u=i("fd50"),m=i("a14a"),_=i.n(m),l=function(){return{getRoomDeliveryStatus:o["a"].getRoomDeliveryStatus,getDeliveryInfo:function(e){var t=[o["a"].getRoomDeliveryInfo(e),o["a"].getRoomTitle(e,!0),n["a"].getProblemList(e,1),s["a"].getRoomSatisfactionValueList("交付",e),a["a"].hasListWithoutLocal(e),o["a"].getRoomReceivePersonInfo(c["a"].room.id),o["a"].getRoomReviewImages(e),o["a"].getDeliveryItems(e)],i=function(e){var t=[];return _.a.each(e,(function(e){"已通过"!==e.status&&t.push(e)})),t};return u["a"].all(t).then((function(e){var t=e[0];return t.room_title=e[1],t.problemList=i(e[2]),t.satisfactionList=e[3],t.hasRejection=e[4],t.customers=e[5],t.review_images=e[6],t.delivery_degree_items=[],t.delivery_record_items=[],e[7].forEach((function(e){"读数"===e.item_type&&t.delivery_degree_items.push(e),"记录"===e.item_type&&t.delivery_record_items.push(e)})),console.log(t,"交付信息================"),t}))},getDeliveryRejectionList:function(e){return a["a"].getList(e)},hasDeliveryRejectionList:function(e){return a["a"].hasList(e)},getReviewRoomInfo:function(e){var t=[o["a"].getRoomCustomerInfo(e),o["a"].getRoomTitle(e,!0),o["a"].getRoomReceivePersonInfo(c["a"].room.id)];return u["a"].all(t).then((function(e){console.log("获取复查房间信息",e);var t=e[0];return t.room_title=e[1],t.customers=e[2],t}))},saveDeliveryInfo:function(e,t){return d["a"].saveDeliveryInfo(e,t)},saveReviewInfo:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return d["a"].saveReviewInfo(e,t,i)},isChangeDelivery:function(){var e=r["a"].getDelivery(),t=e.saved_customer_phone!=e.customer_phone||e.saved_electric_meter_degree!=e.electric_meter_degree||e.saved_water_meter_degree!=e.water_meter_degree||e.saved_gas_meter_degree!=e.gas_meter_degree||e.saved_heating_pressure_degree!=e.heating_pressure_degree||e.saved_keynum!=e.keynum||e.saved_signature_image_localpath!=e.signature_image_localpath;if(t)return!0;var i=[];for(var o in e)-1!=o.indexOf("config_")&&i.push(o.slice(7));for(var n=0;n<i.length;n++)if(e["config_"+i[n]]!=e["saved_"+i[n]])return!0;return!1},isChangeReview:function(){var e=r["a"].getDelivery();return e.saved_customer_phone!=e.customer_phone||e.saved_backkey!=e.backkey||e.saved_review_remark!=e.review_remark},isSetRejectRemark:function(){var e=r["a"].getDelivery();return""!==e.reject_remak}}};t["a"]=l()},af93:function(e,t,i){"use strict";var o=i("1834");t["a"]={getRoomTypeDiagramList:function(e){var t="select rdp.id,rdp.coordinate,rdp.position_id,rdp.diagram_id from roomtype_diagram_partition rdp              inner join batch_room br on br.room_type_id = rdp.roomtype_id              inner join position p on p.id = rdp.position_id             where br.id = ?";return o["a"].query(t,[e])},hasRoomTypeDiagram:function(e){var t="select count(rdp.id) as count from roomtype_diagram_partition rdp              inner join batch_room br on br.room_type_id = rdp.roomtype_id              where br.id = ? and rdp.coordinate <> ''";return o["a"].queryOne(t,[e]).then((function(e){return e.count>0}))},isPositionInDiagram:function(e,t){return o["a"].exists("roomtype_diagram_partition",{diagram_id:e,position_id:t})},getHasPartitionByDiagramId:function(e){return o["a"].exists("roomtype_diagram_partition",{diagram_id:e})}}},d42a:function(e,t,i){"use strict";i("6d57");var o=i("fd50"),n=i("1834"),r=i("0938"),a=i("9430"),s=i("c6e3"),c=i("28c8"),d=i("a405");t["a"]={saveDeliveryInfo:function(e,t){var i,u,m,_,l,p={"顺利收楼":"delivery","先收楼后处理":"process_after_delivery","暂不收楼":"delivery_after_process","先拒收后收楼":"reject_then_receive"},f=function(e,t,i){var o=[];return e&&e.length&&e.forEach((function(e){o.push({batch_unit_id:t,batch_id:i,dimension_id:e.id,value:e.value,source:"app"})})),o};return s["a"].getRoomParams(e).then((function(s){if(!s||!s.batch_id||!s.batch_unit_id)return console.error("saveDeliveryInfo：未找到对应房间信息。batchRoomId:"+e),o["a"].reject("未找到对应房间信息");var h=!1;return n["a"].transaction((function(o){_=f(t.satisfactionList,s.batch_unit_id,s.batch_id),delete t.satisfactionList,l=t.delivery_items,delete t.delivery_items,t.delivery_date=r["a"].getNowDate(),"暂不收楼"===t.delivery_situation&&(m={delivery_date:t.delivery_date,delivery_status:t.delivery_status,delivery_situation:t.delivery_situation});var n=m||t;n.assess_customer_status="待评价",o.update("batch_room",n,{id:e},(function(n){if(!n.rowsAffected)throw console.error("saveDeliveryInfo：未更新对应房间。batchRoomId:"+e),new Error("未更新对应房间");if(a["a"].existsRoomDeliveryData(o,e,"delivery_after_process",(function(){o.update("batch_room",{first_delivery_situation:t.delivery_situation,first_delivery_date:t.delivery_date},{id:e})}),(function(){o.update("batch_room",{first_delivery_situation:t.delivery_situation,first_delivery_date:t.delivery_date},{id:e,first_delivery_situation:""})})),u=p[t.delivery_situation],!u)throw console.error("saveDeliveryInfo：delivery_situation 枚举值无效"),new Error("delivery_situation 枚举值无效");a["a"].deleteRoomDeliveryData(o,e),d["a"].deleteRoomDeliveryRejection(o,e),i={type:"房间",operation:u,relation_id:e,batch_unit_id:s.batch_unit_id,batch_room_id:e,batch_id:s.batch_id},a["a"].insert(o,i),h=!0,"delivery_after_process"==u&&d["a"].insert(o,e,{batch_unit_id:s.batch_unit_id,reason:t.reason,remark:t.remark,created_by_name:t.created_by_name})})),c["a"].saveRoomSatisfactionValue(o,e,_),l&&l.length&&l.forEach((function(t){t.value&&o.update("batch_room_delivery_item",{value:t.value},{id:t.id,batch_room_id:e})}))})).then((function(){h&&window.uploadStatus("waitUpload")}))}))},saveReviewInfo:function(e,t){var i,c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return s["a"].getRoomParams(e).then((function(s){if(!s||!s.batch_id||!s.batch_unit_id)return console.error("saveReviewInfo：未找到对应房间信息。batchRoomId:"+e),o["a"].reject("未找到对应房间信息");var d=!1;return n["a"].transaction((function(o){if(t.delivery_status="已交付",t.review_date=r["a"].getNowDate(),o.update("batch_room",t,{id:e},(function(t){if(!t.rowsAffected)throw console.error("saveReviewInfo：未更新对应房间。batchRoomId:"+e),new Error("未更新对应房间");i={type:"房间",operation:"reviewed",relation_id:e,batch_unit_id:s.batch_unit_id,batch_room_id:e,batch_id:s.batch_id},a["a"].insert(o,i),d=!0})),c&&c.length){var u,m=["id","batch_room_id","batch_unit_id","type","img_localpath","sort"],_=1;o.delete("batch_room_images",{batch_room_id:e}),c.forEach((function(t){if(t.localPath){var c={};c.id=r["a"].uuid(),c.batch_room_id=e,c.batch_unit_id=s.batch_unit_id,c.type="review",c.img_localpath=t.localPath,c.sort=_,u=n["a"].getColumnsValues(c,m),o.insert("batch_room_images",m,u),_++,i={type:"房间",operation:"add_review_image",relation_id:e,batch_unit_id:s.batch_unit_id,batch_room_id:e,batch_id:s.batch_id},a["a"].insert(o,i),d=!0}}))}})).then((function(){d&&window.uploadStatus("waitUpload")}))}))},changeToProcessFromDelivered:function(e,t){var i=function(t){t.update("batch_room",{delivery_status:"交付中",delivery_situation:"先收楼后处理"},{id:e.batch_room_id,delivery_status:"已交付",delivery_situation:"顺利收楼"},(function(i){i.rowsAffected&&a["a"].changeToProcessFromDelivered(t,e)}))};if(!t)return n["a"].transaction((function(e){i(e)}));i(t)},saveReceiveInfo:function(e,t){var i,d,u="receive",m=function(e,t,i){var o=[];return e&&e.length&&e.forEach((function(e){o.push({batch_unit_id:t,batch_id:i,dimension_id:e.id,value:e.value,source:"app"})})),o};return s["a"].getRoomParams(e).then((function(s){if(!s||!s.batch_id||!s.batch_unit_id)return console.error("saveReceiveInfo：未找到对应房间信息。batchRoomId:"+e),o["a"].reject("未找到对应房间信息");var _=!1;return n["a"].transaction((function(o){d=m(t.satisfactionList,s.batch_unit_id,s.batch_id),delete t.satisfactionList,t.opening_status="已接待",t.opening_receive_date=r["a"].getNowDate(),o.update("batch_room",t,{id:e},(function(t){if(!t.rowsAffected)throw console.error("saveReceiveInfo：未更新对应房间。batchRoomId:"+e),new Error("未更新对应房间");i={type:"房间",operation:u,relation_id:e,batch_unit_id:s.batch_unit_id,batch_room_id:e,batch_id:s.batch_id},a["a"].insert(o,i),_=!0})),c["a"].saveRoomSatisfactionValue(o,e,d)})).then((function(){_&&window.uploadStatus("waitUpload")}))}))}}},d485:function(e,t,i){"use strict";i("cc57");var o=i("fd50"),n=i("c2c1"),r=i("bbed"),a=i("a324"),s=i("97ba"),c=i("760e"),d=i("c6e3"),u=function(e,t,i,n){var r=[a["a"].getProblemList(e,t,i,n),c["a"].getDescByBathRoomId(e)];return o["a"].all(r).then((function(e){for(var t=e[0],i=e[1],o=0;o<t.length;o++){var n=t[o],r=_(i,n.desc_id);n.desc=n.remark?r+"；"+n.remark:r,n.isShow=!0}return t}))},m=function e(t,i,o,n){if(!i)return"";n=n||"";for(var r=0;r<t.length;r++){var a=t[r];if(a.item_id.toLowerCase()==i.toLowerCase()&&a.position_id.toLowerCase()==o.toLowerCase())return n=a.item_name+(n?"-":"")+n,a.parent_item_id?e(t,a.parent_item_id,o,n):n}return n},_=function(e,t){if(!t)return"";for(var i="",o=0;o<e.length;o++){var n=e[o];t.toLowerCase().indexOf(n.id.toLowerCase())>-1&&(i+=n.name+"；")}return i=i.indexOf("；")?i.substr(0,i.length-1):i,i},l=function(e){return e.unshift({position_id:"",position_name:"全部"}),e},p=function(e){return e.unshift({item_id:"",item_name:"全部"}),e},f=function(e){return a["a"].getProblemCountByBatchRoomId(e)};t["a"]={getPositionList:function(e){return s["a"].getPositionList(e).then((function(e){return l(e)}))},getTopCheckItemList:function(e,t,i){var o="毛坯"==i;return r["a"].getTopCheckItemList(e,t,o).then((function(e){return p(e)}))},getProblemList:u,getCheckItemString:m,getRoomIsReceived:function(e){return d["a"].getRoomIsReceived(e).then((function(e){return e}))},getProblemCount:f,getProblemFiltersCache:function(e){return n["a"].getProblemFilters(e)},updateProblemFiltersCache:function(e,t){return n["a"].updateProblemFilters(e,t)}}}}]);