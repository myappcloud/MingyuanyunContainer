(window["webpackJsonp_module_entry_zhkf_"]=window["webpackJsonp_module_entry_zhkf_"]||[]).push([["chunk-2fc0af8b"],{"1b3a":function(e,o,t){"use strict";t("f0e6"),t("e697");var r=t("fd50"),n=t("a18c"),i=t("a593"),a=t("43ee"),c=t("d49d"),d=t("af4c"),s=t("a14a"),u=t.n(s),_=function(){var e={},o={allSelected:!1,nextRoomId:"",nextRoom:{},roomName:"",currPage:0,totalPage:0,list:[],filterList:[]},t=!1,s={},_=20;return e.getConditions=function(){var e={batchRoomId:s.id};return u.a.each(o.filterList,(function(o){e[o.type]=o.id})),e.position||(e.checkItem=""),e},e.setFilter=function(e,o,t){var r=u.a.find(e,{id:o});r||(r={id:o,name:t,count:0},e.push(r)),r.count++},e.setAllFilter=function(e){var o=0;u.a.each(e,(function(e){o+=e.count})),e.unshift({id:"",name:"全部",count:o})},e.getFilter=function(t){var r=e.getConditions(),n=[];return!r[t]&&(t=""),c["a"].getFeedbackFilters(r,t).then((function(e){if(u.a.each(o.filterList,(function(r,i){if(e[r.type]||t===r.type){var a=o.filterList[i].value||"";if(r&&e[r.type]){var c=u.a.filter(e[r.type],{id:a});c&&c[0]&&n.push(c[0].count),o.filterList[i].options=e[r.type]}}else r.id="",r.name="",r.options=[]})),n.length){var r=Math.min.apply(null,n);o.totalPage=Math.ceil(r/_)}console.log(o.filterList)}))},e.getFeedbackList=function(t){var r=e.getConditions(),n=t?0:o.currPage*_;return c["a"].getFeedbackListByBatchRoomId(r,n,_).then((function(e){o.list=n?o.list.concat(e):e,o.currPage++}))},e.getNextRoom=function(){t=!1;var e=s.id,r=[];u.a.each(a["a"].model.list,(function(e){r=r.concat(e.roomList)}));var n=u.a.find(r,{id:e}),i=u.a.indexOf(r,n);i<0?(o.nextRoomId="",o.nextRoom=""):i==r.length-1?(o.nextRoomId="",o.nextRoom="",r[i-1]||(t=!0)):(o.nextRoomId=r[i+1].id,o.nextRoom=r[i+1])},e.init=function(t){return t=t||!1,!t&&a["a"].model.currRoom&&a["a"].model.currRoom.id===s.id?r["a"].resolve():(o.allSelected=!1,o.nextRoomId="",o.nextRoom={},o.roomName="",o.list=[],o.currPage=0,o.totalPage=0,o.filterList=[{id:"",name:"",label:"部位",type:"position",options:[]},{id:"",name:"",label:"检查项",type:"checkItem",options:[]}],s=a["a"].model.currRoom,e.getFeedbackList(!0).then((function(){return o.roomName=a["a"].model.unitName+"-"+s.room_no,o.roomName=o.roomName.length>16?"..."+o.roomName.substr(o.roomName.length-16,16):o.roomName,e.getNextRoom(),e.getFilter()})))},e.toNextRoom=function(){return a["a"].model.currRoom=o.nextRoom,o.roomName=a["a"].model.unitName+"-"+o.nextRoom.room_no,o.roomName=o.roomName.length>16?"..."+o.roomName.substr(o.roomName.length-16,16):o.roomName,i["default"].$comComps.toast.show("查验下一个房间 "+o.roomName,3e3),e.init()},e.refresh=function(t){!u.a.isArray(t)&&(t=[t]),console.log(t,"------ids====",o.list);var r=e.getConditions(),n=t.length;return o.list.length-n<=0||o.allSelected?e.init(!0):(o.allSelected=!1,u.a.each(t,(function(e){var t=u.a.find(o.list,{id:e});t&&(o.list=o.list.filter((function(e){return e!==t})))})),c["a"].getFeedbackFilters(r).then((function(e){u.a.each(e,(function(t,r){var n=u.a.find(o.filterList,{type:r});if(n){n.options=e[r];var i=u.a.find(n.options,{id:n.id});u.a.isEmpty(i)&&(n.id="",n.name="")}}))})))},e.resetPage=function(){o.currPage=0,o.totalPage=0,o.allSelected=!1},{model:o,currFeedback:{},init:e.init,getFeedbackList:e.getFeedbackList,getFilter:e.getFilter,getConditions:e.getConditions,resetPage:e.resetPage,toNextRoom:e.toNextRoom,refresh:function(a,u){var _=arguments.length>2&&void 0!==arguments[2]&&arguments[2];u=u||!1;var m=-1;return _&&m--,c["a"].hasMoreFeedback(s.id).then((function(c){if(!c&&o.nextRoomId)return n["a"].go(m),e.toNextRoom();if(c)return n["a"].go(m),e.refresh(a);if(d["a"].model.currFloor&&d["a"].model.currFloor.roomList.length-1){var s=d["a"].model,u=s.batchUnitId,_=s.moduleType;return d["a"].init(u,_,!0).finally((function(){m--,n["a"].go(m)}))}return m-=2,n["a"].go(m),t&&(i["default"].$comComps.toast.show("恭喜，该楼栋已回复完毕",2e3),e.init(!0)),r["a"].resolve()})).then((function(){u&&d["a"].updateRoomList()}))},loadMore:function(){return o.currPage<o.totalPage?e.getFeedbackList():r["a"].resolve()},getSelected:function(){var t=[],n=r["a"].defer();if(o.allSelected){var i=e.getConditions();c["a"].getAllFeedbackIds(i).then((function(e){u.a.each(e,(function(e){t.push(e.id)})),n.resolve(t)}))}else u.a.each(o.list,(function(e){e.selected&&t.push(e.id)})),n.resolve(t);return n.promise}}};o["a"]=_()},"43ee":function(e,o,t){"use strict";t("c904");var r=t("fd50"),n=t("a14a"),i=t.n(n),a=t("d49d"),c=function(){var e={unitId:"",list:[],currRoom:{}},o={getRoomList:function(){return a["a"].getRoomList(e.unitId).then((function(o){var t=[];if(console.log(o),o){var r=i.a.groupBy(o,"floor");console.log(r),i.a.each(r,(function(e,o){var r={};r.floor=o,r.roomList=[],r.no=o,console.log(e),i.a.each(e,(function(e){r.roomList.push({id:e.id,room_no:e.room_no,count:e.count})})),r.roomList=r.roomList.sort((function(e,o){return o.room_no-e.room_no})),t.push(r)})),t=t.sort((function(e,o){return o.no-e.no})),e.list=t}}))}};return{model:e,initRoomList:function(t,n){return t||e.unitId?(e.list=[],t&&(e.unitId=t),n&&(e.currRoom={}),o.getRoomList()):r["a"].reject("无效的单元")},refresh:function(){return o.getRoomList()},checkHasUpload:function(e){return a["a"].checkHasUpload(e)}}};o["a"]=c()},"7ee1":function(e,o,t){"use strict";var r=t("1834");o["a"]={getList:function(){var e="select * from problem_reason_config order by sort";return r["a"].query(e)},getProblemReason:function(e){var o="select reason_id from problem_reason where checkroom_problem_id = ?";return r["a"].queryColumn(o,[e],"reason_id")},getProblemReasonInfo:function(e){var o="select prc.reason as reason from problem_reason pr  inner join problem_reason_config prc on prc.id = pr.reason_id where pr.checkroom_problem_id = ? order by prc.sort";return r["a"].queryColumn(o,[e],"reason")}}},"964e":function(e,o,t){"use strict";t("cc57"),t("f548"),t("e204"),t("6d57"),t("9a33");var r=t("fd50"),n=t("07a4"),a=t("a14a"),c=t.n(a),d=t("a324"),s=t("1834"),u=t("0938"),_=t("9430"),m=t("a210"),l=t("d42a"),f=t("a654"),h=t("a740"),p=function(e,o){var t,r,n=1;e.delete("problem_images",{problem_id:o.id}),o.problem_images&&o.problem_images.length&&(t=["id","problem_id","business_id","batch_unit_id","type","img_localpath","sort"],o.problem_images.forEach((function(i){i.id=o.id+"_"+n,i.problem_id=o.id,i.business_id="",i.batch_unit_id=o.batch_unit_id,i.type="rectify_before",i.sort=n,r=s["a"].getColumnsValues(i,t,["business_id"]),e.insert("problem_images",t,r),n++})))},g=function(e,o,t){o.regist_user_id=Object(h["j"])().user_id||"";var r=["id","proj_id","batch_id","batch_room_id","batch_unit_id","room_id","building_id","position_id","top_item_id","item_id","desc_id","contractor_id","responsible_company_id","sent_back_time","roomtype_diagram_id","coordinate","status","emergency_degree","remark","regist_date","regist_user_id","is_passed_when_add"],n=["roomtype_diagram_id","coordinate","top_item_id","remark","contractor_id","responsible_company_id","is_passed_when_add"];o.regist_date=u["a"].getNowDate(),o.status=o.status||"待派单";var i=s["a"].getColumnsValues(o,r,n);e.insert("checkroom_problem",r,i)},b=function(e,o){var t={type:"问题",operation:"add",relation_id:o.id,batch_unit_id:o.batch_unit_id,batch_room_id:o.batch_room_id,batch_id:o.batch_id};_["a"].insert(e,t)},y=function(e,o,t){var r=["id","checkroom_problem_id","reason_id"];e.delete("problem_reason",{checkroom_problem_id:o}),t.forEach((function(t){e.insert("problem_reason",r,[u["a"].uuid(),o,t])}))},v={addProblem:function(e,o,t,r){return v.batchAddProblem([e],o,t,"",r)},batchAddProblem:function(e,o,t,r,n,i,a,c){var v,k;return n=n||[],s["a"].transaction((function(c){for(var s=0;s<e.length;s++){k=e[s],k.id=u["a"].uuid(),p(c,k),g(c,k,t),r&&f["a"].addDesignChangeProblem(k.id,r),y(c,k.id,n),b(c,k),k.is_passed_when_add&&d["a"].passProblemExec(k,c);var P={problem_id:k.id,batch_unit_id:k.batch_unit_id,operate_type:"新增"};m["a"].insert(P,c),"feedbackRemainReply"===i&&c.update("batch_room_material_feedback",{status:"已转派",reply_date:u["a"].getNowDate(),replied_by:Object(h["j"])().user_id,ref_business_id:k.id},{id:a},(function(e){if(!e.rowsAffected)throw console.error("saveShootRoomInfo：未更新对应新增转派。batchRoomId:"+k.batch_room_id),new Error("未更新对应房间");v={type:"素材",operation:"add_material_feedback",relation_id:a,batch_unit_id:k.batch_unit_id,batch_room_id:k.batch_room_id,batch_id:k.batch_id},_["a"].insert(c,v)}))}"验房"===o&&c.update("batch_room",{is_checked:1,check_date:u["a"].getNowDate(),check_engineer:Object(h["j"])().user_id},{id:k.batch_room_id,is_checked:0},(function(e){e.rowsAffected&&(v={type:"房间",operation:"check",relation_id:k.batch_room_id,batch_unit_id:k.batch_unit_id,batch_room_id:k.batch_unit_id,batch_id:k.batch_id},_["a"].insert(c,v))})),l["a"].changeToProcessFromDelivered(k,c)})).then((function(){window.uploadStatus("waitUpload")}))},editProblem:function(e,o){return s["a"].transaction((function(t){var r;p(t,e),r=c.a.cloneDeep(e),delete r.id,delete r.batch_building_id,delete r.batch_unit_id,delete r.batch_room_id,delete r.problem_images,delete r.is_passed_when_add_old,delete r.coordinate,delete r.roomtype_diagram_id,t.update("checkroom_problem",r,{id:e.id}),y(t,e.id,o),e.is_passed_when_add_old&&!e.is_passed_when_add?d["a"].unDoPassProblemExecByEdit(e.id,t):!e.is_passed_when_add_old&&e.is_passed_when_add&&d["a"].passProblemExec(e,t)}))},updateImageLocalPath:function(e,o,t){return s["a"].update("problem_images",{img_localpath:t},{problem_id:e,img_url:o})}},k=v,P=t("760e"),R=t("fe97"),L=t("c6e3"),I=t("af93"),w=t("7ee1"),E={getUserInfo:function(e){var o="select u.id, u.name, u.mobile from user as u where u.id = ?";return s["a"].queryOne(o,[e])}},j=t("dd0a"),C=t("0523"),N=t("8ae6"),F=t("1b3a"),x=t("af4c"),U=function(e){var o=[],t=e.item_id,n=e.batch_room_id,i=e.desc_id;if(i){for(var a=i.split(";"),d=[],s=0;s<a.length;s++)d.push(j["a"].getContractorBySingleDesc(n,t,a[s]));return r["a"].all(d).then((function(e){return e.forEach((function(e){var t=c.a.findIndex(o,{contractor_id:e.contractor_id});if(t>=0)o[t].desc_ids.push(e.desc_id);else{var r=[];r.push(e.desc_id);var n={contractor_id:e.contractor_id,contractor_name:e.contractor_name,desc_ids:r};o.push(n)}})),o.forEach((function(e){e.desc_ids=e.desc_ids.join(";")})),o}))}return j["a"].getContractor(n,t).then((function(e){return o.push({contractor_id:e.contractor_id,contractor_name:e.contractor_name,desc_ids:""}),o}))},T=function(e,o){var t=e.coordinate,n=r["a"].defer(),a=[];if(e.contractor_id.split(";").length>1)U(e).then((function(r){if(t.length>0){for(var c=function(n){r.forEach((function(r){a.push({problem_images:e.problem_images,batch_room_id:e.batch_room_id,position_id:e.position_id,item_id:e.item_id,top_item_id:e.top_item_id,desc_id:r.desc_ids,contractor_id:r.contractor_id,responsible_company_id:r.contractor_id,roomtype_diagram_id:e.roomtype_diagram_id,coordinate:JSON.stringify(t[n]),emergency_degree:e.emergency_degree,remark:e.remark,batch_unit_id:o.batch_unit_id,batch_id:o.batch_id,proj_id:o.project_id,building_id:o.building_id,room_id:o.room_id,sent_back_time:0,is_passed_when_add:e.is_passed_when_add})}))},d=0;d<t.length;d++)c(d);n.resolve(a)}else r.forEach((function(r){a.push({problem_images:e.problem_images,batch_room_id:e.batch_room_id,position_id:e.position_id,item_id:e.item_id,top_item_id:e.top_item_id,desc_id:r.desc_ids,contractor_id:r.contractor_id,responsible_company_id:r.contractor_id,roomtype_diagram_id:e.roomtype_diagram_id,coordinate:JSON.stringify(t[i]),emergency_degree:e.emergency_degree,remark:e.remark,batch_unit_id:o.batch_unit_id,batch_id:o.batch_id,proj_id:o.project_id,building_id:o.building_id,room_id:o.room_id,sent_back_time:0,is_passed_when_add:e.is_passed_when_add})})),n.resolve(a)}));else{if(t.length>0)for(var c=0;c<t.length;c++)a.push({problem_images:e.problem_images,batch_room_id:e.batch_room_id,position_id:e.position_id,item_id:e.item_id,top_item_id:e.top_item_id,desc_id:e.desc_id,contractor_id:e.contractor_id,responsible_company_id:e.responsible_company_id,roomtype_diagram_id:e.roomtype_diagram_id,coordinate:JSON.stringify(t[c]),emergency_degree:e.emergency_degree,remark:e.remark,batch_unit_id:o.batch_unit_id,batch_id:o.batch_id,proj_id:o.project_id,building_id:o.building_id,room_id:o.room_id,sent_back_time:0,is_passed_when_add:e.is_passed_when_add});else e.batch_unit_id=o.batch_unit_id,e.batch_id=o.batch_id,e.proj_id=o.project_id,e.building_id=o.building_id,e.room_id=o.room_id,e.sent_back_time=0,a=[e];n.resolve(a)}return n.promise},S={addProblem:function(e,o){var t=e&&e.batch_room_id;if(!t)throw new Error("batch_room_id 为空");return d["a"].getProblemParams(t).then((function(r){if(!r||!r.length)throw console.error("addProblem：未找到房间相关数据。batch_room_id="+t),new Error("未找到batch_room_id相关数据");var n=r[0];return e.batch_unit_id=n.batch_unit_id,e.batch_id=n.batch_id,e.proj_id=n.project_id,e.building_id=n.building_id,e.room_id=n.room_id,e.sent_back_time=0,k.addProblem(e,n.type,o)})).then((function(){"todo"===n["a"].state.app.global.currentMenuType&&x["a"].updateRoomList()}))},batchAddProblem:function(e,o,t,r){r=r||[];var i=e&&e.batch_room_id;if(!i)throw new Error("batch_room_id 为空");return d["a"].getProblemParams(i).then((function(n){if(!n||!n.length)throw console.error("addProblem：未找到房间相关数据。batch_room_id="+i),new Error("未找到batch_room_id相关数据");return T(e,n[0]).then((function(a){return k.batchAddProblem(a,n[0].type,o,t,r,e.problemType,e.feedbackId,i)}))})).then((function(){"todo"===n["a"].state.app.global.currentMenuType&&("feedbackRemainReply"===e.problemType?F["a"].refresh(e.feedbackId,!0,!Array.isArray(e.feedbackId)):x["a"].updateRoomList())}))},processEditProblem:function(e,o,t){t=t||[];var n=r["a"].defer(),i=U(e);return i.then((function(i){if(i)if(i.length<2)S.editProblem(e,t).then((function(){n.resolve()}));else{var a=c.a.cloneDeep(e),d=i[0];e.contractor_id=d.contractor_id,e.desc_id=d.desc_ids,e.responsible_company_id=d.contractor_id;var s=[];s.push(S.editProblem(e,t));for(var u=[],_=[],m=1;m<i.length;m++)u.push(i[m].contractor_id),_=_.concat(i[m].desc_ids.split(";"));if(a.contractor_id=u.join(";"),a.desc_id=_.join(";"),a.responsible_company_id=a.contractor_id,a.coordinate){var l=[];l.push(JSON.parse(a.coordinate)),a.coordinate=l}s.push(S.batchAddProblem(a,o,t)),r["a"].all(s).then((function(){n.resolve()}))}})),n.promise},editProblem:function(e,o){o=o||[];var t=e&&e.batch_room_id;if(!t)throw new Error("batch_room_id 为空");return d["a"].getProblemParams(t).then((function(r){if(!r||!r.length)throw console.error("editProblem：未找到房间相关数据。batch_room_id="+t),new Error("未找到batch_room_id相关数据");var n=r[0];return e.batch_unit_id=n.batch_unit_id,e.batch_id=n.batch_id,k.editProblem(e,o)}))},isLocal:function(e){return d["a"].isLocal(e).then((function(e){return r["a"].resolve(!!e)}))},getProblem:function(e){return d["a"].getProblemInfo(e).then((function(o){var t=o,r=t.desc_id.replace(/\;/g,"','").toLowerCase(),n=t.responsible_company_id.replace(/\;/g,"','").toLowerCase();return P["a"].getDescByIds(r).then((function(e){var o=[],r=0;c.a.each(e,(function(e){o.push(e.name),r+=e.is_remark_required})),t.desc=o.join("；"),t.isRemarkRequired=r?1:0})).then((function(){return m["a"].getProblemSentBackLogInfo(e).then((function(e){t.sent_back_log_info=e}))})).then((function(){return R["a"].getContractorByIds(n).then((function(e){var o=[];c.a.each(e,(function(e){o.push(e.name)})),t.responsible_company_name=o.join("；")}))})).then((function(){return w["a"].getProblemReasonInfo(e).then((function(e){t.reasons=e}))})).then((function(){return R["a"].getProjectContractorLeaderId(t.proj_id,t.contractor_id).then((function(e){e&&e.id&&(t.projectContractorLeaderId=e.id)}))})).then((function(){return t}))}))},backProblem:function(e,o,t,r){var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[];return d["a"].backProblem(e,o,t,r,n)},passProblem:function(e,o,t){return d["a"].passProblem(e,o,t)},batchPassRoomProblem:function(e,o){var t=[];return e.forEach((function(e){t.push(d["a"].passProblem(e,o))})),r["a"].all(t)},batchBackProblem:function(e,o,t,n){var i=[];return e.forEach((function(e){i.push(d["a"].backProblem(e,o,n,t))})),r["a"].all(i)},abnormalCloseProblem:function(e){return e&&e.batch_room_id?L["a"].getRoomParams(e.batch_room_id).then((function(o){return o?(e.batch_unit_id=o.batch_unit_id,e.batch_id=o.batch_id,d["a"].abnormalCloseProblem(e)):(console.error("abnormalCloseProblem: 未获取到房间信息。batch_room_id="+e.batch_room_id),r["a"].reject("未获取到房间信息"))})):(console.error("abnormalCloseProblem: 参数错误。problem="+JSON.stringify(e)),r["a"].reject("参数错误"))},isPositionInDiagram:function(e,o){return I["a"].isPositionInDiagram(e,o)},updateImageLocalPath:function(e,o,t){return k.updateImageLocalPath(e,o,t)},countProblemOptions:function(e,o,t,r,n,i){if(o&&t&&r){var a,c,d,s={},u={},_={};if(o.forEach((function(e){s[e]=0})),t.forEach((function(e){var o=""==e.position_id?e.position_name:e.position_id;u[o]=0})),r.forEach((function(e){var o=""==e.item_id?e.item_name:e.item_id;_[o]=0})),e&&e.length&&e.length>0)e.forEach((function(e){a=e.status,c=e.position_id,d=e.item_id,c!==n.position&&""!=n.position||!(""===n.item||i&&d==n.item||!i&&e.top_item_id==n.item)||o.forEach((function(e){"所有状态"==e?s[e]++:"常用状态"!=e||"待派单"!=a&&"待整改"!=a&&"已整改"!=a&&"已通过"!=a?a==e&&s[e]++:s["常用状态"]++})),!(""===n.item||i&&d==n.item||!i&&e.top_item_id==n.item)||n.status!=a&&"所有状态"!=n.status&&("常用状态"!=n.status||"待派单"!=a&&"待整改"!=a&&"已整改"!=a&&"已通过"!=a)||t.forEach((function(e){""==e.position_id?u[e.position_name]++:c==e.position_id&&u[c]++})),n.status!=a&&"所有状态"!=n.status&&("常用状态"!=n.status||"待派单"!=a&&"待整改"!=a&&"已整改"!=a&&"已通过"!=a)||c!==n.position&&""!=n.position||r.forEach((function(e){""==e.item_id?_[e.item_name]++:d==e.item_id&&_[d]++}))}));return{status:s,position:u,item:_}}},createPoints:function(e,o,t){if(e.length>0)for(var r=0;r<e.length;r++){var n="",i=e[r],a=i.coordinate?JSON.parse(i.coordinate):{};switch(i.status){case"待派单":n="#bb33ee";break;case"待整改":n="#ff4545";break;case"已整改":n="#0099ff";break;case"已通过":n="#0bc666";break;case"已作废":n="#888888";break;case"非正常关闭":n="#000000";break}i.color=n,i.x=a.x,i.y=a.y,i.position_id=o||i.position_id,t.push(i)}},filterDiagramData:function(e){var o=[],t=[],r=e.diagram_partition;if(r.length>0)for(var n=0;n<r.length;n++){var i=JSON.parse(r[n].coordinate);i.x&&i.y?o.push({x:i.x,y:i.y,w:i.width,h:i.height,id:r[n].position_id}):o.push({coordinate:i,id:r[n].position_id}),S.createPoints(r[n].problem_list,r[n].position_id,t)}return{diagramImg:"dev"==APP_ENV?e.diagram_url:N["a"].getImageRealPath(e.diagram_localpath),areas:o,points:t}},getProblemPositionPointInfo:function(e){var o;return d["a"].getProblemPositionPointInfo(e).then((function(t){if(!t)throw new Error("未找到问题 "+e);return o=t,C["a"].getDiagramFullPathById(o.roomtype_diagram_id)})).then((function(e){return o.room_type_image_path=e,o}))},getUserInfo:function(e){return E.getUserInfo(e).then((function(e){return e}))},canDisplayProblemPositionPoint:function(e){return S.getProblemPositionPointInfo(e).then((function(e){return e.room_type_image_path?!!e.coordinate||(console.warn("不显示户型图: 问题无位置点"),!1):(console.warn("不显示户型图: 无户型图本地路径"),!1)})).catch((function(){return console.warn("不显示户型图: 获取异常"),!1}))},getWatermarkText:function(){var e=Object(h["j"])().user_name,o=Object(u["d"])();return"".concat(e," ").concat(o," 拍摄")}};o["a"]=S},"99ee":function(e,o,t){"use strict";t("c904");var r=t("fd50"),n=t("a14a"),i=t.n(n),a=t("ff29"),c=function(){var e={unitId:"",list:[],currRoom:{}},o={getRoomList:function(){return a["a"].getRoomList(e.unitId).then((function(o){var t=[];if(console.log(o),o){var r=i.a.groupBy(o,"floor");console.log(r),i.a.each(r,(function(e,o){var r={};r.floor=o,r.roomList=[],r.no=o,console.log(e),i.a.each(e,(function(e){r.roomList.push({id:e.id,room_no:e.room_no,count:e.count})})),r.roomList=r.roomList.sort((function(e,o){return o.room_no-e.room_no})),t.push(r)})),t=t.sort((function(e,o){return o.no-e.no})),e.list=t}}))}};return{model:e,initRoomList:function(t,n){return t||e.unitId?(e.list=[],t&&(e.unitId=t),n&&(e.currRoom={}),o.getRoomList()):r["a"].reject("无效的单元")},refresh:function(){return o.getRoomList()},checkHasUpload:function(e){return a["a"].checkHasUpload(e)}}};o["a"]=c()},af4c:function(e,o,t){"use strict";t("e697");var r=t("fd50"),n=t("a18c"),i=t("99ee"),a=t("43ee"),c=t("a14a"),d=t.n(c),s=t("c6e3"),u=function(){return{getNotCheckFloorAndRoom:function(e,o){return r["a"].all([s["a"].getTodoUnitFloors(e),s["a"].getTodoRoomByUnitId(e,o)]).then((function(e){var o,t=e[0],r=e[1],n="0";(d.a.isEmpty(t)||1===t.length&&""===t[0].floor)&&(o=!0,t=[{floor:n}]);for(var i=0;i<t.length;i++){t[i].roomList=[];for(var a=0;a<r.length;a++)(o||r[a].floor===t[i].floor)&&(r[a].floor=o?n:r[a].floor,t[i].roomList.push(r[a]))}return d.a.filter(t,(function(e){return e.roomList&&e.roomList.length>0}))}))},checkHasUpload:function(e,o){return s["a"].checkHasUpload(e,o).then((function(e){return e&&!!e["id"]}))},getRoomInfo:function(e,o){return s["a"].getTodoBatchRoomById(e,o)}}},_=u(),m=function(){var e={floorList:[]},o={},t={special_checkitem:"检查",simulate:"检查",opening:"接待",online_opening:"拍摄",feedback_remain_reply:"回复",delivery:"交付",online_delivery:"交付",problem_remain_reinspect:"复验"};return o.init=function(t,n,i){return i=i||!1,i||t!==e.batchUnitId||n!==e.moduleType?(e.floorList=[],e.batchUnitId=t,e.moduleType=n,e.currRoom=null,e.currFloor=null,e.tip="",o.getRoomList().then((function(o){console.log(o,"floorlist-----"),e.floorList=o}))):r["a"].resolve()},o.getRoomList=function(){return"problem_remain_reinspect"===e.moduleType?o.getReinspectRoomList():"feedback_remain_reply"===e.moduleType?o.getReplyRoomList():o.getCheckRoomList()},o.getCheckRoomList=function(){return _.getNotCheckFloorAndRoom(e.batchUnitId,e.moduleType).then((function(o){return d.a.isEmpty(o)&&_.checkHasUpload(e.batchUnitId,e.moduleType).then((function(o){o&&(e.tip="您已经"+t[e.moduleType]+"完毕，请立即上传~")})),o}))},o.getReinspectRoomList=function(){return i["a"].initRoomList(e.batchUnitId).then((function(){return d.a.isEmpty(i["a"].model.list)&&i["a"].checkHasUpload(e.batchUnitId).then((function(o){o&&(e.tip="您已经"+t[e.moduleType]+"完毕，请立即上传~")})),i["a"].model.list}))},o.getReplyRoomList=function(){return a["a"].initRoomList(e.batchUnitId).then((function(){return d.a.isEmpty(a["a"].model.list)&&a["a"].checkHasUpload(e.batchUnitId).then((function(o){o&&(e.tip="您已经"+t[e.moduleType]+"完毕，请立即上传~")})),a["a"].model.list}))},o.getRoomInfo=function(e,o){return _.getRoomInfo(e,o)},o.removeRoom=function(){var t=d.a.find(e.currFloor.roomList,{id:e.currRoom.id}),r=d.a.indexOf(e.currFloor.roomList,t);r>-1&&e.currFloor.roomList.splice(r,1),d.a.isEmpty(e.currFloor.roomList)&&(r=d.a.indexOf(e.floorList,e.currFloor),r>-1&&e.floorList.splice(r,1)),d.a.isEmpty(e.floorList)&&(o.init(e.batchUnitId,e.moduleType,!0),n["a"].go(-2))},{model:e,init:o.init,updateRoomList:function(n){return d.a.isEmpty(e)||!e.moduleType?r["a"].resolve():(n=n||!1,n?o.removeRoom():"problem_remain_reinspect"===e.moduleType?i["a"].refresh().then((function(){d.a.isEmpty(i["a"].model.list)&&i["a"].checkHasUpload(e.batchUnitId).then((function(o){o&&(e.tip="您已经"+t[e.moduleType]+"完毕，请立即上传~")})),e.floorList=i["a"].model.list})):"feedback_remain_reply"!==e.moduleType?o.getRoomInfo(e.currRoom.id,e.moduleType).then((function(t){if(d.a.isEmpty(t)||"已检查"===t.check_status)return o.removeRoom();for(var r=e.currFloor.roomList.length,n=0;n<r;n++)if(e.currFloor.roomList[n].id===t.id){e.currFloor.roomList[n]=t;break}})):(d.a.isEmpty(a["a"].model.list)&&a["a"].checkHasUpload(e.batchUnitId).then((function(o){o&&(e.tip="您已经"+t[e.moduleType]+"完毕，请立即上传~")})),void(e.floorList=a["a"].model.list)))}}};o["a"]=m()},d49d:function(e,o,t){"use strict";var r=t("fd50"),n=t("4325"),i=t("a14a"),a=t.n(i),c=function(){var e={},o={position:n["a"].getPositionFilter,checkItem:n["a"].getCheckItemFilter};return e.getRoomList=function(e){return n["a"].getReplyRooms(e)},e.getFeedbackListByBatchRoomId=function(e,o,t){return e.batchRoomId?n["a"].getFeedbackListByBatchRoomId(e,o,t).then((function(e){return e})):r["a"].reject("获取问题列表失败")},e.getFeedbackFilters=function(e,t){if(!e.batchRoomId)return r["a"].reject();var n=a.a.cloneDeep(o),i=[];return delete n[t],e.position||delete n.checkItem,a.a.each(n,(function(t,r){i.push(function(t){return o[r](e).then((function(e){return{type:t,options:e}}))}(r))})),r["a"].all(i).then((function(e){var o={};return a.a.each(e,(function(e){var t=0;a.a.each(e.options,(function(e){t+=e.count})),e.options.unshift({name:"全部",count:t,id:""}),o[e.type]=e.options})),o}))},e.hasMoreFeedback=function(e){return n["a"].getFeedbackCount(e).then((function(e){return e.count>0}))},e.getAllFeedbackIds=function(e){return n["a"].getAllFeedbackIds(e).then((function(e){return e}))},e.checkHasUpload=function(e){return n["a"].hasUploadData(e).then((function(e){return e&&!!e["id"]}))},e};o["a"]=c()},dd0a:function(e,o,t){"use strict";t("e697"),t("6d57"),t("9a33");var r=t("fe97"),n=t("fd50"),i=t("a14a"),a=t.n(i),c=function(e){return r["a"].getProjectContractor(e)},d=function(e,o,t){var i=n["a"].defer();return r["a"].getContractor(e,o,t).then((function(e){if(e){var o=e;o.desc_id=t,i.resolve(o)}else{var r={contractor_id:"",contractor_name:"",desc_id:t};i.resolve(r)}})),i.promise},s=function(e,o,t){var i=[];if(t&&-1!=t){for(var c=t.split(";"),s=[],u=0;u<c.length;u++)s.push(d(e,o,c[u]));return n["a"].all(s).then((function(e){return e&&e.forEach((function(e){e&&e.contractor_id&&(a.a.find(i,{contractor_id:e.contractor_id})||i.push(e))})),i}))}return r["a"].getContractor(e,o).then((function(e){return e}))},u=function(e,o){return r["a"].getProjectContractorList(e,o)},_=function(e,o,t,n){return r["a"].changeConstruction(e,o,t,n)};o["a"]={getContractorList:c,getContractor:s,getContractorBySingleDesc:d,getProjectContractorList:u,changeConstruction:_}},fe97:function(e,o,t){"use strict";t("163d");var r=t("1834"),n=t("fd50"),i=t("a14a"),a=t.n(i),c=function(e){for(var o=arguments.length,t=new Array(o>1?o-1:0),r=1;r<o;r++)t[r-1]=arguments[r];t.length>0?console.log("[repositories]/construction-repostory.js：",e,t):console.log("[repositories]/construction-repostory.js：",e)},d=function(e,o){var t="select leader_id as id from project_contractor pc where pc.proj_id = ? and pc.contractor_id = ? ";return r["a"].queryOne(t,[e,o])},s=function(e,o){var t='select distinct cc.id contractor_id,cc.name contractor_name from checkroom_problem cr join project_contractor pc on pc.proj_id=cr.proj_id join contractor cc on pc.contractor_id=cc.id where cr.id = ? and cc.name like "%" || ? || "%" order by cc.sort';return r["a"].query(t,[e,o])},u=function(e,o,t,i){a.a.isArray(e)&&(e=e.join("','"));var c="update checkroom_problem set contractor_id = ?, responsible_company_id = ? where id in ('"+e+"')";return r["a"].executeSql(c,[o,o]).then((function(o){var t="select id, batch_unit_id, batch_room_id, batch_id from checkroom_problem where id in ('"+e+"')";return r["a"].query(t).then((function(){return n["a"].resolve(!0)})).catch((function(e){return n["a"].reject(e)}))}))},_=function(e){var o="select distinct cc.id contractor_id,cc.name contractor_name from batch_room br join checkroom_batch cb on br.batch_id=cb.batch_id join project_contractor pc on pc.proj_id=cb.project_id join contractor cc on pc.contractor_id=cc.id where br.id = ? order by cc.sort";return r["a"].query(o,[e])},m=function(e,o,t){var n,i=null,a="";return n="select building_id,unit,floor,room_id,is_virtual from batch_room where id = ?",r["a"].queryOne(n,[e]).then((function(d){if(!d)throw new Error("未找到当前房间."+e);if(!d.building_id)throw new Error("未找到当前房间的楼栋."+e);return i=d,a=1===Number(i.is_virtual)?"公区":"标准房间",n='select range.contractor_id, contractor.name contractor_name            from construction_range range           inner join contractor on range.contractor_id = contractor.id           where ( range.desc_id = ? or ( range.item_id = ? and (desc_id = "" or desc_id is null) ) )           and range.building_id = ?           and  range.room_id = ?            order by desc_id desc ',c("1. 寻找匹配的承建商 - _getContractor","modeCondition=".concat(a),"check_item_id=".concat(o),"check_desc_id=".concat(t),"rangeInfo",i),r["a"].queryOne(n,[t,o,i.building_id,i.room_id])})).then((function(e){return e||(c("2. 指定房间没找到，查找楼层范围"),n='select range.contractor_id, contractor.name contractor_name              from construction_range range             inner join contractor on range.contractor_id = contractor.id             where ( range.desc_id = ? or ( range.item_id = ? and (desc_id = "" or desc_id is null) ) )             and range.building_id = ?             and range.unit = ?             and range.floor = ?             and mode in ("全部", ? )             and (range.room_id = "" or range.room_id is null)             order by (CASE mode WHEN "指定房间" THEN 1 WHEN "全部" THEN 3 ELSE 2 END), range.desc_id desc ',r["a"].queryOne(n,[t,o,i.building_id,i.unit,i.floor,a]))})).then((function(e){return e||(c("3. 楼层范围没找到，查找单元范围"),n='select range.contractor_id,contractor.name contractor_name              from construction_range range             inner join contractor on range.contractor_id = contractor.id             where ( range.desc_id = ? or ( range.item_id = ? and (desc_id = "" or desc_id is null) ) )             and range.building_id = ?             and range.unit = ?             and mode in ("全部", ? )             and (range.floor = "" or range.floor is null)             and (range.room_id = "" or range.room_id is null)             order by (CASE mode WHEN "指定房间" THEN 1 WHEN "全部" THEN 3 ELSE 2 END), range.desc_id desc ',r["a"].queryOne(n,[t,o,i.building_id,i.unit,a]))})).then((function(e){return e||(c("4. 单元范围没找到，查找楼栋范围"),n='select range.contractor_id,contractor.name contractor_name              from construction_range range             inner join contractor on range.contractor_id = contractor.id             where ( range.desc_id = ? or ( range.item_id = ? and (desc_id = "" or desc_id is null) ) )             and range.building_id = ?             and mode in ("全部", ?)              and (range.unit = "" or range.unit is null)             and (range.floor = "" or range.floor is null)             and (range.room_id = "" or range.room_id is null)             order by (CASE mode WHEN "指定房间" THEN 1 WHEN "全部" THEN 3 ELSE 2 END), range.desc_id desc ',r["a"].queryOne(n,[t,o,i.building_id,a]))})).then((function(e){return c("- 检查项/问题描述自动匹配的承建商：",e),e}))};o["a"]={getContractor:m,getProjectContractor:_,getProjectContractorList:s,changeConstruction:u,getProjectContractorLeaderId:d,getContractorByIds:function(e){a.a.isArray(e)&&(e=e.join("','"));var o="select id, name  from contractor  where id in ('".concat(e,"')  order by sort");return r["a"].query(o)}}},ff29:function(e,o,t){"use strict";t("cc57"),t("e697"),t("9a33");var r=t("fd50"),n=t("4531"),i=t("760e"),a=t("a14a"),c=t.n(a),d=function(){var e={},o={position:n["a"].getPositionFilter,checkItem:n["a"].getCheckItemFilter,register:n["a"].getRegisterFilter};return e.getRoomList=function(e){return n["a"].getReinspectRooms(e)},e.getProblemListByBatchRoomId=function(e,o,t){return e.batchRoomId?n["a"].getProblemListByBatchRoomId(e,o,t).then((function(e){var o=[];return c.a.each(e,(function(e){e.desc=e.desc_id.split(";"),o=o.concat(e.desc)})),o=c.a.uniq(o),i["a"].getDescByIds(o).then((function(o){return c.a.each(e,(function(e){c.a.each(e.desc,(function(t,r){var n=c.a.find(o,{id:t});e.desc[r]=n?n.name:"无描述"})),e.desc=e.desc.join("；"),e.title=e.problem=e.position_name+"-"+e.item_name+"-"+e.desc+(e.remark?"；"+e.remark:"")})),e}))})):r["a"].reject("获取问题列表失败")},e.getProblemFilters=function(e,t){if(!e.batchRoomId)return r["a"].reject();var n=c.a.cloneDeep(o),i=[];return delete n[t],e.position||delete n.checkItem,c.a.each(n,(function(t,r){i.push(function(t){return o[r](e).then((function(e){return{type:t,options:e}}))}(r))})),r["a"].all(i).then((function(e){var o={};return c.a.each(e,(function(e){var t=0;c.a.each(e.options,(function(e){t+=e.count})),e.options.unshift({name:"全部",count:t,id:""}),o[e.type]=e.options})),o}))},e.hasMoreProblem=function(e){return n["a"].getProblemCount(e).then((function(e){return e.count>0}))},e.getAllProblemIds=function(e){return n["a"].getAllProblemIds(e).then((function(e){return e}))},e.checkHasUpload=function(e){return n["a"].hasUploadData(e).then((function(e){return e&&!!e["id"]}))},e};o["a"]=d()}}]);