(window["webpackJsonp_module_entry_zhkf_"]=window["webpackJsonp_module_entry_zhkf_"]||[]).push([["chunk-633ded00"],{"0e4a":function(t,e,n){"use strict";n("5f54"),n("6d57");var a=n("a2ee"),o=n("01e5"),s=n("a38a"),r=n("c6e3"),u=n("fd50");e["a"]={getAllTag:function(){return a["a"].getAllTag().then((function(t){return _.isEmpty(t)?[]:t}))},getCustomerTag:function(t){return a["a"].getCustomerTag(t,"tag_id").then((function(t){if(_.isEmpty(t))return[];var e=[];return t.forEach((function(t){e.push(t.tag_id)})),e}))},getCustomerAssess:function(t){return s["a"].getCustomerAssess(t).then((function(t){return _.isEmpty(t)?"":t["remark"]}))},upsertCustomerTags:function(t,e,n){return e=e||[],n=n||[],t?_.isEmpty(e)&&_.isEmpty(n)?u["a"].resolve():a["a"].upsertCustomerTags(t,e,n):u["a"].reject("缺少客户id")},addCustomerTagDataIncrement:function(t){return a["a"].addCustomerTagDataIncrement(t)},upsertCustomerAssess:function(t,e){return t&&e?s["a"].upsertCustomerAssess(t,e):u["a"].reject("缺少客户id或评价说明")},addCustomerAssessDataIncrement:function(t){return s["a"].addCustomerAssessDataIncrement(t)},getRoomCustomerInfo:function(t){return o["a"].getCustomersByRoomId(t).then((function(t){var e=[],n=[];return t.forEach((function(t){e.push(function(t){var e=t.customer_id;return console.log(e),u["a"].all([a["a"].getCustomerTagInfo(e),s["a"].getCustomerAssess(e)]).then((function(e){console.log("results",Object.assign({},e[0])),n.push({customerName:t.customer_name,customerPhone:t.customer_phone,tags:e[0]||[],remark:e[1]&&e[1]["remark"]?e[1]["remark"]:""})}))}(t))})),u["a"].all(e).then((function(){return n}))}))},updateRoomAssessStatus:function(t,e){return r["a"].updateRoomAssessStatus(t,e)},hasTags:function(){return a["a"].hasTags().then((function(t){return t&&!!t["id"]}))}}},"7d89":function(t,e,n){e=t.exports=n("690e")(!1),e.push([t.i,"\n.zhkf .customer-tag[data-v-cc0d669c] {\n  height: 100%;\n  display: -webkit-box;\n  display: -ms-flexbox;\n  display: flex;\n  -webkit-box-orient: vertical;\n  -webkit-box-direction: normal;\n      -ms-flex-direction: column;\n          flex-direction: column;\n}\n.zhkf .customer-tag .tag-list[data-v-cc0d669c] {\n    -webkit-box-flex: 1;\n        -ms-flex: 1;\n            flex: 1;\n    overflow: scroll;\n}\n.zhkf .customer-tag .tag-list .box[data-v-cc0d669c] {\n      background: #fff;\n      margin-bottom: 10px;\n}\n.zhkf .customer-tag .tag-list .box .box-header[data-v-cc0d669c] {\n        padding: 15px;\n        font-size: 15px;\n        color: #606060;\n}\n.zhkf .customer-tag .tag-list .box .box-header .name[data-v-cc0d669c] {\n          color: #000;\n}\n.zhkf .customer-tag .tag-list .box .box-content[data-v-cc0d669c] {\n        padding: 20px 15px 0 15px;\n        display: -webkit-box;\n        display: -ms-flexbox;\n        display: flex;\n        -ms-flex-wrap: wrap;\n            flex-wrap: wrap;\n}\n.zhkf .customer-tag .tag-list .box .box-content .tag[data-v-cc0d669c] {\n          height: 28px;\n          line-height: 26px;\n          text-align: center;\n          border-radius: 14px;\n          border: 1px solid #dddddd;\n          color: #a0a0a0;\n          padding: 0 12px;\n          margin-right: 10px;\n          margin-bottom: 20px;\n}\n.zhkf .customer-tag .tag-list .box .box-content .tag__active[data-v-cc0d669c] {\n            color: #0085ff;\n            background: #e5f4ff;\n            border: 1px solid #0085ff;\n            color: #0085ff;\n}\n.zhkf .customer-tag .btn[data-v-cc0d669c] {\n    background: #0085ff;\n    color: #fff;\n    height: 45px;\n    text-align: center;\n    line-height: 45px;\n    font-size: 16px;\n}\n",""])},c721:function(t,e,n){"use strict";n.r(e);n("6d57"),n("f0e6");var a=n("bdbb"),o=n("fd50"),s=n("0e4a"),r=n("3fa2"),u=n("01e5"),c={getCustomer:function(t){return u["a"].getCustomersByRoomId(t).then((function(t){return _.isEmpty(t)?[]:t}))}},i=n("a593"),m=n("a14a"),d=n.n(m);function f(){var t={},e={getRoomCustomer:function(){return c.getCustomer(r["a"].room.id).then((function(e){e.forEach((function(e){i["default"].prototype.$set(t.customers,e.customer_id,{customerId:e.customer_id,customerName:e.customer_name,customerPhone:e.customer_phone,tags:null,remark:""})}))}))},load:function(){return s["a"].getAllTag().then((function(e){t.tagList=e;var n=[];return d.a.each(t.customers,(function(e,a){n.push(function(e){return s["a"].getCustomerTag(e).then((function(n){return t.customers[e].tags=n,s["a"].getCustomerAssess(e).then((function(n){t.customers[e].remark=n}))}))}(a))})),o["a"].all(n).then((function(){t.defaultCustomers=d.a.cloneDeep(t.customers)}))}))},upsert:function(){var e=[],n=[];return d.a.each(t.customers,(function(a,o){var r=d.a.difference(a.tags,t.defaultCustomers[o].tags),u=d.a.difference(t.defaultCustomers[o].tags,a.tags);e.push(s["a"].upsertCustomerTags(o,r,u)),a.remark!=t.defaultCustomers[o].remark&&n.push(s["a"].upsertCustomerAssess(o,a.remark))})),o["a"].all(e).then((function(){return s["a"].addCustomerTagDataIncrement(r["a"].room)})).then((function(){if(n.length)return o["a"].all(n).then((function(){return s["a"].addCustomerAssessDataIncrement(r["a"].room)}))})).then((function(){r["a"].room.canTag=!1,i["default"].prototype.$eventBus.$emit("app.roomdetail:statusChange"),s["a"].updateRoomAssessStatus(r["a"].room.batchRoomId,"已评价")}))}};return{model:t,init:function(){return t.tagList=[],t.customers={},t.defaultCustomers={},e.getRoomCustomer().then((function(){if(!d.a.isEmpty(t.customers))return e.load()}))},upsert:function(){return e.upsert().then((function(){t.defaultCustomers=d.a.cloneDeep(t.customers)}))}}}var l=f(),g=n("438a"),h={name:"CustomerTag",components:{textBox:a["a"],emptyPage:g["a"]},data:function(){return{model:{},remark:"",checkNum:0,pageLoading:!1}},created:function(){this.initData()},methods:{initData:function(){var t=this;this.pageLoading=!0,l.init().finally((function(){var e=l.model;d.a.each(e.customers,(function(e,n){var a={};e.tags&&e.tags.forEach((function(e){a[e]=!0,t.checkNum+=1})),t.$set(e,"tagsMap",a)})),t.model=e,t.checkNum>0?t.canSubmit=!0:t.canSubmit=!1,t.pageLoading=!1})).catch((function(e){console.log(e),t.pageLoading=!1}))},clickTagBtn:function(t,e){t.tagsMap[e.id]?(this.$set(t.tagsMap,e.id,!1),this.checkNum-=1):(this.$set(t.tagsMap,e.id,!0),this.checkNum+=1),console.log(t),this.checkNum>0?this.canSubmit=!0:this.canSubmit=!1},updateRemark:function(t,e){console.log(t,e),e.remark=t,console.log(this.model)},submit:function(){var t=this;this.canSubmit?(this.canSubmit=!1,d.a.each(this.model.customers,(function(t,e){t.tags=[],d.a.each(t.tagsMap,(function(e,n){e&&t.tags.push(n)}))})),l.upsert().then((function(){t.canSubmit=!0,t.$router.go(-1)}))):this.$toast("请先进行客户评价")}}},p=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"customer-tag"},[n("cus-nav-bar",{attrs:{title:"客户","left-arrow":"",border:!1}}),t._v(" "),n("empty-page",{attrs:{"show-empty":t.pageLoading,"loading-page":!0,"empty-msg":"正在加载中，请耐心等待"}}),t._v(" "),t.model?n("div",{staticClass:"tag-list"},t._l(t.model.customers,(function(e,a){return n("div",{key:a,staticClass:"box"},[n("div",{staticClass:"box-header"},[t._v("\n        业主：\n        "),n("span",{staticClass:"name"},[t._v(t._s(e.customerName))])]),t._v(" "),n("div",{staticClass:"box-content van-hairline--top-bottom"},t._l(t.model.tagList,(function(a,o){return n("div",{key:o,class:e.tagsMap[a.id]?"tag tag__active":"tag",on:{click:function(n){return t.clickTagBtn(e,a)}}},[t._v(t._s(a.name))])})),0),t._v(" "),n("div",{staticClass:"box-footer"},[n("text-box",{attrs:{remark:e.remark,placeholder:"补充说明"},on:{input:function(n){return t.updateRemark(n,e)}}})],1)])})),0):t._e(),t._v(" "),n("div",{staticClass:"btn",on:{click:t.submit}},[t._v("提交")])],1)},b=[],x=n("d082");function v(t){n("e704")}var k=!1,C=v,y="data-v-cc0d669c",T=null,w=Object(x["a"])(h,p,b,k,C,y,T);e["default"]=w.exports},e704:function(t,e,n){var a=n("7d89");"string"===typeof a&&(a=[[t.i,a,""]]),a.locals&&(t.exports=a.locals);var o=n("85cb").default;o("39221c26",a,!0,{})}}]);