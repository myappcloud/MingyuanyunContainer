(window["webpackJsonp_module_entry_gcxt_"]=window["webpackJsonp_module_entry_gcxt_"]||[]).push([["chunk-816c1f1a"],{"10ab":function(t,e,a){"use strict";a("499d")},"225c":function(t,e,a){"use strict";a("ac67"),a("32ea"),a("0c84");var r=a("34f5"),i=(a("b3d7"),a("1bc7"),a("aa18"),a("982e"),a("0e2e")),n=(a("8dee"),a("c91b")),o=a("1f0e"),c=a("7bce"),s=a("fd50"),l=a("e200"),d=a("d832"),u=a("0909"),f=a("eb48"),h=a("8d62"),p=a("a262"),m=a("b0b4"),g=a("a740"),b=a("5bbb"),v=a("9a340"),y=a("244f"),_=a("82f8"),j=a("a075");function S(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,r)}return a}function O(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?S(Object(a),!0).forEach((function(e){Object(r["a"])(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):S(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}var D=function(){return{bizType:"",changeType:"",curBizConfig:null,detail:null,defaultSelectBizId:"",formData:null,relative_doc:{layouts:[],data:{}},result:{}}};e["a"]={keymap:n["a"],data:D(),getSheetLayoutCode:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",a="";return e&&(a=d["c"][decodeURIComponent(e||"")].menuCode),a?t.replace("{CHANGETYPE}",a.substr(12)):t},init:function(t){var e=this,a=t.bizType,r=t.changeType,n=t.sheetId,d=t.params,u=t.config,f=t.hooks;f=f||{},this.data=D(),this.data.bizType=a,this.data.changeType=r,this.data.curBizConfig=u;var h=this.data.curBizConfig.edit,g=Object(l["b"])(a);window.sysTime=j["a"].date.format(new Date,"yyyy-MM-dd"),Object(_["I"])().then((function(t){t&&t.data&&t.data.date&&(window.sysTime=t.data.date)}));var b=[],S=this.getSheetLayoutCode(h.formLayout,r);S&&b.push(S),h.relationLayout&&b.push(h.relationLayout),b=[].concat(Object(i["a"])(b),Object(i["a"])(h.subForms.map((function(t){var e=t.layoutId;return e}))),["relative_doc"]);var F=[o["c"].getLayout(b)];return n&&(this.sheetId=n,F.push(g.getDetail(n))),this.data.result=Object(p["b"])(),s["a"].all(F).then((function(t){var a,r=t[0];if(h.relationLayout){var i=r[h.relationLayout];e.data.result.relationLayout=i}if(r.relative_doc&&(e.data.result.relative_doc={layouts:r.relative_doc}),S){var s=r[S],l=o["c"].getLayoutData(S,s),d=l.formStyle,u=l.dataModel,p=l.layoutArr,m=l.relations,g=l.groupInfo,b=l.relativeFlow;for(var v in e.data.result.relativeFlow=b,e.data.formData={formStyle:d,dataModel:u,layoutArr:p,relations:m,groupInfo:g},f.afterLayoutRequest&&f.afterLayoutRequest(e.data.formData),o["c"].hackLayout(e.data.formData),u){var _=u[v];!e.data.defaultSelectBizId&&h.defaultSelectBizId.includes(v)&&(e.data.defaultSelectBizId=v),"date"!==_.type||"today"!==_.defaultValue||_.value||c["b"].setVal(_,window.sysTime)}}if(n&&(a=t[1],e.data.detail=a,e.data.result.relative_doc.data=y["a"].getValueObjByDetail(a)),S){var j=e.data.formData.dataModel;Object.values(j).forEach((function(t){a&&(a[t.unEditHasDetail]&&t.unEditHasDetail&&(t.enabled=0),a.history_id&&"selectBiz"===t.type&&t.id===e.data.defaultSelectBizId&&(t.enabled=0))}))}})).then((function(){if(S)for(var t in e.data.formData.dataModel)c["b"].setRelations(e.data.formData.dataModel[t],e.data.formData);return e.data.detail?e.initDraft(e.data.detail):e.initNew(d)})).then((function(t){e.data.detail&&"view"===e.data.formData.formStyle&&Object(m["b"])(O(O(O({},e.data.detail),e.data.detail.contract_info||{}),e.data.detail.project_info||{}),e.data.formData.dataModel,!0);var i=[];return h.subForms.forEach((function(t){var e=t.id,n=t.layoutId;i.push(v["a"].getSubFormSetting({layoutId:n,bizType:a,changeType:r}).then((function(t){return{id:e,res:t||{isEnable:!1}}})))})),Promise.all(i).then((function(e){var a=e.reduce((function(t,e){var a=e.id,r=e.res;return t[a]=r,t}),{});return t.subFormsSetting=a,t}))})).catch((function(t){console.warn(t)}))},initNew:function(t){t&&this.fillFormData(t,this.data.formData.dataModel);var e=this.data.result;return e.formData=this.data.formData,e.defaultSelectBizId=this.data.defaultSelectBizId,e},isProjectMode:function(){return!!this.data.curBizConfig.isProjectMode},initAfterFillForm:function(){},initDraft:function(t){var e=this,a=this.data.formData;null===a&&(a={dataModel:{}}),this.fillFormData(t,a.dataModel);var r=this.data.bizType,i=this.data.changeType,n=[],o=[];t.contract_info?n=Array.isArray(t.contract_info)?t.contract_info:[t.contract_info]:t.contract_info_list&&(n=t.contract_info_list),t.jzc_contract_info&&n.push(t.jzc_contract_info),n.length&&(o=n.map((function(t){return t.contract_id})));var c=this.data.result;c.imagesList=t.images||[],c.attachment.list=t.attachments||[],c.subFormsValues={},this.data.curBizConfig.edit.subForms.forEach((function(e){var a=e.id;"sub_form_jzc_confirm"===a?c.subFormsValues.sub_form_jzc_confirm=t.sub_form_jzc_confirm||t.sub_form_jzc_clapply.map((function(t){return O(O({},t),{},{pre_item_id:t.item_id,total:0})}))||[]:c.subFormsValues[a]=t[a]||[]})),c.ccList=t.cc_users||[];var l=null,d={biz_type:r,change_type:i};this.data.result.relativeFlow&&this.data.result.relativeFlow.role?l=this.data.result.relativeFlow.role.reduce((function(t,e){var r,i=a.dataModel[e];return"project_id"===e?(r=i.value||"",t[e]=r):(r=i.valueObj.map((function(t){return t.company_guid}))||[],t.company_guids=t.company_guids?t.company_guids.concat(r):r),t}),{}):this.isProjectMode()?d.project_id=t.project_id:d.contract=n;var u,f=this.refreshUsers(O({params:l},d));d={biz_type:r,change_type:i,detail:t},this.data.result.relativeFlow&&this.data.result.relativeFlow.station?l=this.data.result.relativeFlow.station.reduce((function(t,a){var r,i=e.data.formData.dataModel[a];return"project_id"===a?(r=i.value||"",t[a]=r):(r=i.valueObj.map((function(t){return t.company_guid}))||[],t.company_guids=t.company_guids?t.company_guids.concat(r):r),t}),{}):this.isProjectMode()?d.project_id=t.project_id:d.contract_id=o[0],u=this.isProjectMode()&&"tc_task_report"===this.data.curBizConfig.bizName?Promise.resolve():this.refreshSelectPeople(O({params:l},d),a.dataModel);var h={biz_type:r,change_type:i};this.isProjectMode()?h.project_id=t.project_id:h.contract_id=o[0];var p=this.getAttchmentSetting(h,a.dataModel,t);return s["a"].all([f,u,p]).then((function(r){return c.users=r[0],c.selectPeople=r[1],c.attachment.restrictSettings=r[2].setting,c.attachment.bakSetting=r[2].orgSetting,c.formData=a,c.contracts=n,c.defaultSelectBizId=e.data.defaultSelectBizId,c.detail=t,c.isProjectMode=e.isProjectMode(),c.project=t.project_info||null,c}))},fillFormData:function(t,e){var a=Object.values(e),r=[];a.forEach((function(e){var a=e.id;if("fq_date"!==a){var i=t[a];e=c["b"].setVal(e,i),e=Object(m["a"])(e,t),e.groupId&&r.push(e)}})),r.forEach((function(t){t.values=[e[t.groupId].value,t.value]}))},refreshUsers:function(t){var e=t.project_id,a=void 0===e?"":e,r=t.contract,i=void 0===r?null:r,n=t.biz_type,o=t.change_type,c=void 0===o?"":o,s=t.params,l=void 0===s?null:s;return l?f["b"].getUsersByProjectId(O(O({},l),{},{biz_type:n,change_type:c})):a?f["b"].getUsersByProjectId({project_id:a,biz_type:n,change_type:c}):f["b"].getUsersByContract(i)},refreshRecentlyUsers:function(t){var e=t.project_id,a=void 0===e?"":e,r=(t.contract,t.biz_type),i=t.change_type,n=void 0===i?"":i,o=t.params,c=void 0===o?null:o;if(c){var s=c.project_id||a;return f["b"].getRecentlyUsers({project_id:s,biz_type:r,change_type:n})}if(a)return f["b"].getRecentlyUsers({project_id:a,biz_type:r,change_type:n})},refreshSelectPeople:function(t,e){var a=this,r=t.contract_id,i=t.project_id,n=t.biz_type,o=t.change_type,c=t.detail,s=void 0===c?null:c,l=t.params;return f["b"].getSelectPeopleSetting({contract_id:r,project_id:i,biz_type:n,change_type:o,detail:s,params:l}).then((function(t){if(t.type===u["a"].Free)return t.selecteds=[],f["b"].FreeService.getSelecteds({contract_id:r,biz_type:n,change_type:o,detail:s}).then((function(e){return t.selecteds=e,t})).catch((function(t){t&&t.message&&console.error(t.message)}));t=a.refreshFixedFlow(t,e,s);var i=null;if(s){var c=f["b"].FixedService.getSelecteds({flows:t.flowInfo.flow,detail:s});c&&(i=Object.values(c).filter((function(t){return null!==t})).length?c:null)}return t.selecteds=i,t}))},getAttchmentSetting:function(t,e){var a,r=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return a=i&&i.history_id&&i.biz_attach_condition?i.biz_attach_condition.length?Promise.resolve(i.biz_attach_condition):Promise.resolve(h["a"].getAttchmentSettingByList(i.attachments||[])):h["a"].getAttchmentSetting(t,e),a.then((function(t){return r.refreshAttachmentSetting(t,e,i)}))},refreshAttachmentSetting:function(t,e){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;t=a&&a.history_id&&a.biz_attach_condition?t.map((function(t){return O(O({},t),{},{enable:!0})})):h["a"].setEnableByFormData(t,e);var r=h["a"].getAttachmentSettingByFlow(Object(b["a"])(t).filter((function(t){return t.enable})),[Object(g["a"])("station_name")],Object(g["a"])("station_name"));return{orgSetting:t,setting:r}},refreshFixedFlow:function(t,e){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return a&&a.history_id?t:f["b"].FixedService.transformFlowWithForm(t,e)}}},"499d":function(t,e,a){var r=a("8fcc");"string"===typeof r&&(r=[[t.i,r,""]]),r.locals&&(t.exports=r.locals);var i=a("85cb").default;i("3c26cec9",r,!0,{sourceMap:!1,shadowMode:!1})},"8fcc":function(t,e,a){e=t.exports=a("690e")(!1),e.push([t.i,".gcxt .components-wrapper[data-v-208047f2]{padding-bottom:20px}.gcxt .component-group[data-v-208047f2]{margin-bottom:10px}",""])},a262:function(t,e,a){"use strict";a.d(e,"b",(function(){return W}));var r=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("page",{directives:[{name:"phy-back",rawName:"v-phy-back",value:{status:"edit"===t.mode,method:"handleBackAction"},expression:"{ status: mode === 'edit', method: 'handleBackAction' }"}],class:"biz-page-"+t.config.bizName},[a("template",{slot:"header"},[a("v-header",{attrs:{title:t.title,"back-action":t.handleBackAction}})],1),t.data?a("div",{staticClass:"components-wrapper"},[t._l(t.comps,(function(e){return["ViewTemplate"===e&&t.viewTemplateList?a("view-template",{key:e,attrs:{list:t.viewTemplateList}}):"FormComp"===e&&t.formData?["view"===t.formData.formStyle?a("form-detail",{key:e,attrs:{"sheet-id":t.sheetId,sheet:t.detail,"layout-arr":t.formData.layoutArr,"group-info":t.formData.groupInfo,"data-model":t.formData.dataModel,"unlock-info":t.detail.unlock_info}}):a("form-comp",{key:e,ref:"edit_form",refInFor:!0,attrs:{data:t.formData,sheet:t.detail,"default-select-biz-id":t.defaultSelectBizId,mode:t.mode},on:{change:t.onChange,"change-select-biz":t.onSelectBiz}},[t._l(t.$slots,(function(e,a){return[t.formData.dataModel[a]?t._t(a,null,{slot:a}):t._e()]}))],2)]:"RelativeFieldGroup"===e&&t.relative_doc.layouts.length?a("relative-field-group",{key:e,ref:"RelativeFieldGroup",refInFor:!0,attrs:{layouts:t.relative_doc.layouts,data:t.relative_doc.data,"before-edit":t.reqNextStep,"sheet-id":t.detail&&t.detail.history_id?t.sheetId:""},on:{change:t.onRelativeFieldChange}}):"SubForms"===e?a("div",{key:e},[t._l(t.config.edit.subForms,(function(e){return[t.subFormsSetting[e.id]&&t.subFormsSetting[e.id].isEnable?a("sub-form",t._b({key:e.id,ref:e.id,refInFor:!0,attrs:{id:e.id,mode:"edit",data:t.subFormsValues[e.id]||[],"before-edit":t.reqNextStep,addable:"sub_form_jzc_confirm"!==e.id,deletable:"sub_form_jzc_confirm"!==e.id},on:{change:function(a){return t.onSubFormChange(e.id,a)}}},"sub-form",t.subFormsSetting[e.id],!1)):t._e()]}))],2):"UploadImages"===e?a("upload-images",{key:e,ref:"uploadImages",refInFor:!0,model:{value:t.imagesList,callback:function(e){t.imagesList=e},expression:"imagesList"}},[t.needUploadAttachment?a("span",{staticStyle:{color:"#f00"}},[t._v("\n          *有必须上传的其他类型的附件,请先保存为草稿再去电脑端上传。\n        ")]):t._e()]):"Attachment"===e?a("attachment",{key:e,ref:"attachments",refInFor:!0,attrs:{edit:!0,list:t.attachment.list,"restrict-settings":t.attachment.restrictSettings,"before-edit":t.reqNextStep}}):"SelectPeople"===e?a("select-people",{key:e,ref:"selectPeople",refInFor:!0,staticClass:"component-group",attrs:{type:t.selectPeople.type,users:t.users,selecteds:t.selectPeople.selecteds,"flow-info":t.selectPeople.flowInfo||null,"before-edit":t.reqNextStep,size:t.bizType===t.BizKeys.ANSWER_QUESTION?1:1/0}}):"UserSelector"===e?a("user-selector",{key:e,ref:"onlySelectPeople",refInFor:!0,attrs:{list:t.users,"selector-title":"选择抄送对象",label:"抄送",multi:!0,"show-search-btn":!0,"exclude-my-self":!0,"before-edit":t.reqNextStep,tip:t.bizType===t.BizKeys.TC_PROJECT_DAILY||t.bizType===t.BizKeys.TC_TASK_REPORT||t.bizType===t.BizKeys.TC_MEETING?"":"注：抄送对象不参与审批，但会收到该条流程的通知"},model:{value:t.ccList,callback:function(e){t.ccList=e},expression:"ccList"}}):a("div",{key:e},[t._t(e,null,{editData:t.$data,bindRef:function(a){return t.bindSlotRef(e,a)}})],2)]}))],2):t._e(),a("template",{slot:"footer"},[t._t("footer",[t.data&&!t.keyboardInfo.show?a("save-buttons",{ref:"SaveButtons",attrs:{"sheet-title":t.title,"biz-type":t.bizType,"change-type":t.changeType,"default-select-biz-id":t.defaultSelectBizId,detail:t.detail,"form-data":t.formData,"get-sheet-refs":t.getFormatRefs,"sheet-data":t.$data}}):t._e()])],2)],2)},i=[],n=(a("ac67"),a("32ea"),a("fc02"),a("c376")),o=(a("8dee"),a("0e2e")),c=(a("1bc7"),a("e5b4"),a("34f5")),s=(a("e680"),a("9a340")),l=a("d759"),d=a("fd50"),u=a("a740"),f=a("a075"),h=a("db68"),p=a("225c"),m=a("a783"),g=a("7bce"),b=a("5fe8"),v=a("933f"),y=a("9249"),_=a("3ec3"),j=a("1f8c"),S=a("69b8"),O=a("6892"),D=a("07fc"),F=a("7b41"),z=a("0909"),w=a("2655"),P=a("6280"),T=a("6413"),k=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("app-button-group",[a("app-button",{directives:[{name:"show",rawName:"v-show",value:!t.curbizConfig.edit.disableDraft,expression:"!curbizConfig.edit.disableDraft"}],staticClass:"action-button -draft",attrs:{plain:""},on:{click:function(){return t.save(!1)}}},[t._v("保存草稿")]),a("app-button",{staticClass:"action-button -sync",on:{click:function(){return t.save(!0)}}},[t._v("提交")])],1)},M=[],C=a("6c9f"),B=(a("aa18"),a("982e"),a("0ee4")),I=a("e200"),R=a("5bbb"),A=a("af76");function x(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,r)}return a}function E(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?x(Object(a),!0).forEach((function(e){Object(c["a"])(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):x(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}var L=function(t,e){if(t&&t[e]){for(var a=t[e],r=arguments.length,i=new Array(r>2?r-2:0),n=2;n<r;n++)i[n-2]=arguments[n];return a.bind.apply(a,[t].concat(i))}return function(){return{flag:!0,msg:""}}},U={name:"SaveButtons",props:{sheetTitle:{type:String},bizType:{type:Number},changeType:{type:String},formData:{type:Object,require:!0},defaultSelectBizId:{type:String,require:!0},detail:{type:Object,default:null},getSheetRefs:{type:Function,require:!0},sheetData:{type:Object,default:function(){}}},data:function(){return{saving:!1,show:!1}},computed:{mode:function(){return this.detail?"edit":"add"},curbizConfig:function(){return _["a"][this.bizType]},service:function(){return Object(I["b"])(this.bizType)}},methods:{save:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return e?v["a"].idkey(v["a"].idkeys.editClickSubmit):v["a"].idkey(v["a"].idkeys.editClickSaveDraft),this.saveObj(e).then((function(){t.saving=!1,t.$router.go(-1)})).catch((function(e){"string"===typeof e&&e.length?t.sui.toast(e):"string"===typeof e.message&&e.message.length&&t.sui.toast(e.message),t.saving=!1}))},saveObj:function(t){var e=this,a={biz_type:this.bizType,change_type:this.changeType,contract_info:{},formData:{},approver_ids:[],attachments:[],photos:[]};this.curbizConfig.edit.subForms.forEach((function(t){var e=t.id;a[e]=[]}));var r=this.defaultSelectBizId,i="",n="";if(r&&(i=this.formData.dataModel[r],n=i.value,!n))return d["a"].reject("请先选择".concat(i.label));if(t){var o=g["b"].validate(this.formData.dataModel,t?{req:1,format:1}:{req:0,reqOnSave:1}),c=o.result,s=o.msg,u=o.id,f=void 0===u?"":u;if(!c)return f&&this.locateErrorField(f),d["a"].reject(s)}var h=g["b"].getFormValuesForSave(this.formData.dataModel),p=function(t){var a=e.formData.dataModel[t];if(a.add){var r,i=a.valueObj.some((function(t,e){if(!t||!t.__validated)return r="请补充第".concat(e+1,"个").concat(a.label,"信息"),!0}));if(i)return{v:d["a"].reject(r)}}};for(var m in this.formData.dataModel){var v=p(m);if("object"===Object(B["a"])(v))return v.v}if(h.project_id&&Array.isArray(h.project_id)&&!h.project_id.length){var y=this.formData.dataModel.project_id.label;return d["a"].reject("请先选择".concat(y))}if(h.project_id&&Array.isArray(h.project_id)&&h.project_id.length>500)return d["a"].reject("您选择的项目数量超过500，无法".concat(t?"提交":"保存","。"));a.formData=h;var _=d["a"].resolve();return r&&!this.curbizConfig.isProjectMode&&("contract_id"!==r&&(_=Object(I["b"])(i.bizType).getDetail(n).then((function(t){return t.unlock_info&&t.unlock_info.is_sheet_timeout?(Object(A["a"])().openPopup({day:t.worksheet_completion_deadline}),d["a"].reject()):t.contract_id}))),_=_.then((function(t){return t=t||n,l["a"].getContract(t).then((function(t){if(![b["a"].PAYMENT,b["a"].OUTPUT_VALUE].includes(e.bizType)&&["已结算","结算"].includes(t.xt_js_state)){var r="合同已结算, 不能再发起"+e.sheetTitle;return d["a"].reject(r)}a.contract_info=t}))}))),_.then((function(){return e.doSave(a,t)}))},doSave:function(t,e){var a=this,r=this.getSheetRefs(),i=r.MeetingSelector,n=r.ReceiveSelector,o=r.attachments,c=r.uploadImages,s=r.selectPeople,u=this;function f(){if(o&&o.hasUploading())return{flag:!1,msg:"请等待附件上传完毕"};if(c&&c.hasUploading())return{flag:!1,msg:"请等待图片上传完毕"};if(t.receive_user_ids&&!t.receive_user_ids.length&&!t.receive_work_group_ids&&!t.receive_work_group_ids.length)return{flag:!1,msg:"责任人为必选项"};var a=[];if(e){if(s&&s.type===z["a"].Free&&0===t.approver_ids.length)return{flag:!1,msg:"请选择确认人"};u.curbizConfig.edit.subForms.forEach((function(t){var e=t.id;a.push(L(r[e],"validateRequirement"))})),a.push(L(c,"validateRequirement")),a.push(L(o,"validateRequirement",u.curbizConfig.edit.disableDraft||!1)),a.push(L(n,"validateRequirement")),a.push(L(i,"validateRequirement")),s&&("add"===u.mode||"edit"===u.mode&&u.detail&&!u.detail.history_id)&&a.push(L(s,"validateSelectPeople")),!t.contract_info||u.detail&&u.detail.history_id||a.push(l["a"].checkContractHasExpire.bind(null,t.contract_info,"add"))}for(var d in a){var f=a[d]();if(f&&!1===f.flag)return f}return{flag:!0,msg:""}}this.prepareData(t);var h=f(),p=h.flag,m=h.msg;return p?(this.saving=!0,this.exec(e,t).then((function(t){var r=t.data,i=t.param;console.log("提交返回数据:",{data:r,param:i});var n="已为你保存成草稿";return e&&(n="提交成功"),a.sui.toast(n)}))):d["a"].reject(m)},prepareData:function(t){"edit"===this.mode&&this.writeBack(t.formData,this.detail);var e=this.getSheetRefs();if(e.RelativeFieldGroup){var a=e.RelativeFieldGroup.getData();for(var r in a)t[r]=a[r]}if(e.attachments&&(t.attachments=Object(R["a"])(e.attachments.getData()),t.attach_condition=this.sheetData.attachment.bakSetting.filter((function(t){return t.enable})).map((function(t){t.attach_condition,t.enable;var e=Object(C["a"])(t,["attach_condition","enable"]);return E({},e)}))),e.uploadImages&&(t.photos=Object(R["a"])(e.uploadImages.data)),this.curbizConfig.edit.subForms.forEach((function(a){var r=a.id;e[r]&&(t[r]=Object(R["a"])(e[r].getData()))})),e.selectPeople&&(e.selectPeople.type===z["a"].Free?(delete t.formData.flow_type,delete t.flow,t.approver_ids=e.selectPeople.getFreeData()):t.flow=e.selectPeople.getFixedData()),e.onlySelectPeople&&(t.cc_user_ids=e.onlySelectPeople.selecteds.map((function(t){return t.user_id}))),e.ReceiveSelector){var i=e.ReceiveSelector.selecteds;t.receive_user_ids=i.filter((function(t){return t.user_id})).map((function(t){return t.user_id})),t.receive_work_group_ids=i.filter((function(t){return t.group_id})).map((function(t){return t.group_id}))}e.ConfirmSelector&&(console.log("sheetRefs.ConfirmSelector.selecteds",e.ConfirmSelector.selecteds),t.confirm_user_ids=e.ConfirmSelector.selecteds.filter((function(t){return t.user_id})).map((function(t){return t.user_id}))),e.MeetingSelector&&(t.invitee_user_ids=e.MeetingSelector.selecteds.map((function(t){return t.user_id})))},writeBack:function(t,e){var a=t;if(e){for(var r in e)a.hasOwnProperty(r)||"object"===Object(B["a"])(e[r])||0===r.indexOf("erp")||(a[r]=e[r]);return a}},exec:function(t,e){var a=this.service.buildSaveData(e);return a.issync=1,t&&(a.check_status="1"),this.service.saveDetail(a)},locateErrorField:function(t){var e=this.getSheetRefs().edit_form;if(e){var a=e.$refs.fieldWrapper.find((function(e){return e.id===t}));a&&(a.$el.scrollIntoView(),this.formData.dataModel[t].invalid=!0)}}}},$=U,N=a("5d22"),q=Object(N["a"])($,k,M,!1,null,null,null),V=q.exports,G=a("2bf9"),H=a("0fc6");function K(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,r)}return a}function J(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?K(Object(a),!0).forEach((function(e){Object(c["a"])(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):K(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}var W=function(){return{erpOptions:null,defaultSelectBizId:"",detail:null,relativeFlow:null,relationLayout:[],formData:null,imagesList:[],attachment:{list:[],restrictSettings:[],bakSetting:[]},users:[],recentlyUsers:{cc_users:[],receive_users:[],confirm_users:[],invitee_users:[]},selectPeople:{type:z["a"].Free},ccList:[],relative_doc:{layouts:[],data:{}}}},Y={name:"BusinessEdit",components:{FormComp:w["a"],FormDetail:G["a"],RelativeFieldGroup:j["a"],UploadImages:F["a"],SelectPeople:z["b"],Attachment:O["a"],UserSelector:P["a"],SubForm:S["a"],ApproveGroup:T["a"],viewTemplate:D["a"],SaveButtons:V},props:{comps:{type:Array,default:function(){return["ViewTemplate","FormComp","RelativeFieldGroup","SubForms","UploadImages","Attachment","SelectPeople","UserSelector"]}},data:{type:Object,default:null},mode:{type:String},config:{type:Object,default:function(){}},bizType:{type:Number},changeType:{type:String,default:""},pageTitle:{type:String,default:""}},data:function(){var t=this.config.edit.subForms.reduce((function(t,e){return t[e.id]={isEnable:!1},t}),{}),e=this.config.edit.subForms.reduce((function(t,e){return t[e.id]=[],t}),{});return m["a"].reset(),m["a"].bizType=this.bizType,m["a"].changeType=this.changeType,J(J({},W()),{},{viewTemplateList:null,subFormsSetting:t,subFormsValues:e,relativeDetail:null,store:m["a"],BizKeys:b["a"],extraRef:{}})},computed:{title:function(){return this.pageTitle||("add"===this.mode?"新增":"修改")+this.config.detail.getTitle(this.bizType,this.changeType)},contractIds:function(){return this.store.contracts.map((function(t){return t.contract_id}))},isProjectMode:function(){return!!this.config.isProjectMode},needUploadAttachment:function(){return!!(this.data.attachment&&this.data.attachment.restrictSettings&&this.data.attachment.restrictSettings.length)&&this.data.attachment.restrictSettings.some((function(t){return 1===t.is_must&&(!t.file_path||""===t.file_path)}))},sheetId:function(){return this.$route.query.id||""},curConfig:function(){return _["a"][this.bizType]},keyboardInfo:function(){return this.$store.state.device.keyboardInfo}},provide:function(){var t=this;return{importRef:function(e,a){t.extraRef[e]=a},getFormData:function(){return t.formData}}},watch:{data:{handler:function(t){var e=this;if(t){for(var a in t)a in this.$data&&(this[a]=t[a]),a in this.store&&(this.store[a]=t[a]);this.$nextTick((function(){e.execAllCompRelations()}))}},immediate:!0},contractIds:{handler:function(t){var e=this;t&&t.length&&l["a"].getContractTemplates({biz_type:this.bizType,change_type:this.changeType,contract_ids:t}).then((function(t){e.viewTemplateList=t}))},immediate:!0},erpOptions:function(t){for(var e in this.subFormsSetting)this.subFormsSetting[e].defaultForm&&s["a"].formatDefaultFormByErpOptions(this.subFormsSetting[e].defaultForm,t);if(this.formData&&this.formData.dataModel)for(var a in this.formData.dataModel){var r=this.formData.dataModel[a],i=r.defaultForm;i&&g["b"].fillErpOptions(t,r.defaultForm.dataModel)}},users:function(t){this.ccList=this.ccList.filter((function(e){return t.find((function(t){return e.user_id===t.user_id}))}))}},mounted:function(){window.businessEdit=this,this.init()},beforeDestroy:function(){y["a"].clear()},methods:{init:function(){var t=this,e=~this.comps.indexOf("SelectPeople"),a=function(e){if(t.data){var a={biz_type:t.bizType,change_type:t.changeType};if(t.isProjectMode){a.project_id=Object(H["a"])(e);var r=Array.isArray(a.project_id)&&a.project_id.length>1||Array.isArray(a.project_id)&&!a.project_id.length;if(t.curConfig.isTCMode&&r)return t.attachment.bakSetting=[],t.attachment.restrictSettings=[],t.$emit("refresh-attachment-setting",[]);if(!a.project_id)return t.attachment.bakSetting=[],t.attachment.restrictSettings=[],t.$emit("refresh-attachment-setting",[])}else a.contract_id=e[0].contract_id;p["a"].getAttchmentSetting(a,t.formData.dataModel,t.detail).then((function(e){var a=e.orgSetting,r=e.setting;t.attachment.bakSetting=a,t.attachment.restrictSettings=r,t.$emit("refresh-attachment-setting",r)}))}};this.$watch(this.isProjectMode?"store.project":"store.contracts",(function(t,e){a(t)}));var r=function(a){if(t.data){if(!t.relativeFlow||!t.relativeFlow.role){var r={biz_type:t.bizType,change_type:t.changeType};t.isProjectMode?r.project_id=Object(H["a"])(a):r.contract=a,p["a"].refreshUsers(r).then((function(e){t.users=e})),t.curConfig.isTCMode&&p["a"].refreshRecentlyUsers(r).then((function(e){t.recentlyUsers=e}))}if((!t.relativeFlow||!t.relativeFlow.station)&&e){var i={biz_type:t.bizType,change_type:t.changeType,detail:t.detail};t.isProjectMode?i.project_id=Object(H["a"])(a):i.contract_id=a[0].contract_id,p["a"].refreshSelectPeople(i,t.formData.dataModel).then((function(e){t.selectPeople=e}))}}};this.$watch(this.isProjectMode?"store.project":"store.contracts",r)},handlerRelativeFlow:function(t){var e=this,a=~this.comps.indexOf("SelectPeople"),r={};if(this.relativeFlow){var i={biz_type:this.bizType,change_type:this.changeType},n=this.relativeFlow,o=n.role,c=n.station;if(o&&o.some((function(e){return e===t.id}))){var s=o.reduce((function(t,a){var r,i=e.data.formData.dataModel[a];return"project_id"===a?(r=Array.isArray(i)?i.map((function(t){return t.value})):i.value||"",t[a]=r):(r=i.valueObj.map((function(t){return t.company_guid}))||[],t.company_guids=t.company_guids?t.company_guids.concat(r):r),t}),{});p["a"].refreshUsers(J({params:s},i)).then((function(t){e.users=t})),this.curConfig.isTCMode&&p["a"].refreshRecentlyUsers(J({params:s},i)).then((function(t){e.recentlyUsers=t}))}if(c&&c.some((function(e){return e===t.id}))&&a){var l=c.reduce((function(t,a){var r,i=e.data.formData.dataModel[a];return"project_id"===a?(r=Array.isArray(i)?i.map((function(t){return t.value})):i.value||"",t[a]=r):(r=i.valueObj.map((function(t){return t.company_guid}))||[],t.company_guids=t.company_guids?t.company_guids.concat(r):r),t}),{});p["a"].refreshSelectPeople(J({params:l},i),this.formData.dataModel).then((function(t){e.selectPeople=t})),r.handleringBranchFlow=!0}}return r},onChange:function(t,e,a){var r=this,i=!!~this.comps.indexOf("Attachment"),n=!!~this.comps.indexOf("SelectPeople"),o=this.handlerRelativeFlow(e),c=o.handleringBranchFlow,s=void 0!==c&&c;if(n&&!s&&e&&e.id&&this.selectPeople.type===z["a"].Fixed&&this.selectPeople.branches&&this.selectPeople.branches.deps.some((function(t){return t===e.id}))&&(this.selectPeople=p["a"].refreshFixedFlow(this.selectPeople,this.formData.dataModel,this.detail)),i&&e&&e.id!==this.defaultSelectBizId){var l=p["a"].refreshAttachmentSetting(this.attachment.bakSetting,this.formData.dataModel,this.detail),u=l.orgSetting,f=l.setting;this.attachment.bakSetting=u,this.attachment.restrictSettings=f}return d["a"].resolve().then((function(){r.$emit("form-change",t,e,a)}))},onRelativeFieldChange:function(t,e){this.relationLayout&&this.handlerCompRelations({ref:t,data:e}),g["b"].triggerAllRelations(this.formData)},onSubFormChange:function(t,e){this.relationLayout&&this.handlerCompRelations({ref:t,data:e}),g["b"].triggerAllRelations(this.formData)},reqNextStep:function(){var t=this.formData.dataModel[this.defaultSelectBizId],e=function(t){return"选择"===t.substr(0,2)?t.substr(2):t},a=!0;return t&&"project_id"===t.id&&Array.isArray(t.value)&&(a=!!t.value.length),!(t&&!t.value||!a)||(this.sui.toast("请先选择".concat(e(t.label)||"相关业务单据")),!1)},bindSlotRef:function(t,e){return this.$refs[t]=e,e},getFormatRefs:function(){var t={};for(var e in this.$refs){var a=this.$refs[e],r=Array.isArray(a)?a[0]:a;t[e]=r}return J(J({},t),this.extraRef)},onSelectBiz:function(t,e){var a=this,r=e.detail,i=e.erpOptions,n=e.contracts,o=e.project,c=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this.handlerRelativeFlow(t),this.selectBizHelper(t,{detail:r,erpOptions:i,contracts:n,project:o},c).then((function(){a.$emit("select-biz-change",t,{detail:r,erpOptions:i,contracts:n,project:o},c)})).then((function(){a.execAllCompRelations(),g["b"].triggerAllRelations(a.formData)}))},selectBizHelper:function(t,e,a){var r=this,i=e.detail,n=e.erpOptions,c=e.contracts,s=e.project;if(this.$route.query.params&&"add"===this.mode&&(a=!1),a)return i&&(this.relativeDetail=i),n&&(this.erpOptions=n),d["a"].resolve();var l=t.id;if(s&&(this.store.project=s),c&&(this.store.contracts=c,h["b"].store.setValue({cur_contract:c[0]})),n&&(this.erpOptions=n),i){"meeting_id"===l?this.imagesList=i.images||[]:(this.relativeDetail=i,i.images&&i.images.length&&(this.imagesList=i.images),i.sub_form_jzc_clapply&&this.bizType===b["a"].JZC_CONFIRM&&(i.sub_form_jzc_confirm=i.sub_form_jzc_clapply.map((function(t){return J(J({},t),{},{pre_item_id:t.item_id,total:0})}))),this.config.edit.subForms.forEach((function(t){var e=t.id;i[e]&&i[e].length&&(r.subFormsValues[e]=Object(o["a"])(i[e]))})));var p=f["a"].number.round(i.reviewed_cost||""),m=this.formData.dataModel.declaration_cost;m&&"1"!==Object(u["b"])().disable_declaration_cost&&(m.placeholder=p>=0?"变更审核金额"+p:"必填")}return n&&(this.erpOptions=n),d["a"].resolve()},handleBackAction:function(){var t=this;if(this.curConfig.edit.disableDraft)return v["a"].idkey(v["a"].idkeys.editClickNoSaveDraftByBack),this.$router.go(-1);var e=this.defaultSelectBizId,a="";this.formData&&this.formData.dataModel&&this.formData.dataModel[e]&&(a=this.formData.dataModel[e].value),"edit"===this.mode||a?this.sui.confirm({message:"是否保存为草稿？",confirmButtonText:"保存",cancelButtonText:"不保存"}).then((function(){return v["a"].idkey(v["a"].idkeys.editClickSaveDraftByBack),t.saveDraft()})).catch((function(){v["a"].idkey(v["a"].idkeys.editClickNoSaveDraftByBack),t.$router.go(-1)})):this.$router.go(-1)},saveDraft:function(){return this.$refs.SaveButtons.save(!1)},handlerCompRelations:function(t){var e=this,a=t.ref,r=void 0===a?"":a,i=t.data,o=void 0===i?null:i,c=t.zeroToEmpty,s=void 0!==c&&c,l={material_form:{ref:"material_item_list",valueObj:null}},d=function(t){if(l[t]||(l[t]={ref:t,valueObj:null}),l[t].valueObj)return l[t].valueObj;var a=null,i=l[t].ref,n=e.getFormatRefs();if(i===r)a=o;else switch(t){case"edit_form":a=g["b"].getFormValues(e.formData.dataModel);break;default:a=n[i].getData();break}return l[t].valueObj=a,a};this.relationLayout.forEach((function(t){var a=t.target_comp,i=t.target_id,o=t.calc_method,c=!1,u=!0,f=o.replace(/\[{(.+?)}\]|{{(.+?)}}/g,(function(t,e,a){var i="["===t.slice(0,1),o=i?e:a,s=o.split("."),f=Object(n["a"])(s,2),h=f[0],p=f[1],m=d(h);return""!==r&&r!==l[h].ref||(c=!0),null===m?(console.error("不合法表达式"),void(u=!1)):i?m.reduce((function(t,e){return t+=Number(e[p]),t}),0):m[p]}));if(c&&u){var h=null;try{var p=Function;h=+parseFloat(new p("return "+f)()).toPrecision(12)}catch(b){return void console.error(b)}switch(s&&0===h&&(h=""),a){case"edit_form":var m=e.formData.dataModel[i];m&&(g["b"].formatFieldForEdit(m,h),e.onChange(m.value,m));break}}}))},execAllCompRelations:function(){if(this.relationLayout){var t=this.getFormatRefs();for(var e in t){var a=t[e];a.isSubForm&&a.getData&&this.handlerCompRelations({ref:e,data:a.getData()})}}}}},Q=Y,Z=(a("10ab"),Object(N["a"])(Q,r,i,!1,null,"208047f2",null));e["a"]=Z.exports}}]);