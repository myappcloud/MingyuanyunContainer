(window["webpackJsonp_module_entry_gcxt_"]=window["webpackJsonp_module_entry_gcxt_"]||[]).push([["chunk-d1e08dcc"],{"0337":function(e,t,a){"use strict";a("2efc")},"225c":function(e,t,a){"use strict";a("5ab2"),a("e10e"),a("06a2");var r=a("28f8"),i=(a("de78"),a("6d57"),a("ed63"),a("8cf2"),a("4c09")),n=(a("f548"),a("c91b")),o=a("1f0e"),c=a("7bce"),s=a("fd50"),l=a("e200"),d=a("d832"),u=a("0909"),f=a("eb48"),h=a("8d62"),p=a("a262"),m=a("b0b4"),g=a("a740"),b=a("5bbb"),v=a("9a340"),y=a("244f"),_=a("82f8"),j=a("a075");function S(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function O(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?S(Object(a),!0).forEach((function(t){Object(r["a"])(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):S(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}var F=function(){return{bizType:"",changeType:"",curBizConfig:null,detail:null,defaultSelectBizId:"",formData:null,result:{}}};t["a"]={keymap:n["a"],data:F(),getSheetLayoutCode:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",a="";return t&&(a=d["c"][decodeURIComponent(t||"")].menuCode),a?e.replace("{CHANGETYPE}",a.substr(12)):e},init:function(e){var t=this,a=e.bizType,r=e.changeType,n=e.sheetId,d=e.params,u=e.config,f=e.hooks;f=f||{},this.data=F(),this.data.bizType=a,this.data.changeType=r,this.data.curBizConfig=u;var h=this.data.curBizConfig.edit,g=Object(l["b"])(a);window.sysTime=j["a"].date.format(new Date,"yyyy-MM-dd"),Object(_["G"])().then((function(e){e&&e.data&&e.data.date&&(window.sysTime=e.data.date)}));var b=[],S=this.getSheetLayoutCode(h.formLayout,r);S&&b.push(S),h.relationLayout&&b.push(h.relationLayout),b=[].concat(Object(i["a"])(b),Object(i["a"])(h.subForms.map((function(e){var t=e.layoutId;return t}))),["relative_doc"]);var D=[o["c"].getLayout(b)];return n&&(this.sheetId=n,D.push(g.getDetail(n))),this.data.result=Object(p["b"])(),s["a"].all(D).then((function(e){var a,r=e[0];if(h.relationLayout){var i=r[h.relationLayout];t.data.result.relationLayout=i}if(r.relative_doc&&(t.data.result.relative_doc={layouts:r.relative_doc}),S){var s=r[S],l=o["c"].getLayoutData(S,s),d=l.formStyle,u=l.dataModel,p=l.layoutArr,m=l.relations,g=l.groupInfo,b=l.relativeFlow;for(var v in t.data.result.relativeFlow=b,t.data.formData={formStyle:d,dataModel:u,layoutArr:p,relations:m,groupInfo:g},f.afterLayoutRequest&&f.afterLayoutRequest(t.data.formData),o["c"].hackLayout(t.data.formData),u){var _=u[v];!t.data.defaultSelectBizId&&h.defaultSelectBizId.includes(v)&&(t.data.defaultSelectBizId=v),"date"!==_.type||"today"!==_.defaultValue||_.value||c["b"].setVal(_,window.sysTime)}}if(n&&(a=e[1],t.data.detail=a,t.data.result.relative_doc.data=y["a"].getValueObjByDetail(a)),S){var j=t.data.formData.dataModel;Object.values(j).forEach((function(e){a&&(a[e.unEditHasDetail]&&e.unEditHasDetail&&(e.enabled=0),a.history_id&&"selectBiz"===e.type&&e.id===t.data.defaultSelectBizId&&(e.enabled=0))}))}})).then((function(){if(S)for(var e in t.data.formData.dataModel)c["b"].setRelations(t.data.formData.dataModel[e],t.data.formData);return t.data.detail?t.initDraft(t.data.detail):t.initNew(d)})).then((function(e){t.data.detail&&"view"===t.data.formData.formStyle&&Object(m["b"])(O(O(O({},t.data.detail),t.data.detail.contract_info||{}),t.data.detail.project_info||{}),t.data.formData.dataModel,!0);var i=[];return h.subForms.forEach((function(e){var t=e.id,n=e.layoutId;i.push(v["a"].getSubFormSetting({layoutId:n,bizType:a,changeType:r}).then((function(e){return{id:t,res:e||{isEnable:!1}}})))})),Promise.all(i).then((function(t){var a=t.reduce((function(e,t){var a=t.id,r=t.res;return e[a]=r,e}),{});return e.subFormsSetting=a,e}))})).catch((function(e){console.warn(e)}))},initNew:function(e){e&&this.fillFormData(e,this.data.formData.dataModel);var t=this.data.result;return t.formData=this.data.formData,t.defaultSelectBizId=this.data.defaultSelectBizId,t},isProjectMode:function(){return!!this.data.curBizConfig.isProjectMode},initAfterFillForm:function(){},initDraft:function(e){var t=this,a=this.data.formData;null===a&&(a={dataModel:{}}),this.fillFormData(e,a.dataModel);var r=this.data.bizType,i=this.data.changeType,n=[],o=[];e.contract_info?n=Array.isArray(e.contract_info)?e.contract_info:[e.contract_info]:e.contract_info_list&&(n=e.contract_info_list),e.jzc_contract_info&&n.push(e.jzc_contract_info),n.length&&(o=n.map((function(e){return e.contract_id})));var c=this.data.result;c.imagesList=e.images||[],c.attachment.list=e.attachments||[],c.subFormsValues={},this.data.curBizConfig.edit.subForms.forEach((function(t){var a=t.id;"sub_form_jzc_confirm"===a?c.subFormsValues.sub_form_jzc_confirm=e.sub_form_jzc_confirm||e.sub_form_jzc_clapply||[]:c.subFormsValues[a]=e[a]||[]})),c.ccList=e.cc_users||[];var l=null,d={biz_type:r,change_type:i};this.data.result.relativeFlow&&this.data.result.relativeFlow.role?l=this.data.result.relativeFlow.role.reduce((function(e,t){var r,i=a.dataModel[t];return"project_id"===t?(r=i.value||"",e[t]=r):(r=i.valueObj.map((function(e){return e.company_guid}))||[],e.company_guids=e.company_guids?e.company_guids.concat(r):r),e}),{}):this.isProjectMode()?d.project_id=e.project_id:d.contract=n;var u,f=this.refreshUsers(O({params:l},d));d={biz_type:r,change_type:i,detail:e},this.data.result.relativeFlow&&this.data.result.relativeFlow.station?l=this.data.result.relativeFlow.station.reduce((function(e,a){var r,i=t.data.formData.dataModel[a];return"project_id"===a?(r=i.value||"",e[a]=r):(r=i.valueObj.map((function(e){return e.company_guid}))||[],e.company_guids=e.company_guids?e.company_guids.concat(r):r),e}),{}):this.isProjectMode()?d.project_id=e.project_id:d.contract_id=o[0],u=this.isProjectMode()&&"tc_task_report"===this.data.curBizConfig.bizName?Promise.resolve():this.refreshSelectPeople(O({params:l},d),a.dataModel);var h={biz_type:r,change_type:i};this.isProjectMode()?h.project_id=e.project_id:h.contract_id=o[0];var p=this.getAttchmentSetting(h,a.dataModel,e);return s["a"].all([f,u,p]).then((function(r){return c.users=r[0],c.selectPeople=r[1],c.attachment.restrictSettings=r[2].setting,c.attachment.bakSetting=r[2].orgSetting,c.formData=a,c.contracts=n,c.defaultSelectBizId=t.data.defaultSelectBizId,c.detail=e,c.isProjectMode=t.isProjectMode(),c.project=e.project_info||null,c}))},fillFormData:function(e,t){var a=Object.values(t),r=[];a.forEach((function(t){var a=t.id;if("fq_date"!==a){var i=e[a];t=c["b"].setVal(t,i),t=Object(m["a"])(t,e),t.groupId&&r.push(t)}})),r.forEach((function(e){e.values=[t[e.groupId].value,e.value]}))},refreshUsers:function(e){var t=e.project_id,a=void 0===t?"":t,r=e.contract,i=void 0===r?null:r,n=e.biz_type,o=e.change_type,c=void 0===o?"":o,s=e.params,l=void 0===s?null:s;return l?f["b"].getUsersByProjectId(O(O({},l),{},{biz_type:n,change_type:c})):a?f["b"].getUsersByProjectId({project_id:a,biz_type:n,change_type:c}):f["b"].getUsersByContract(i)},refreshRecentlyUsers:function(e){var t=e.project_id,a=void 0===t?"":t,r=(e.contract,e.biz_type),i=e.change_type,n=void 0===i?"":i,o=e.params,c=void 0===o?null:o;if(c){var s=c.project_id||a;return f["b"].getRecentlyUsers({project_id:s,biz_type:r,change_type:n})}if(a)return f["b"].getRecentlyUsers({project_id:a,biz_type:r,change_type:n})},refreshSelectPeople:function(e,t){var a=this,r=e.contract_id,i=e.project_id,n=e.biz_type,o=e.change_type,c=e.detail,s=void 0===c?null:c,l=e.params;return f["b"].getSelectPeopleSetting({contract_id:r,project_id:i,biz_type:n,change_type:o,detail:s,params:l}).then((function(e){if(e.type===u["a"].Free)return e.selecteds=[],f["b"].FreeService.getSelecteds({contract_id:r,biz_type:n,change_type:o,detail:s}).then((function(t){return e.selecteds=t,e})).catch((function(e){e&&e.message&&console.error(e.message)}));e=a.refreshFixedFlow(e,t,s);var i=null;if(s){var c=f["b"].FixedService.getSelecteds({flows:e.flowInfo.flow,detail:s});c&&(i=Object.values(c).filter((function(e){return null!==e})).length?c:null)}return e.selecteds=i,e}))},getAttchmentSetting:function(e,t){var a,r=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return a=i&&i.history_id&&i.biz_attach_condition?i.biz_attach_condition.length?Promise.resolve(i.biz_attach_condition):Promise.resolve(h["a"].getAttchmentSettingByList(i.attachments||[])):h["a"].getAttchmentSetting(e,t),a.then((function(e){return r.refreshAttachmentSetting(e,t,i)}))},refreshAttachmentSetting:function(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;e=a&&a.history_id&&a.biz_attach_condition?e.map((function(e){return O(O({},e),{},{enable:!0})})):h["a"].setEnableByFormData(e,t);var r=h["a"].getAttachmentSettingByFlow(Object(b["a"])(e).filter((function(e){return e.enable})),[Object(g["a"])("station_name")],Object(g["a"])("station_name"));return{orgSetting:e,setting:r}},refreshFixedFlow:function(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return a&&a.history_id?e:f["b"].FixedService.transformFlowWithForm(e,t)}}},"2efc":function(e,t,a){var r=a("4572");"string"===typeof r&&(r=[[e.i,r,""]]),r.locals&&(e.exports=r.locals);var i=a("85cb").default;i("a6864530",r,!0,{sourceMap:!1,shadowMode:!1})},4572:function(e,t,a){t=e.exports=a("690e")(!1),t.push([e.i,".gcxt .components-wrapper[data-v-7faff4cc]{padding-bottom:20px}.gcxt .component-group[data-v-7faff4cc]{margin-bottom:10px}",""])},a262:function(e,t,a){"use strict";a.d(t,"b",(function(){return W}));var r=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("page",{directives:[{name:"phy-back",rawName:"v-phy-back",value:{status:"edit"===e.mode,method:"handleBackAction"},expression:"{status: mode === 'edit', method: 'handleBackAction'}"}],class:"biz-page-"+e.config.bizName},[a("template",{slot:"header"},[a("v-header",{attrs:{title:e.title,"back-action":e.handleBackAction}})],1),e.data?a("div",{staticClass:"components-wrapper"},[e._l(e.comps,(function(t){return["ViewTemplate"===t&&e.viewTemplateList?a("view-template",{key:t,attrs:{list:e.viewTemplateList}}):"FormComp"===t&&e.formData?["view"===e.formData.formStyle?a("form-detail",{key:t,attrs:{"sheet-id":e.sheetId,sheet:e.detail,"layout-arr":e.formData.layoutArr,"group-info":e.formData.groupInfo,"data-model":e.formData.dataModel,"unlock-info":e.detail.unlock_info}}):a("form-comp",{key:t,ref:"edit_form",refInFor:!0,attrs:{data:e.formData,sheet:e.detail,"default-select-biz-id":e.defaultSelectBizId,mode:e.mode},on:{change:e.onChange,"change-select-biz":e.onSelectBiz}},[e._l(e.$slots,(function(t,a){return[e.formData.dataModel[a]?e._t(a,null,{slot:a}):e._e()]}))],2)]:"RelativeFieldGroup"===t&&e.relative_doc.layouts.length?a("relative-field-group",{key:t,ref:"RelativeFieldGroup",refInFor:!0,attrs:{layouts:e.relative_doc.layouts,data:e.relative_doc.data,"before-edit":e.reqNextStep,"sheet-id":e.detail&&e.detail.history_id?e.sheetId:""},on:{change:e.onRelativeFieldChange}}):"SubForms"===t?a("div",{key:t},[e._l(e.config.edit.subForms,(function(t){return[e.subFormsSetting[t.id]&&e.subFormsSetting[t.id].isEnable?a("sub-form",e._b({key:t.id,ref:t.id,refInFor:!0,attrs:{id:t.id,mode:"edit",data:e.subFormsValues[t.id]||[],"before-edit":e.reqNextStep,addable:"sub_form_jzc_confirm"!==t.id,deletable:"sub_form_jzc_confirm"!==t.id},on:{change:function(a){return e.onSubFormChange(t.id,a)}}},"sub-form",e.subFormsSetting[t.id],!1)):e._e()]}))],2):"UploadImages"===t?a("upload-images",{key:t,ref:"uploadImages",refInFor:!0,model:{value:e.imagesList,callback:function(t){e.imagesList=t},expression:"imagesList"}},[e.needUploadAttachment?a("span",{staticStyle:{color:"#f00"}},[e._v("\n          *有必须上传的其他类型的附件,请先保存为草稿再去电脑端上传。\n        ")]):e._e()]):"Attachment"===t?a("attachment",{key:t,ref:"attachments",refInFor:!0,attrs:{edit:!0,list:e.attachment.list,"restrict-settings":e.attachment.restrictSettings,"before-edit":e.reqNextStep}}):"SelectPeople"===t?a("select-people",{key:t,ref:"selectPeople",refInFor:!0,staticClass:"component-group",attrs:{type:e.selectPeople.type,users:e.users,selecteds:e.selectPeople.selecteds,"flow-info":e.selectPeople.flowInfo||null,"before-edit":e.reqNextStep,size:e.bizType===e.BizKeys.ANSWER_QUESTION?1:1/0}}):"UserSelector"===t?a("user-selector",{key:t,ref:"onlySelectPeople",refInFor:!0,attrs:{list:e.users,"selector-title":"选择抄送对象",label:"抄送",multi:!0,"show-search-btn":!0,"exclude-my-self":!0,"before-edit":e.reqNextStep,tip:e.bizType===e.BizKeys.TC_PROJECT_DAILY||e.bizType===e.BizKeys.TC_TASK_REPORT||e.bizType===e.BizKeys.TC_MEETING?"":"注：抄送对象不参与审批，但会收到该条流程的通知"},model:{value:e.ccList,callback:function(t){e.ccList=t},expression:"ccList"}}):a("div",{key:t},[e._t(t,null,{editData:e.$data,bindRef:function(a){return e.bindSlotRef(t,a)}})],2)]}))],2):e._e(),a("template",{slot:"footer"},[e._t("footer",[e.data&&!e.keyboardInfo.show?a("save-buttons",{ref:"SaveButtons",attrs:{"sheet-title":e.title,"biz-type":e.bizType,"change-type":e.changeType,"default-select-biz-id":e.defaultSelectBizId,detail:e.detail,"form-data":e.formData,"get-sheet-refs":e.getFormatRefs,"sheet-data":e.$data}}):e._e()])],2)],2)},i=[],n=(a("5ab2"),a("e10e"),a("9a33"),a("e3ee")),o=(a("f548"),a("6d57"),a("4c09")),c=(a("e697"),a("28f8")),s=(a("163d"),a("9a340")),l=a("d759"),d=a("fd50"),u=a("a740"),f=a("a075"),h=a("db68"),p=a("225c"),m=a("a783"),g=a("7bce"),b=a("5fe8"),v=a("933f"),y=a("9249"),_=a("3ec3"),j=a("1f8c"),S=a("69b8"),O=a("6892"),F=a("07fc"),D=a("7b41"),z=a("0909"),w=a("2655"),P=a("6280"),T=a("6413"),k=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("app-button-group",[a("app-button",{directives:[{name:"show",rawName:"v-show",value:!e.curbizConfig.edit.disableDraft,expression:"!curbizConfig.edit.disableDraft"}],staticClass:"action-button -draft",attrs:{plain:""},on:{click:function(){return e.save(!1)}}},[e._v("保存草稿")]),a("app-button",{staticClass:"action-button -sync",on:{click:function(){return e.save(!0)}}},[e._v("提交")])],1)},M=[],C=a("b23b"),B=(a("ed63"),a("8cf2"),a("3e83")),I=a("e200"),R=a("5bbb"),A=a("af76");function E(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function x(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?E(Object(a),!0).forEach((function(t){Object(c["a"])(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):E(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}var L=function(e,t){if(e&&e[t]){for(var a=e[t],r=arguments.length,i=new Array(r>2?r-2:0),n=2;n<r;n++)i[n-2]=arguments[n];return a.bind.apply(a,[e].concat(i))}return function(){return{flag:!0,msg:""}}},U={name:"SaveButtons",props:{sheetTitle:{type:String},bizType:{type:Number},changeType:{type:String},formData:{type:Object,require:!0},defaultSelectBizId:{type:String,require:!0},detail:{type:Object,default:null},getSheetRefs:{type:Function,require:!0},sheetData:{type:Object,default:function(){}}},data:function(){return{saving:!1,show:!1}},computed:{mode:function(){return this.detail?"edit":"add"},curbizConfig:function(){return _["a"][this.bizType]},service:function(){return Object(I["b"])(this.bizType)}},methods:{save:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return t?v["a"].idkey(v["a"].idkeys.editClickSubmit):v["a"].idkey(v["a"].idkeys.editClickSaveDraft),this.saveObj(t).then((function(){e.saving=!1,e.$router.go(-1)})).catch((function(t){"string"===typeof t&&t.length?e.sui.toast(t):"string"===typeof t.message&&t.message.length&&e.sui.toast(t.message),e.saving=!1}))},saveObj:function(e){var t=this,a={biz_type:this.bizType,change_type:this.changeType,contract_info:{},formData:{},approver_ids:[],attachments:[],photos:[]};this.curbizConfig.edit.subForms.forEach((function(e){var t=e.id;a[t]=[]}));var r=this.defaultSelectBizId,i="",n="";if(r&&(i=this.formData.dataModel[r],n=i.value,!n))return d["a"].reject("请先选择".concat(i.label));if(e){var o=g["b"].validate(this.formData.dataModel,e?{req:1,format:1}:{req:0,reqOnSave:1}),c=o.result,s=o.msg,u=o.id,f=void 0===u?"":u;if(!c)return f&&this.locateErrorField(f),d["a"].reject(s)}var h=g["b"].getFormValuesForSave(this.formData.dataModel),p=function(e){var a=t.formData.dataModel[e];if(a.add){var r,i=a.valueObj.some((function(e,t){if(!e||!e.__validated)return r="请补充第".concat(t+1,"个").concat(a.label,"信息"),!0}));if(i)return{v:d["a"].reject(r)}}};for(var m in this.formData.dataModel){var v=p(m);if("object"===Object(B["a"])(v))return v.v}if(h.project_id&&Array.isArray(h.project_id)&&!h.project_id.length){var y=this.formData.dataModel.project_id.label;return d["a"].reject("请先选择".concat(y))}if(h.project_id&&Array.isArray(h.project_id)&&h.project_id.length>500)return d["a"].reject("您选择的项目数量超过500，无法".concat(e?"提交":"保存","。"));a.formData=h;var _=d["a"].resolve();return r&&!this.curbizConfig.isProjectMode&&("contract_id"!==r&&(_=Object(I["b"])(i.bizType).getDetail(n).then((function(e){return e.unlock_info&&e.unlock_info.is_sheet_timeout?(Object(A["a"])().openPopup({day:e.worksheet_completion_deadline}),d["a"].reject()):e.contract_id}))),_=_.then((function(e){return e=e||n,l["a"].getContract(e).then((function(e){if(![b["a"].PAYMENT,b["a"].OUTPUT_VALUE].includes(t.bizType)&&["已结算","结算"].includes(e.xt_js_state)){var r="合同已结算, 不能再发起"+t.sheetTitle;return d["a"].reject(r)}a.contract_info=e}))}))),_.then((function(){return t.doSave(a,e)}))},doSave:function(e,t){var a=this,r=this.getSheetRefs(),i=r.MeetingSelector,n=r.ReceiveSelector,o=r.attachments,c=r.uploadImages,s=r.selectPeople,u=this;function f(){if(o&&o.hasUploading())return{flag:!1,msg:"请等待附件上传完毕"};if(c&&c.hasUploading())return{flag:!1,msg:"请等待图片上传完毕"};if(e.receive_user_ids&&!e.receive_user_ids.length&&!e.receive_work_group_ids&&!e.receive_work_group_ids.length)return{flag:!1,msg:"责任人为必选项"};var a=[];if(t){if(s&&s.type===z["a"].Free&&0===e.approver_ids.length)return{flag:!1,msg:"请选择确认人"};u.curbizConfig.edit.subForms.forEach((function(e){var t=e.id;a.push(L(r[t],"validateRequirement"))})),a.push(L(c,"validateRequirement")),a.push(L(o,"validateRequirement",u.curbizConfig.edit.disableDraft||!1)),a.push(L(n,"validateRequirement")),a.push(L(i,"validateRequirement")),s&&("add"===u.mode||"edit"===u.mode&&u.detail&&!u.detail.history_id)&&a.push(L(s,"validateSelectPeople")),!e.contract_info||u.detail&&u.detail.history_id||a.push(l["a"].checkContractHasExpire.bind(null,e.contract_info,"add"))}for(var d in a){var f=a[d]();if(f&&!1===f.flag)return f}return{flag:!0,msg:""}}this.prepareData(e);var h=f(),p=h.flag,m=h.msg;return p?(this.saving=!0,this.exec(t,e).then((function(e){var r=e.data,i=e.param;console.log("提交返回数据:",{data:r,param:i});var n="已为你保存成草稿";return t&&(n="提交成功"),a.sui.toast(n)}))):d["a"].reject(m)},prepareData:function(e){"edit"===this.mode&&this.writeBack(e.formData,this.detail);var t=this.getSheetRefs();if(t.RelativeFieldGroup){var a=t.RelativeFieldGroup.getData();for(var r in a)e[r]=a[r]}if(t.attachments&&(e.attachments=Object(R["a"])(t.attachments.getData()),e.attach_condition=this.sheetData.attachment.bakSetting.filter((function(e){return e.enable})).map((function(e){e.attach_condition,e.enable;var t=Object(C["a"])(e,["attach_condition","enable"]);return x({},t)}))),t.uploadImages&&(e.photos=Object(R["a"])(t.uploadImages.data)),this.curbizConfig.edit.subForms.forEach((function(a){var r=a.id;t[r]&&(e[r]=Object(R["a"])(t[r].getData()))})),t.selectPeople&&(t.selectPeople.type===z["a"].Free?(delete e.formData.flow_type,delete e.flow,e.approver_ids=t.selectPeople.getFreeData()):e.flow=t.selectPeople.getFixedData()),t.onlySelectPeople&&(e.cc_user_ids=t.onlySelectPeople.selecteds.map((function(e){return e.user_id}))),t.ReceiveSelector){var i=t.ReceiveSelector.selecteds;e.receive_user_ids=i.filter((function(e){return e.user_id})).map((function(e){return e.user_id})),e.receive_work_group_ids=i.filter((function(e){return e.group_id})).map((function(e){return e.group_id}))}t.ConfirmSelector&&(console.log("sheetRefs.ConfirmSelector.selecteds",t.ConfirmSelector.selecteds),e.confirm_user_ids=t.ConfirmSelector.selecteds.filter((function(e){return e.user_id})).map((function(e){return e.user_id}))),t.MeetingSelector&&(e.invitee_user_ids=t.MeetingSelector.selecteds.map((function(e){return e.user_id})))},writeBack:function(e,t){var a=e;if(t){for(var r in t)a.hasOwnProperty(r)||"object"===Object(B["a"])(t[r])||0===r.indexOf("erp")||(a[r]=t[r]);return a}},exec:function(e,t){var a=this.service.buildSaveData(t);return a.issync=1,e&&(a.check_status="1"),this.service.saveDetail(a)},locateErrorField:function(e){var t=this.getSheetRefs().edit_form;if(t){var a=t.$refs.fieldWrapper.find((function(t){return t.id===e}));a&&(a.$el.scrollIntoView(),this.formData.dataModel[e].invalid=!0)}}}},$=U,N=a("c701"),q=Object(N["a"])($,k,M,!1,null,null,null),V=q.exports,G=a("2bf9"),H=a("0fc6");function K(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function J(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?K(Object(a),!0).forEach((function(t){Object(c["a"])(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):K(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}var W=function(){return{erpOptions:null,defaultSelectBizId:"",detail:null,relativeFlow:null,relationLayout:null,formData:null,imagesList:[],attachment:{list:[],restrictSettings:[],bakSetting:[]},users:[],recentlyUsers:{cc_users:[],receive_users:[],confirm_users:[],invitee_users:[]},selectPeople:{type:z["a"].Free},ccList:[],relative_doc:{layouts:[],data:{}}}},Y={name:"BusinessEdit",components:{FormComp:w["a"],FormDetail:G["a"],RelativeFieldGroup:j["a"],UploadImages:D["a"],SelectPeople:z["b"],Attachment:O["a"],UserSelector:P["a"],SubForm:S["a"],ApproveGroup:T["a"],viewTemplate:F["a"],SaveButtons:V},props:{comps:{type:Array,default:function(){return["ViewTemplate","FormComp","RelativeFieldGroup","SubForms","UploadImages","Attachment","SelectPeople","UserSelector"]}},data:{type:Object,default:null},mode:{type:String},config:{type:Object,default:function(){}},bizType:{type:Number},changeType:{type:String,default:""},pageTitle:{type:String,default:""}},data:function(){var e=this.config.edit.subForms.reduce((function(e,t){return e[t.id]={isEnable:!1},e}),{}),t=this.config.edit.subForms.reduce((function(e,t){return e[t.id]=[],e}),{});return m["a"].reset(),m["a"].bizType=this.bizType,m["a"].changeType=this.changeType,J(J({},W()),{},{viewTemplateList:null,subFormsSetting:e,subFormsValues:t,relativeDetail:null,store:m["a"],BizKeys:b["a"],extraRef:{}})},computed:{title:function(){return this.pageTitle||("add"===this.mode?"新增":"修改")+this.config.detail.getTitle(this.bizType,this.changeType)},contractIds:function(){return this.store.contracts.map((function(e){return e.contract_id}))},isProjectMode:function(){return!!this.config.isProjectMode},needUploadAttachment:function(){return!!(this.data.attachment&&this.data.attachment.restrictSettings&&this.data.attachment.restrictSettings.length)&&this.data.attachment.restrictSettings.some((function(e){return 1===e.is_must&&(!e.file_path||""===e.file_path)}))},sheetId:function(){return this.$route.query.id||""},curConfig:function(){return _["a"][this.bizType]},keyboardInfo:function(){return this.$store.state.device.keyboardInfo}},provide:function(){var e=this;return{importRef:function(t,a){e.extraRef[t]=a},getFormData:function(){return e.formData}}},watch:{data:{handler:function(e){for(var t in e)t in this.$data&&(this[t]=e[t]),t in this.store&&(this.store[t]=e[t])},immediate:!0},contractIds:{handler:function(e){var t=this;e&&e.length&&l["a"].getContractTemplates({biz_type:this.bizType,change_type:this.changeType,contract_ids:e}).then((function(e){t.viewTemplateList=e}))},immediate:!0},erpOptions:function(e){for(var t in this.subFormsSetting)this.subFormsSetting[t].defaultForm&&s["a"].formatDefaultFormByErpOptions(this.subFormsSetting[t].defaultForm,e);if(this.formData&&this.formData.dataModel)for(var a in this.formData.dataModel){var r=this.formData.dataModel[a],i=r.defaultForm;i&&g["b"].fillErpOptions(e,r.defaultForm.dataModel)}},users:function(e){this.ccList=this.ccList.filter((function(t){return e.find((function(e){return t.user_id===e.user_id}))}))}},mounted:function(){window.businessEdit=this,this.init()},beforeDestroy:function(){y["a"].clear()},methods:{init:function(){var e=this,t=~this.comps.indexOf("SelectPeople"),a=function(t){var a={biz_type:e.bizType,change_type:e.changeType};if(e.isProjectMode){a.project_id=Object(H["a"])(t);var r=Array.isArray(a.project_id)&&a.project_id.length>1||Array.isArray(a.project_id)&&!a.project_id.length;if(e.curConfig.isTCMode&&r)return e.attachment.bakSetting=[],e.attachment.restrictSettings=[],e.$emit("refresh-attachment-setting",[]);if(!a.project_id)return e.attachment.bakSetting=[],e.attachment.restrictSettings=[],e.$emit("refresh-attachment-setting",[])}else a.contract_id=t[0].contract_id;p["a"].getAttchmentSetting(a,e.formData.dataModel,e.detail).then((function(t){var a=t.orgSetting,r=t.setting;e.attachment.bakSetting=a,e.attachment.restrictSettings=r,e.$emit("refresh-attachment-setting",r)}))};this.$watch(this.isProjectMode?"store.project":"store.contracts",(function(e,t){a(e)}));var r=function(a){if(!e.relativeFlow||!e.relativeFlow.role){var r={biz_type:e.bizType,change_type:e.changeType};e.isProjectMode?r.project_id=Object(H["a"])(a):r.contract=a,p["a"].refreshUsers(r).then((function(t){e.users=t})),e.curConfig.isTCMode&&p["a"].refreshRecentlyUsers(r).then((function(t){e.recentlyUsers=t}))}if((!e.relativeFlow||!e.relativeFlow.station)&&t){var i={biz_type:e.bizType,change_type:e.changeType,detail:e.detail};e.isProjectMode?i.project_id=Object(H["a"])(a):i.contract_id=a[0].contract_id,p["a"].refreshSelectPeople(i,e.formData.dataModel).then((function(t){e.selectPeople=t}))}};this.$watch(this.isProjectMode?"store.project":"store.contracts",r)},handlerRelativeFlow:function(e){var t=this,a=~this.comps.indexOf("SelectPeople"),r={};if(this.relativeFlow){var i={biz_type:this.bizType,change_type:this.changeType},n=this.relativeFlow,o=n.role,c=n.station;if(o&&o.some((function(t){return t===e.id}))){var s=o.reduce((function(e,a){var r,i=t.data.formData.dataModel[a];return"project_id"===a?(r=Array.isArray(i)?i.map((function(e){return e.value})):i.value||"",e[a]=r):(r=i.valueObj.map((function(e){return e.company_guid}))||[],e.company_guids=e.company_guids?e.company_guids.concat(r):r),e}),{});p["a"].refreshUsers(J({params:s},i)).then((function(e){t.users=e})),this.curConfig.isTCMode&&p["a"].refreshRecentlyUsers(J({params:s},i)).then((function(e){t.recentlyUsers=e}))}if(c&&c.some((function(t){return t===e.id}))&&a){var l=c.reduce((function(e,a){var r,i=t.data.formData.dataModel[a];return"project_id"===a?(r=Array.isArray(i)?i.map((function(e){return e.value})):i.value||"",e[a]=r):(r=i.valueObj.map((function(e){return e.company_guid}))||[],e.company_guids=e.company_guids?e.company_guids.concat(r):r),e}),{});p["a"].refreshSelectPeople(J({params:l},i),this.formData.dataModel).then((function(e){t.selectPeople=e})),r.handleringBranchFlow=!0}}return r},onChange:function(e,t,a){var r=this,i=!!~this.comps.indexOf("Attachment"),n=!!~this.comps.indexOf("SelectPeople"),o=this.handlerRelativeFlow(t),c=o.handleringBranchFlow,s=void 0!==c&&c;if(n&&!s&&t&&t.id&&this.selectPeople.type===z["a"].Fixed&&this.selectPeople.branches&&this.selectPeople.branches.deps.some((function(e){return e===t.id}))&&(this.selectPeople=p["a"].refreshFixedFlow(this.selectPeople,this.formData.dataModel,this.detail)),i&&t&&t.id!==this.defaultSelectBizId){var l=p["a"].refreshAttachmentSetting(this.attachment.bakSetting,this.formData.dataModel,this.detail),u=l.orgSetting,f=l.setting;this.attachment.bakSetting=u,this.attachment.restrictSettings=f}return d["a"].resolve().then((function(){r.$emit("form-change",e,t,a)}))},onRelativeFieldChange:function(e,t){this.relationLayout&&this.handlerCompRelations({ref:e,data:t})},onSubFormChange:function(e,t){this.relationLayout&&this.handlerCompRelations({ref:e,data:t})},reqNextStep:function(){var e=this.formData.dataModel[this.defaultSelectBizId],t=function(e){return"选择"===e.substr(0,2)?e.substr(2):e},a=!0;return e&&"project_id"===e.id&&Array.isArray(e.value)&&(a=!!e.value.length),!(e&&!e.value||!a)||(this.sui.toast("请先选择".concat(t(e.label)||"相关业务单据")),!1)},bindSlotRef:function(e,t){return this.$refs[e]=t,t},getFormatRefs:function(){var e={};for(var t in this.$refs){var a=this.$refs[t],r=Array.isArray(a)?a[0]:a;e[t]=r}return J(J({},e),this.extraRef)},onSelectBiz:function(e,t){var a=this,r=t.detail,i=t.erpOptions,n=t.contracts,o=t.project,c=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this.handlerRelativeFlow(e),this.selectBizHelper(e,{detail:r,erpOptions:i,contracts:n,project:o},c).then((function(){a.$emit("select-biz-change",e,{detail:r,erpOptions:i,contracts:n,project:o},c)}))},selectBizHelper:function(e,t,a){var r=this,i=t.detail,n=t.erpOptions,c=t.contracts,s=t.project;if(this.$route.query.params&&"add"===this.mode&&(a=!1),a)return i&&(this.relativeDetail=i),n&&(this.erpOptions=n),d["a"].resolve();var l=e.id;if(s&&(this.store.project=s),c&&(this.store.contracts=c,h["b"].store.setValue({cur_contract:c[0]})),n&&(this.erpOptions=n),i){"meeting_id"===l?this.imagesList=i.images||[]:(this.relativeDetail=i,i.images&&i.images.length&&(this.imagesList=i.images),i.sub_form_jzc_clapply&&this.bizType===b["a"].JZC_CONFIRM&&(i.sub_form_jzc_confirm=Object(o["a"])(i.sub_form_jzc_clapply)),this.config.edit.subForms.forEach((function(e){var t=e.id;i[t]&&i[t].length&&(r.subFormsValues[t]=Object(o["a"])(i[t]))})));var p=f["a"].number.round(i.reviewed_cost||""),m=this.formData.dataModel.declaration_cost;m&&"1"!==Object(u["b"])().disable_declaration_cost&&(m.placeholder=p>=0?"变更审核金额"+p:"必填")}return n&&(this.erpOptions=n),d["a"].resolve()},handleBackAction:function(){var e=this;if(this.curConfig.edit.disableDraft)return v["a"].idkey(v["a"].idkeys.editClickNoSaveDraftByBack),this.$router.go(-1);var t=this.defaultSelectBizId,a="";this.formData&&this.formData.dataModel&&this.formData.dataModel[t]&&(a=this.formData.dataModel[t].value),"edit"===this.mode||a?this.sui.confirm({message:"是否保存为草稿？",confirmButtonText:"保存",cancelButtonText:"不保存"}).then((function(){return v["a"].idkey(v["a"].idkeys.editClickSaveDraftByBack),e.saveDraft()})).catch((function(){v["a"].idkey(v["a"].idkeys.editClickNoSaveDraftByBack),e.$router.go(-1)})):this.$router.go(-1)},saveDraft:function(){return this.$refs.SaveButtons.save(!1)},handlerCompRelations:function(e){var t=this,a=e.ref,r=void 0===a?"":a,i=e.data,o=void 0===i?null:i,c=e.zeroToEmpty,s=void 0!==c&&c,l={material_form:{ref:"material_item_list",valueObj:null}},d=function(e){if(l[e]||(l[e]={ref:e,valueObj:null}),l[e].valueObj)return l[e].valueObj;var a=null,i=l[e].ref,n=t.getFormatRefs();if(i===r)a=o;else switch(e){case"edit_form":a=g["b"].getFormValues(t.formData.dataModel);break;default:a=n[i].getData();break}return l[e].valueObj=a,a};this.relationLayout.forEach((function(e){var a=e.target_comp,i=e.target_id,o=e.calc_method,c=!1,u=!0,f=o.replace(/\[{(.+?)}\]|{{(.+?)}}/g,(function(e,t,a){var i="["===e.slice(0,1),o=i?t:a,s=o.split("."),f=Object(n["a"])(s,2),h=f[0],p=f[1],m=d(h);return""!==r&&r!==l[h].ref||(c=!0),null===m?(console.error("不合法表达式"),void(u=!1)):i?m.reduce((function(e,t){return e+=Number(t[p]),e}),0):m[p]}));if(c&&u){var h=null;try{var p=Function;h=+parseFloat(new p("return "+f)()).toPrecision(12)}catch(b){return void console.error(b)}switch(s&&0===h&&(h=""),a){case"edit_form":var m=t.formData.dataModel[i];m&&(g["b"].formatFieldForEdit(m,h),t.onChange(m.value,m));break}}}))}}},Q=Y,Z=(a("0337"),Object(N["a"])(Q,r,i,!1,null,"7faff4cc",null));t["a"]=Z.exports}}]);